<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arabic by Rolla</title>
    <meta name="description" content="Engaging Arabic language quizzes">
    
    <!-- LZ-String for URL compression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #ec4899;
            --accent: #06b6d4;
            --accent2: #f59e0b;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            
            --bg-primary: #0a0a0f;
            --bg-secondary: #111118;
            --bg-card: rgba(17, 17, 24, 0.8);
            --bg-card-hover: rgba(30, 30, 45, 0.9);
            --bg-elevated: rgba(25, 25, 35, 0.95);
            
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            --gradient-secondary: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            --gradient-accent: linear-gradient(135deg, #06b6d4 0%, #22d3ee 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 40px rgba(99, 102, 241, 0.15);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
        }
        
        /* Light Theme */
        body.light-theme {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-card: rgba(255, 255, 255, 0.9);
            --bg-card-hover: rgba(248, 250, 252, 1);
            --bg-elevated: rgba(255, 255, 255, 0.98);
            
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            
            --border: rgba(0, 0, 0, 0.08);
            --border-hover: rgba(0, 0, 0, 0.12);
            
            --glass: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.06);
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.16);
            --shadow-glow: 0 0 40px rgba(99, 102, 241, 0.1);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.4s ease, color 0.4s ease;
            line-height: 1.6;
        }
        
        /* Ambient Background */
        .ambient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }
        
        .ambient-bg::before {
            content: '';
            position: absolute;
            width: 150%;
            height: 150%;
            top: -25%;
            left: -25%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(6, 182, 212, 0.08) 0%, transparent 40%);
            animation: ambientMove 30s ease-in-out infinite;
        }
        
        body.light-theme .ambient-bg::before {
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(236, 72, 153, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(6, 182, 212, 0.06) 0%, transparent 40%);
        }
        
        @keyframes ambientMove {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(2%, 2%) scale(1.02); }
            66% { transform: translate(-2%, 1%) scale(0.98); }
        }
        
        /* Noise Texture Overlay */
        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.03;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        }
        
        /* Header */
        .header {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.875rem;
        }
        
        .logo-icon {
            width: 44px;
            height: 44px;
            background: var(--gradient-primary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: var(--shadow-md), 0 0 20px rgba(99, 102, 241, 0.3);
        }
        
        .logo h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }
        
        .header-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-sm), 0 0 20px rgba(99, 102, 241, 0.25);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md), 0 0 30px rgba(99, 102, 241, 0.35);
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.25);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.35);
        }
        
        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.25);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.35);
        }
        
        .btn-gradient {
            background: var(--gradient-primary);
            color: white;
            font-size: 1rem;
            padding: 1rem 2rem;
            box-shadow: var(--shadow-md), 0 0 30px rgba(99, 102, 241, 0.3);
        }
        
        .btn-gradient:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--shadow-lg), 0 0 40px rgba(99, 102, 241, 0.4);
        }
        
        .btn-icon {
            width: 42px;
            height: 42px;
            padding: 0;
            border-radius: var(--radius-md);
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 1.25rem;
        }
        
        .btn-icon:hover {
            background: var(--bg-card-hover);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Section Headers */
        .section-header {
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .section-subtitle {
            color: var(--text-secondary);
            font-size: 1.125rem;
        }
        
        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        /* Quiz Cards */
        .quiz-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: 1.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .quiz-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .quiz-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }
        
        .quiz-card:hover::before {
            opacity: 1;
        }
        
        .quiz-card-icon {
            width: 64px;
            height: 64px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin-bottom: 1.25rem;
            position: relative;
        }
        
        .quiz-card-icon.fill-blank { background: var(--gradient-primary); }
        .quiz-card-icon.related-words { background: var(--gradient-secondary); }
        .quiz-card-icon.match-words { background: var(--gradient-accent); }
        .quiz-card-icon.true-false { background: var(--gradient-success); }
        
        .quiz-card h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.01em;
        }
        
        .quiz-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .quiz-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-ready {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .badge-empty {
            background: var(--bg-card-hover);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }
        
        /* Create Exam Card */
        .create-exam-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 2px dashed var(--primary);
            border-radius: var(--radius-xl);
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            grid-column: 1 / -1;
            margin-bottom: 1rem;
        }
        
        .create-exam-card:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            transform: scale(1.01);
            border-style: solid;
            box-shadow: var(--shadow-glow);
        }
        
        .create-exam-card .icon {
            width: 72px;
            height: 72px;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 1.25rem;
            box-shadow: var(--shadow-md), 0 0 30px rgba(99, 102, 241, 0.3);
        }
        
        .create-exam-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .create-exam-card p {
            color: var(--text-secondary);
        }
        
        /* Settings Card */
        .settings-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .settings-card h3 {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            margin-bottom: 1rem;
            font-size: 1.125rem;
        }
        
        .settings-card h3 span {
            font-size: 1.25rem;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            transition: all 0.2s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-hint {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1.5rem;
        }
        
        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-lg);
        }
        
        .modal.wide {
            max-width: 1100px;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-elevated);
            z-index: 10;
        }
        
        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }
        
        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: var(--error);
            border-color: var(--error);
            color: white;
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        /* Question Builder */
        .question-builder {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            transition: border-color 0.2s ease;
        }
        
        .question-builder:hover {
            border-color: var(--border-hover);
        }
        
        .question-number {
            position: absolute;
            top: -10px;
            left: 1rem;
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.8125rem;
            font-weight: 600;
        }
        
        .remove-question {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            background: transparent;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 1.125rem;
            opacity: 0.5;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-question:hover {
            opacity: 1;
            background: rgba(239, 68, 68, 0.15);
        }
        
        .options-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .option-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .option-input-group input[type="text"] {
            flex: 1;
        }
        
        .option-input-group input[type="radio"],
        .option-input-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--success);
        }
        
        /* Category Builder */
        .category-builder {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .category-builder-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .category-label {
            background: var(--gradient-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.8125rem;
            font-weight: 600;
            color: white;
        }
        
        /* Tags Input */
        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            min-height: 50px;
            align-items: center;
        }
        
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            background: var(--primary);
            color: white;
            border-radius: var(--radius-full);
            font-size: 0.8125rem;
            font-weight: 500;
        }
        
        .tag.decoy-tag {
            background: var(--warning);
            color: #1e293b;
        }
        
        .tag button {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 0;
            font-size: 1rem;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .tag button:hover {
            opacity: 1;
        }
        
        .tags-input input {
            border: none;
            background: transparent;
            color: var(--text-primary);
            outline: none;
            font-size: 0.9rem;
            flex: 1;
            min-width: 120px;
        }
        
        /* Image Upload */
        .image-upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }
        
        .image-upload-zone:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }
        
        .image-upload-zone input {
            display: none;
        }
        
        .image-upload-zone img {
            max-width: 150px;
            border-radius: var(--radius-md);
        }
        
        /* Exam Type Selector */
        .exam-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .exam-type-option {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .exam-type-option:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }
        
        .exam-type-option.selected {
            border-color: var(--accent);
            background: rgba(6, 182, 212, 0.1);
        }
        
        .exam-type-option input {
            display: none;
        }
        
        .exam-type-option .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .exam-type-option .name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        /* Link Display */
        .link-display {
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            margin: 1.5rem 0;
        }
        
        .link-display input {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--accent);
            font-size: 0.9rem;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        
        .link-display input:focus {
            outline: none;
        }
        
        /* Student View */
        .student-header {
            background: var(--gradient-primary);
            padding: 2.5rem;
            border-radius: var(--radius-xl);
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--shadow-lg), 0 0 40px rgba(99, 102, 241, 0.25);
        }
        
        .student-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: white;
        }
        
        .student-header p {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .student-name-input {
            max-width: 400px;
            margin: 2rem auto;
            text-align: center;
        }
        
        .student-name-input input {
            width: 100%;
            padding: 1.25rem;
            font-size: 1.125rem;
            text-align: center;
            background: var(--bg-card);
            border: 2px solid var(--primary);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }
        
        .student-name-input input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.15);
        }
        
        /* Progress Bar */
        .progress-bar {
            background: var(--bg-card);
            border-radius: var(--radius-full);
            height: 8px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            transition: width 0.4s ease;
        }
        
        /* Quiz Play View */
        .quiz-question-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: 1.75rem;
            margin-bottom: 1.25rem;
            transition: all 0.3s ease;
        }
        
        .quiz-question-card.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.08);
        }
        
        .quiz-question-card.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.08);
        }
        
        .quiz-question-card.answered {
            border-color: var(--accent);
            background: rgba(6, 182, 212, 0.08);
        }
        
        .question-text {
            font-size: 1.125rem;
            margin-bottom: 1.25rem;
            line-height: 1.7;
        }
        
        .blank-space {
            display: inline-block;
            min-width: 100px;
            padding: 0.25rem 0.625rem;
            background: var(--primary);
            color: white;
            border-radius: var(--radius-sm);
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .blank-space:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }
        
        .blank-space.filled {
            background: var(--accent);
        }
        
        .blank-space.correct-answer {
            background: var(--success);
        }
        
        .blank-space.wrong-answer {
            background: var(--error);
        }
        
        .options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.625rem;
            margin-top: 1rem;
        }
        
        .option-btn {
            padding: 0.75rem 1.25rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .option-btn:hover:not(:disabled) {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }
        
        .option-btn.selected {
            border-color: var(--accent);
            background: rgba(6, 182, 212, 0.15);
        }
        
        .option-btn.matched {
            cursor: pointer;
        }
        
        .option-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* True/False Buttons */
        .tf-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .tf-btn {
            flex: 1;
            padding: 1.25rem;
            border: 2px solid;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 1.125rem;
            font-weight: 700;
            transition: all 0.2s ease;
            background: transparent;
        }
        
        .tf-btn.true {
            border-color: var(--success);
            color: var(--success);
        }
        
        .tf-btn.true:hover:not(:disabled) {
            background: var(--success);
            color: white;
            transform: scale(1.02);
        }
        
        .tf-btn.false {
            border-color: var(--error);
            color: var(--error);
        }
        
        .tf-btn.false:hover:not(:disabled) {
            background: var(--error);
            color: white;
            transform: scale(1.02);
        }
        
        .tf-btn.selected.true {
            background: var(--success);
            color: white;
        }
        
        .tf-btn.selected.false {
            background: var(--error);
            color: white;
        }
        
        /* Match/Drag Quiz */
        .match-container {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .match-column {
            flex: 1;
            min-width: 220px;
        }
        
        .match-column h4 {
            margin-bottom: 1rem;
            color: var(--text-muted);
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }
        
        .image-drop-zone {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: var(--radius-xl);
            padding: 1.25rem;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }
        
        .image-drop-zone:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }
        
        .image-drop-zone.selectable {
            cursor: pointer;
            border-color: var(--accent);
            animation: pulseBorder 1.5s infinite;
        }
        
        @keyframes pulseBorder {
            0%, 100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(6, 182, 212, 0); }
        }
        
        .image-drop-zone img {
            max-width: 100%;
            max-height: 120px;
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
        }
        
        .image-drop-zone h5 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .dropped-words {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            min-height: 36px;
            justify-content: center;
        }
        
        .word-chip {
            padding: 0.5rem 1rem;
            background: var(--gradient-primary);
            color: white;
            border-radius: var(--radius-full);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .word-chip:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
        }
        
        .word-chip.selected {
            background: var(--gradient-accent);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
            transform: scale(1.08);
        }
        
        .word-chip.correct {
            background: var(--gradient-success);
        }
        
        .word-chip.incorrect {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        /* Decoy words look identical to regular words - no visual difference! */
        .word-chip.decoy {
            /* Same as regular word-chip - no special styling */
        }
        
        .word-chip.placed-word {
            position: relative;
        }
        
        .word-chip.placed-word::after {
            content: '√ó';
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: var(--error);
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
.word-chip.placed-word:hover::after {
            opacity: 1;
        }
        
        .word-chip.placed {
            display: none;
        }
        
        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 0.625rem;
            padding: 1.25rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            min-height: 70px;
            justify-content: center;
        }
        
        /* Score Display */
        .score-display {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .score-circle {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: conic-gradient(var(--success) var(--score-percent, 0%), var(--bg-secondary) 0%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            position: relative;
        }
        
        .score-circle::before {
            content: '';
            position: absolute;
            width: 110px;
            height: 110px;
            background: var(--bg-card);
            border-radius: 50%;
        }
        
        .score-text {
            position: relative;
            z-index: 1;
            font-size: 1.75rem;
            font-weight: 700;
        }
        
        .score-label {
            color: var(--text-muted);
            font-size: 1rem;
        }
        
        /* Feedback Messages */
        .feedback {
            padding: 1rem 1.25rem;
            border-radius: var(--radius-md);
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.625rem;
            font-weight: 500;
            animation: slideIn 0.2s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-10px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .feedback.correct {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .feedback.incorrect {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--error);
            color: var(--error);
        }
        
        /* Confetti */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s linear forwards;
        }
        
        @keyframes confettiFall {
            0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.375rem;
            margin-bottom: 1.5rem;
            background: var(--bg-secondary);
            padding: 0.375rem;
            border-radius: var(--radius-md);
        }
        
        .tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        .tab:hover:not(.active) {
            color: var(--text-primary);
            background: var(--bg-card-hover);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
        }
        
        .empty-state-icon {
            width: 100px;
            height: 100px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 1.5rem;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .empty-state h3 {
            font-size: 1.375rem;
            margin-bottom: 0.5rem;
        }
        
        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }
        
        /* Success Animation */
        .success-animation {
            text-align: center;
            padding: 2.5rem;
        }
        
        .success-animation .checkmark {
            width: 90px;
            height: 90px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            margin: 0 auto 1.25rem;
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes pop {
            0% { transform: scale(0); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        
        /* Error Page */
        .error-page {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .error-icon {
            width: 100px;
            height: 100px;
            background: var(--error);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            margin: 0 auto 2rem;
        }
        
        .error-page h2 {
            color: var(--error);
            font-size: 1.75rem;
            margin-bottom: 1rem;
        }
        
        .error-page p {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-card-hover);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .header-actions {
                justify-content: center;
            }
            
            .main-container {
                padding: 1rem;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .match-container {
                flex-direction: column;
            }
            
            .modal {
                margin: 0.5rem;
                max-height: calc(100vh - 1rem);
            }
            
            .section-title {
                font-size: 1.75rem;
            }
            
            .exam-type-selector {
                grid-template-columns: 1fr 1fr;
            }
            
            .student-header {
                padding: 1.5rem;
            }
            
            .student-header h2 {
                font-size: 1.5rem;
            }
        }
        
        /* Shake animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        
        /* Pulse animation for loading */
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
    </style>
</head>
<body>
    <!-- Ambient Background -->
    <div class="ambient-bg"></div>
    <div class="noise-overlay"></div>
    
    <!-- Confetti Container -->
    <div class="confetti-container" id="confetti"></div>
    
    <!-- Header -->
    <header class="header" id="mainHeader">
        <div class="logo">
            <div class="logo-icon">üìö</div>
            <h1>Arabic by Rolla</h1>
        </div>
        <div class="header-actions" id="headerActions">
            <button class="btn btn-icon" onclick="toggleTheme()" title="Toggle Theme" id="themeToggleBtn">
                ‚òÄÔ∏è
            </button>
            <button class="btn btn-secondary" onclick="goHome()">
                üè† Home
            </button>
            <button class="btn btn-danger" onclick="resetAll()">
                üóëÔ∏è Reset
            </button>
        </div>
    </header>
    
    <!-- Main Container -->
    <main class="main-container" id="mainContainer">
        <!-- Dynamic content -->
    </main>
    
    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Quiz</h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const TELEGRAM_BOT_TOKEN = '6759901283:AAGGfZvU2EX59mK6uefmHV69GJ-NKPbCdQ4';
        let TELEGRAM_CHAT_ID = localStorage.getItem('telegramChatId') || '';
        const STORAGE_KEY = 'arabicByRolla';
        const EXAMS_STORAGE_KEY = 'arabicByRollaExams';
        const SUBMISSIONS_KEY = 'arabicByRollaSubmissions';
        
        // ==================== DATA STORAGE ====================
        let quizData = {
            fillBlank: { questions: [] },
            relatedWords: { categories: [], decoyWords: [] },
            matchWords: { pairs: [] },
            trueFalse: { questions: [] }
        };
        
        let examsData = {};
        let submissionsData = {};
        let isStudentMode = false;
        let currentExamId = null;
        let currentExamData = null;
        let studentName = '';
        let studentAnswers = {};
        let currentView = 'main';
        
        // ==================== URL COMPRESSION ====================
        // Super aggressive compression for minimal URL length
        
        // Minify exam data by using short keys
        function minifyExamData(exam) {
            const minified = {
                t: exam.title,
                c: exam.telegramChatId || '',
                q: {}
            };
            
            // Minify fillBlank questions
            if (exam.questions.fillBlank && exam.questions.fillBlank.length > 0) {
                minified.q.f = exam.questions.fillBlank.map(q => ({
                    s: q.sentence,
                    b: q.blankWord,
                    o: q.options.filter(o => o) // Remove empty options
                }));
            }
            
            // Minify trueFalse questions  
            if (exam.questions.trueFalse && exam.questions.trueFalse.length > 0) {
                minified.q.t = exam.questions.trueFalse.map(q => ({
                    s: q.statement,
                    a: q.isTrue ? 1 : 0
                }));
            }
            
            // Minify matchWords pairs
            if (exam.questions.matchWords && exam.questions.matchWords.length > 0) {
                minified.q.m = exam.questions.matchWords.map(p => [p.word1, p.word2]);
            }
            
            // Minify relatedWords categories
            if (exam.questions.relatedWords && exam.questions.relatedWords.length > 0) {
                minified.q.r = exam.questions.relatedWords.map(c => ({
                    n: c.name,
                    w: c.words
                }));
            }
            
            // Minify decoy words
            if (exam.questions.decoyWords && exam.questions.decoyWords.length > 0) {
                minified.q.d = exam.questions.decoyWords;
            }
            
            // Minify sentenceArrange questions
            if (exam.questions.sentenceArrange && exam.questions.sentenceArrange.length > 0) {
                minified.q.s = exam.questions.sentenceArrange.map(q => q.sentence);
            }
            
            // Minify listeningQuiz questions
            if (exam.questions.listeningQuiz && exam.questions.listeningQuiz.length > 0) {
                minified.q.l = exam.questions.listeningQuiz.map(q => ({
                    w: q.correctWord,
                    o: q.wrongOptions.filter(o => o)
                }));
            }
            
            return minified;
        }
        
        // Expand minified data back to full format
        function expandExamData(minified) {
            const expanded = {
                id: 'embedded',
                title: minified.t,
                telegramChatId: minified.c || '',
                questions: {
                    fillBlank: [],
                    trueFalse: [],
                    matchWords: [],
                    relatedWords: [],
                    sentenceArrange: [],
                    listeningQuiz: [],
                    decoyWords: []
                }
            };
            
            if (minified.q.f) {
                expanded.questions.fillBlank = minified.q.f.map(q => ({
                    sentence: q.s,
                    blankWord: q.b,
                    options: q.o
                }));
            }
            
            if (minified.q.t) {
                expanded.questions.trueFalse = minified.q.t.map(q => ({
                    statement: q.s,
                    isTrue: q.a === 1
                }));
            }
            
            if (minified.q.m) {
                expanded.questions.matchWords = minified.q.m.map(p => ({
                    word1: p[0],
                    word2: p[1]
                }));
            }
            
            if (minified.q.r) {
                expanded.questions.relatedWords = minified.q.r.map(c => ({
                    name: c.n,
                    words: c.w
                }));
            }
            
            if (minified.q.d) {
                expanded.questions.decoyWords = minified.q.d;
            }
            
            if (minified.q.s) {
                expanded.questions.sentenceArrange = minified.q.s.map(s => ({ sentence: s }));
            }
            
            if (minified.q.l) {
                expanded.questions.listeningQuiz = minified.q.l.map(q => ({
                    correctWord: q.w,
                    wrongOptions: q.o
                }));
            }
            
            return expanded;
        }
        
        function compressExamData(exam) {
            // First minify the data structure
            const minified = minifyExamData(exam);
            const json = JSON.stringify(minified);
            // Use LZ-String's URI-safe compression
            return LZString.compressToEncodedURIComponent(json);
        }
        
        function decompressExamData(compressed) {
            try {
                const json = LZString.decompressFromEncodedURIComponent(compressed);
                if (!json) return null;
                const parsed = JSON.parse(json);
                
                // Check if it's minified format (has 't' key) or full format (has 'title' key)
                if (parsed.t !== undefined) {
                    return expandExamData(parsed);
                }
                return parsed;
            } catch (e) {
                console.error('Failed to decompress exam data:', e);
                return null;
            }
        }
        
        // Legacy decoder for old base64 links
        function decodeExamDataLegacy(encoded) {
            try {
                const json = decodeURIComponent(escape(atob(encoded)));
                return JSON.parse(json);
            } catch (e) {
                return null;
            }
        }
        
        // ==================== THEME TOGGLE ====================
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            updateThemeIcon();
        }
        
        function updateThemeIcon() {
            const btn = document.getElementById('themeToggleBtn');
            if (btn) {
                const isLight = document.body.classList.contains('light-theme');
                btn.textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
            }
        }
        
        function loadTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'light') {
                document.body.classList.add('light-theme');
            }
            updateThemeIcon();
        }
        
        // ==================== DATA MANAGEMENT ====================
        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                quizData = {
                    ...quizData,
                    ...parsed,
                    relatedWords: {
                        categories: parsed.relatedWords?.categories || [],
                        decoyWords: parsed.relatedWords?.decoyWords || []
                    }
                };
            }
            const savedExams = localStorage.getItem(EXAMS_STORAGE_KEY);
            if (savedExams) {
                examsData = JSON.parse(savedExams);
            }
            const savedSubmissions = localStorage.getItem(SUBMISSIONS_KEY);
            if (savedSubmissions) {
                submissionsData = JSON.parse(savedSubmissions);
            }
        }
        
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(quizData));
        }
        
        function saveExams() {
            localStorage.setItem(EXAMS_STORAGE_KEY, JSON.stringify(examsData));
        }
        
        function saveSubmissions() {
            localStorage.setItem(SUBMISSIONS_KEY, JSON.stringify(submissionsData));
        }
        
        // ==================== STUDENT MODE CHECK ====================
        function checkStudentMode() {
            const params = new URLSearchParams(window.location.search);
            const compressedData = params.get('e'); // New compressed format
            const legacyData = params.get('data'); // Legacy base64 format
            const examId = params.get('exam'); // Very old localStorage format
            
            // Try new compressed format first
            if (compressedData) {
                const decoded = decompressExamData(compressedData);
                if (decoded) {
                    isStudentMode = true;
                    currentExamId = decoded.id || 'embedded';
                    currentExamData = decoded;
                    document.getElementById('mainHeader').style.display = 'none';
                    renderStudentExam();
                    return true;
                }
            }
            
            // Try legacy base64 format
            if (legacyData) {
                const decoded = decodeExamDataLegacy(legacyData);
                if (decoded) {
                    isStudentMode = true;
                    currentExamId = decoded.id || 'embedded';
                    currentExamData = decoded;
                    document.getElementById('mainHeader').style.display = 'none';
                    renderStudentExam();
                    return true;
                }
            }
            
            // Try localStorage format
            if (examId && examsData[examId]) {
                isStudentMode = true;
                currentExamId = examId;
                currentExamData = examsData[examId];
                document.getElementById('mainHeader').style.display = 'none';
                renderStudentExam();
                return true;
            }
            
            // If there's a parameter but no valid data
            if (compressedData || legacyData || examId) {
                renderExamNotFound();
                return true;
            }
            
            return false;
        }
        
        function renderExamNotFound() {
            document.getElementById('mainHeader').style.display = 'none';
            const container = document.getElementById('mainContainer');
            container.innerHTML = `
                <div class="error-page">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <h2>Exam Not Found</h2>
                    <p>This exam link may have expired, been deleted, or is no longer available.</p>
                    <p>Please contact your teacher for a new link.</p>
                </div>
            `;
        }
        
        function resetAll() {
            if (confirm('Are you sure you want to reset all quizzes and exams? This cannot be undone!')) {
                quizData = {
                    fillBlank: { questions: [] },
                    relatedWords: { categories: [], decoyWords: [] },
                    matchWords: { pairs: [] },
                    trueFalse: { questions: [] }
                };
                examsData = {};
                saveData();
                saveExams();
                goHome();
                createConfetti();
            }
        }
        
        // ==================== NAVIGATION ====================
        function goHome() {
            closeModal();
            renderTeacherHome();
        }
        
        function renderTeacherHome() {
            const container = document.getElementById('mainContainer');
            container.innerHTML = `
                <section id="homeView">
                    <div class="section-header">
                        <h2 class="section-title">Welcome, Teacher!</h2>
                        <p class="section-subtitle">Create interactive quizzes and exams for your students</p>
                    </div>
                    
                    <!-- Telegram Settings -->
                    <div class="settings-card">
                        <h3>
                            <span>üì©</span> Telegram Notifications
                        </h3>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Your Telegram Chat ID</label>
                            <input type="text" id="chatIdInput" placeholder="Enter your Telegram Chat ID" 
                                value="${TELEGRAM_CHAT_ID}" onchange="saveChatId(this.value)">
                            <p class="form-hint">Get your Chat ID by messaging @userinfobot on Telegram. Student submissions will be sent to this chat.</p>
                        </div>
                    </div>
                    
                    <!-- Create Exam Button -->
                    <div class="create-exam-card" onclick="openExamBuilder()">
                        <div class="icon">üìù</div>
                        <h3>Create Shareable Exam</h3>
                        <p>Combine quiz types into an exam and share with students via a short, compact link</p>
                    </div>
                    
                    <h3 style="margin: 2rem 0 0.5rem; color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Practice Quiz Types</h3>
                    
                    <div class="cards-grid">
                        <!-- Fill the Blank -->
                        <div class="quiz-card" onclick="openQuizModal('fillBlank')">
                            <span class="quiz-badge ${quizData.fillBlank.questions.length > 0 ? 'badge-ready' : 'badge-empty'}">
                                ${quizData.fillBlank.questions.length > 0 ? quizData.fillBlank.questions.length + ' Questions' : 'Empty'}
                            </span>
                            <div class="quiz-card-icon fill-blank">üìù</div>
                            <h3>Fill in the Blank</h3>
                            <p>Create sentences with missing words. Students choose from multiple options.</p>
                        </div>
                        
                        <!-- Related Words -->
                        <div class="quiz-card" onclick="openQuizModal('relatedWords')">
                            <span class="quiz-badge ${quizData.relatedWords.categories.length > 0 ? 'badge-ready' : 'badge-empty'}">
                                ${quizData.relatedWords.categories.length > 0 ? quizData.relatedWords.categories.length + ' Categories' : 'Empty'}
                            </span>
                            <div class="quiz-card-icon related-words">üñºÔ∏è</div>
                            <h3>Picture Word Match</h3>
                            <p>Upload images and let students match related words to pictures. Add decoy words to make it challenging!</p>
                        </div>
                        
                        <!-- Match Words -->
                        <div class="quiz-card" onclick="openQuizModal('matchWords')">
                            <span class="quiz-badge ${quizData.matchWords.pairs.length > 0 ? 'badge-ready' : 'badge-empty'}">
                                ${quizData.matchWords.pairs.length > 0 ? quizData.matchWords.pairs.length + ' Pairs' : 'Empty'}
                            </span>
                            <div class="quiz-card-icon match-words">üîó</div>
                            <h3>Match the Words</h3>
                            <p>Create word pairs for students to match - great for synonyms and translations!</p>
                        </div>
                        
                        <!-- True/False -->
                        <div class="quiz-card" onclick="openQuizModal('trueFalse')">
                            <span class="quiz-badge ${quizData.trueFalse.questions.length > 0 ? 'badge-ready' : 'badge-empty'}">
                                ${quizData.trueFalse.questions.length > 0 ? quizData.trueFalse.questions.length + ' Questions' : 'Empty'}
                            </span>
                            <div class="quiz-card-icon true-false">‚úì‚úó</div>
                            <h3>True or False</h3>
                            <p>Create statements and let students decide if they are true or false.</p>
                        </div>
                    </div>
                </section>
            `;
        }
        
        function saveChatId(value) {
            TELEGRAM_CHAT_ID = value.trim();
            localStorage.setItem('telegramChatId', TELEGRAM_CHAT_ID);
        }
        
        // ==================== EXAM BUILDER ====================
        function openExamBuilder() {
            const modal = document.getElementById('modalOverlay');
            const modalEl = document.getElementById('modal');
            modalEl.classList.add('wide');
            modal.classList.add('active');
            document.getElementById('modalTitle').innerHTML = 'üìù Create Shareable Exam';
            renderExamBuilderStep1();
        }
        
        let examBuilder = {
            title: '',
            selectedTypes: [],
            questions: {
                fillBlank: [],
                trueFalse: [],
                matchWords: [],
                relatedWords: []
            },
            decoyWords: []
        };
        
        function renderExamBuilderStep1() {
            examBuilder = {
                title: '',
                selectedTypes: [],
                questions: {
                    fillBlank: [],
                    trueFalse: [],
                    matchWords: [],
                    relatedWords: [],
                    sentenceArrange: [],
                    listeningQuiz: []
                },
                decoyWords: []
            };
            
            const body = document.getElementById('modalBody');
            body.innerHTML = `
                <div class="form-group">
                    <label>Exam Title</label>
                    <input type="text" id="examTitle" placeholder="e.g., Arabic Vocabulary Test Week 3" value="${examBuilder.title}">
                </div>
                
                <label style="display: block; margin-bottom: 1rem; font-weight: 600;">Select Quiz Types to Include</label>
                <div class="exam-type-selector">
                    <label class="exam-type-option" id="opt-fillBlank">
                        <input type="checkbox" value="fillBlank" onchange="toggleExamType('fillBlank')">
                        <div class="icon">üìù</div>
                        <div class="name">Fill in the Blank</div>
                    </label>
                    <label class="exam-type-option" id="opt-trueFalse">
                        <input type="checkbox" value="trueFalse" onchange="toggleExamType('trueFalse')">
                        <div class="icon">‚úì‚úó</div>
                        <div class="name">True or False</div>
                    </label>
                    <label class="exam-type-option" id="opt-matchWords">
                        <input type="checkbox" value="matchWords" onchange="toggleExamType('matchWords')">
                        <div class="icon">üîó</div>
                        <div class="name">Match Words</div>
                    </label>
                    <label class="exam-type-option" id="opt-relatedWords">
                        <input type="checkbox" value="relatedWords" onchange="toggleExamType('relatedWords')">
                        <div class="icon">üñºÔ∏è</div>
                        <div class="name">Picture Match</div>
                    </label>
                    <label class="exam-type-option" id="opt-sentenceArrange">
                        <input type="checkbox" value="sentenceArrange" onchange="toggleExamType('sentenceArrange')">
                        <div class="icon">üîÄ</div>
                        <div class="name">Arrange Sentence</div>
                    </label>
                    <label class="exam-type-option" id="opt-listeningQuiz">
                        <input type="checkbox" value="listeningQuiz" onchange="toggleExamType('listeningQuiz')">
                        <div class="icon">üéß</div>
                        <div class="name">Listening Quiz</div>
                    </label>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-gradient" onclick="goToExamStep2()" style="flex: 1;">
                        Continue to Add Questions ‚Üí
                    </button>
                </div>
            `;
        }
        
        function toggleExamType(type) {
            const opt = document.getElementById(`opt-${type}`);
            const idx = examBuilder.selectedTypes.indexOf(type);
            if (idx > -1) {
                examBuilder.selectedTypes.splice(idx, 1);
                opt.classList.remove('selected');
            } else {
                examBuilder.selectedTypes.push(type);
                opt.classList.add('selected');
            }
        }
        
        function goToExamStep2() {
            examBuilder.title = document.getElementById('examTitle').value.trim();
            if (!examBuilder.title) {
                alert('Please enter an exam title');
                return;
            }
            if (examBuilder.selectedTypes.length === 0) {
                alert('Please select at least one quiz type');
                return;
            }
            renderExamBuilderStep2();
        }
        
        let examTempImages = {};
        let examTempWords = {};
        let examTempDecoyWords = [];
        
        function renderExamBuilderStep2() {
            const body = document.getElementById('modalBody');
            
            let sectionsHtml = '';
            
            if (examBuilder.selectedTypes.includes('fillBlank')) {
                sectionsHtml += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: var(--gradient-primary); padding: 0.375rem 0.875rem; border-radius: var(--radius-full); color: white; font-size: 0.875rem;">üìù</span>
                            Fill in the Blank Questions
                        </h3>
                        <div id="fillBlankContainer">
                            ${examBuilder.questions.fillBlank.map((q, i) => renderExamFillBlankQ(q, i)).join('')}
                        </div>
                        <button class="btn btn-secondary" onclick="addExamFillBlankQ()" style="width: 100%; margin-top: 0.5rem;">
                            + Add Fill in the Blank Question
                        </button>
                    </div>
                `;
            }
            
            if (examBuilder.selectedTypes.includes('trueFalse')) {
                sectionsHtml += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: var(--gradient-success); padding: 0.375rem 0.875rem; border-radius: var(--radius-full); color: white; font-size: 0.875rem;">‚úì‚úó</span>
                            True or False Questions
                        </h3>
                        <div id="trueFalseContainer">
                            ${examBuilder.questions.trueFalse.map((q, i) => renderExamTFQ(q, i)).join('')}
                        </div>
                        <button class="btn btn-secondary" onclick="addExamTFQ()" style="width: 100%; margin-top: 0.5rem;">
                            + Add True/False Question
                        </button>
                    </div>
                `;
            }
            
            if (examBuilder.selectedTypes.includes('matchWords')) {
                sectionsHtml += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: var(--gradient-accent); padding: 0.375rem 0.875rem; border-radius: var(--radius-full); color: #1e293b; font-size: 0.875rem;">üîó</span>
                            Match Words Pairs
                        </h3>
                        <div id="matchWordsContainer">
                            ${examBuilder.questions.matchWords.map((q, i) => renderExamMatchQ(q, i)).join('')}
                        </div>
                        <button class="btn btn-secondary" onclick="addExamMatchQ()" style="width: 100%; margin-top: 0.5rem;">
                            + Add Word Pair
                        </button>
                    </div>
                `;
            }
            
            if (examBuilder.selectedTypes.includes('relatedWords')) {
                sectionsHtml += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: var(--gradient-secondary); padding: 0.375rem 0.875rem; border-radius: var(--radius-full); color: white; font-size: 0.875rem;">üñºÔ∏è</span>
                            Picture Word Match Categories
                        </h3>
                        <div id="relatedWordsContainer">
                            ${examBuilder.questions.relatedWords.map((q, i) => renderExamCategoryQ(q, i)).join('')}
                        </div>
                        <button class="btn btn-secondary" onclick="addExamCategoryQ()" style="width: 100%; margin-top: 0.5rem;">
                            + Add Category
                        </button>
                        
                        <!-- Decoy Words Section -->
                        <div class="category-builder" style="margin-top: 1.5rem; border-color: var(--warning); background: rgba(245, 158, 11, 0.05);">
                            <div class="category-builder-header">
                                <span style="background: var(--warning); padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: 0.8125rem; font-weight: 600; color: #1e293b;">
                                    üé≠ Decoy Words (Trick Students!)
                                </span>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
                                Add fake words that don't belong to any category. Students won't lose points for not placing these - they're just distractors!
                            </p>
                            <div class="form-group" style="margin-bottom: 0;">
                                <div class="tags-input" id="examDecoyTags">
                                    ${(examTempDecoyWords || []).map(w => `
                                        <span class="tag decoy-tag">${w} <button onclick="removeExamDecoyWord('${escapeHtml(w)}')">&times;</button></span>
                                    `).join('')}
                                    <input type="text" id="examDecoyWordInput" placeholder="Type decoy word and press Enter" 
                                        onkeypress="handleExamDecoyWord(event)">
                                </div>
                                <p class="form-hint">Example: If categories are "Food" and "Drinks", add animal words as decoys!</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (examBuilder.selectedTypes.includes('sentenceArrange')) {
                sectionsHtml += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); padding: 0.375rem 0.875rem; border-radius: var(--radius-full); color: white; font-size: 0.875rem;">üîÄ</span>
                            Arrange Sentence Questions
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
                            Enter sentences and students will rearrange the shuffled words in correct order.
                        </p>
                        <div id="sentenceArrangeContainer">
                            ${(examBuilder.questions.sentenceArrange || []).map((q, i) => renderExamSentenceArrangeQ(q, i)).join('')}
                        </div>
                        <button class="btn btn-secondary" onclick="addExamSentenceArrangeQ()" style="width: 100%; margin-top: 0.5rem;">
                            + Add Sentence
                        </button>
                    </div>
                `;
            }
            
            if (examBuilder.selectedTypes.includes('listeningQuiz')) {
                sectionsHtml += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); padding: 0.375rem 0.875rem; border-radius: var(--radius-full); color: white; font-size: 0.875rem;">üéß</span>
                            Listening Quiz Questions
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
                            Students will hear a word spoken aloud and must choose the correct word from options.
                        </p>
                        <div id="listeningQuizContainer">
                            ${(examBuilder.questions.listeningQuiz || []).map((q, i) => renderExamListeningQ(q, i)).join('')}
                        </div>
                        <button class="btn btn-secondary" onclick="addExamListeningQ()" style="width: 100%; margin-top: 0.5rem;">
                            + Add Listening Question
                        </button>
                    </div>
                `;
            }
            
            body.innerHTML = `
                <h3 style="margin-bottom: 1.5rem; font-size: 1.125rem;">Add Questions for: <span style="color: var(--primary);">${examBuilder.title}</span></h3>
                ${sectionsHtml}
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="renderExamBuilderStep1()">‚Üê Back</button>
                    <button class="btn btn-success" onclick="generateExamLink()" style="flex: 1;">
                        üîó Generate Exam Link
                    </button>
                </div>
            `;
            
            // Initialize with one question each if empty
            if (examBuilder.selectedTypes.includes('fillBlank') && examBuilder.questions.fillBlank.length === 0) {
                addExamFillBlankQ();
            }
            if (examBuilder.selectedTypes.includes('trueFalse') && examBuilder.questions.trueFalse.length === 0) {
                addExamTFQ();
            }
            if (examBuilder.selectedTypes.includes('matchWords') && examBuilder.questions.matchWords.length === 0) {
                addExamMatchQ();
            }
            if (examBuilder.selectedTypes.includes('sentenceArrange') && (!examBuilder.questions.sentenceArrange || examBuilder.questions.sentenceArrange.length === 0)) {
                addExamSentenceArrangeQ();
            }
            if (examBuilder.selectedTypes.includes('listeningQuiz') && (!examBuilder.questions.listeningQuiz || examBuilder.questions.listeningQuiz.length === 0)) {
                addExamListeningQ();
            }
            if (examBuilder.selectedTypes.includes('relatedWords') && examBuilder.questions.relatedWords.length === 0) {
                addExamCategoryQ();
            }
        }
        
        // Decoy words handling
        function handleExamDecoyWord(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('examDecoyWordInput');
                const word = input.value.trim();
                if (word && !examTempDecoyWords.includes(word)) {
                    examTempDecoyWords.push(word);
                    
                    const container = document.getElementById('examDecoyTags');
                    const tag = document.createElement('span');
                    tag.className = 'tag decoy-tag';
                    tag.innerHTML = `${word} <button onclick="removeExamDecoyWord('${escapeHtml(word)}')">&times;</button>`;
                    container.insertBefore(tag, input);
                    input.value = '';
                }
            }
        }
        
        function removeExamDecoyWord(word) {
            examTempDecoyWords = examTempDecoyWords.filter(w => w !== word);
            const container = document.getElementById('examDecoyTags');
            const tags = container.querySelectorAll('.tag');
            tags.forEach(tag => {
                if (tag.textContent.trim().replace('√ó', '').trim() === word) {
                    tag.remove();
                }
            });
        }
        
        // Fill in the Blank for Exam
        function renderExamFillBlankQ(q = null, index = 0) {
            const question = q || { sentence: '', blankWord: '', options: ['', '', ''] };
            return `
                <div class="question-builder" id="examFB-${index}">
                    <span class="question-number">Q${index + 1}</span>
                    <button class="remove-question" onclick="removeExamQ('fillBlank', ${index})">&times;</button>
                    <div class="form-group">
                        <label>Sentence (use [BLANK] for hidden word)</label>
                        <input type="text" id="examFBSentence-${index}" value="${question.sentence}" 
                            placeholder="The cat is [BLANK] on the mat.">
                    </div>
                    <div class="form-group">
                        <label>Correct Answer</label>
                        <input type="text" id="examFBAnswer-${index}" value="${question.blankWord}" placeholder="sitting">
                    </div>
                    <div class="form-group">
                        <label>Wrong Options (3 distractors)</label>
                        <div class="options-container">
                            <input type="text" id="examFBOpt-${index}-0" value="${question.options[0] || ''}" placeholder="Option 1">
                            <input type="text" id="examFBOpt-${index}-1" value="${question.options[1] || ''}" placeholder="Option 2">
                            <input type="text" id="examFBOpt-${index}-2" value="${question.options[2] || ''}" placeholder="Option 3">
                        </div>
                    </div>
                </div>
            `;
        }
        
        function addExamFillBlankQ() {
            const container = document.getElementById('fillBlankContainer');
            const index = container.children.length;
            examBuilder.questions.fillBlank.push({ sentence: '', blankWord: '', options: ['', '', ''] });
            container.insertAdjacentHTML('beforeend', renderExamFillBlankQ(null, index));
        }
        
        // True/False for Exam
        function renderExamTFQ(q = null, index = 0) {
            const question = q || { statement: '', isTrue: true };
            return `
                <div class="question-builder" id="examTF-${index}">
                    <span class="question-number">Q${index + 1}</span>
                    <button class="remove-question" onclick="removeExamQ('trueFalse', ${index})">&times;</button>
                    <div class="form-group">
                        <label>Statement</label>
                        <textarea id="examTFStatement-${index}" placeholder="Enter a statement...">${question.statement}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Correct Answer</label>
                        <div style="display: flex; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="examTFAnswer-${index}" value="true" ${question.isTrue ? 'checked' : ''}>
                                <span style="color: var(--success); font-weight: 600;">True</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="examTFAnswer-${index}" value="false" ${!question.isTrue ? 'checked' : ''}>
                                <span style="color: var(--error); font-weight: 600;">False</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function addExamTFQ() {
            const container = document.getElementById('trueFalseContainer');
            const index = container.children.length;
            examBuilder.questions.trueFalse.push({ statement: '', isTrue: true });
            container.insertAdjacentHTML('beforeend', renderExamTFQ(null, index));
        }
        
        // Match Words for Exam
        function renderExamMatchQ(q = null, index = 0) {
            const question = q || { word1: '', word2: '' };
            return `
                <div class="question-builder" id="examMatch-${index}" style="display: flex; gap: 1rem; align-items: center;">
                    <span class="question-number">${index + 1}</span>
                    <input type="text" id="examMatchW1-${index}" value="${question.word1}" placeholder="Word 1" style="flex: 1;">
                    <span style="font-size: 1.25rem; color: var(--text-muted);">‚Üî</span>
                    <input type="text" id="examMatchW2-${index}" value="${question.word2}" placeholder="Word 2" style="flex: 1;">
                    <button class="remove-question" onclick="removeExamQ('matchWords', ${index})" style="position: relative; top: 0; right: 0;">&times;</button>
                </div>
            `;
        }
        
        function addExamMatchQ() {
            const container = document.getElementById('matchWordsContainer');
            const index = container.children.length;
            examBuilder.questions.matchWords.push({ word1: '', word2: '' });
            container.insertAdjacentHTML('beforeend', renderExamMatchQ(null, index));
        }
        
        // Category for Exam (Picture Match)
        function renderExamCategoryQ(q = null, index = 0) {
            const cat = q || { name: '', words: [] };
            examTempWords[index] = examTempWords[index] || [...(cat.words || [])];
            return `
                <div class="category-builder" id="examCat-${index}">
                    <div class="category-builder-header">
                        <span class="category-label">Category ${index + 1}</span>
                        <button class="remove-question" onclick="removeExamQ('relatedWords', ${index})" style="position: relative; top: 0; right: 0;">&times;</button>
                    </div>
                    <div class="form-group">
                        <label>Category Name</label>
                        <input type="text" id="examCatName-${index}" value="${cat.name}" placeholder="e.g., Animals, Fruits, Food">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Words that belong to this category</label>
                        <div class="tags-input" id="examCatTags-${index}">
                            ${(examTempWords[index] || []).map(w => `
                                <span class="tag">${w} <button onclick="removeExamCatWord(${index}, '${escapeHtml(w)}')">&times;</button></span>
                            `).join('')}
                            <input type="text" id="examCatWordInput-${index}" placeholder="Type word and press Enter" 
                                onkeypress="handleExamCatWord(event, ${index})">
                        </div>
                        <p class="form-hint">Press Enter to add each word</p>
                    </div>
                </div>
            `;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, "\\'");
        }
        
        function handleExamCatWord(event, index) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById(`examCatWordInput-${index}`);
                const word = input.value.trim();
                if (word) {
                    if (!examTempWords[index]) examTempWords[index] = [];
                    examTempWords[index].push(word);
                    
                    const container = document.getElementById(`examCatTags-${index}`);
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.innerHTML = `${word} <button onclick="removeExamCatWord(${index}, '${escapeHtml(word)}')">&times;</button>`;
                    container.insertBefore(tag, input);
                    input.value = '';
                }
            }
        }
        
        function removeExamCatWord(index, word) {
            if (examTempWords[index]) {
                examTempWords[index] = examTempWords[index].filter(w => w !== word);
            }
            const container = document.getElementById(`examCatTags-${index}`);
            const tags = container.querySelectorAll('.tag');
            tags.forEach(tag => {
                if (tag.textContent.trim().replace('√ó', '').trim() === word) {
                    tag.remove();
                }
            });
        }
        
        function addExamCategoryQ() {
            const container = document.getElementById('relatedWordsContainer');
            const index = container.children.length;
            examBuilder.questions.relatedWords.push({ name: '', words: [] });
            examTempWords[index] = [];
            container.insertAdjacentHTML('beforeend', renderExamCategoryQ(null, index));
        }
        
        // Sentence Arrange Quiz Builder
        function renderExamSentenceArrangeQ(q = null, index = 0) {
            const question = q || { sentence: '' };
            return `
                <div class="question-builder" id="examSA-${index}">
                    <span class="question-number">Q${index + 1}</span>
                    <button class="remove-question" onclick="removeExamQ('sentenceArrange', ${index})">&times;</button>
                    <div class="form-group">
                        <label>Sentence (in correct order)</label>
                        <textarea id="examSASentence-${index}" placeholder="Enter the complete sentence in correct word order. Words will be shuffled for students.">${question.sentence}</textarea>
                    </div>
                    <p class="form-hint">Example: "ŸÉÿßŸÜ ÿßŸÑŸäŸàŸÖ ÿ¨ŸÖŸäŸÑÿß ÿ¨ÿØÿß" - Words will be shuffled for students to rearrange</p>
                </div>
            `;
        }
        
        function addExamSentenceArrangeQ() {
            const container = document.getElementById('sentenceArrangeContainer');
            const index = container.children.length;
            if (!examBuilder.questions.sentenceArrange) examBuilder.questions.sentenceArrange = [];
            examBuilder.questions.sentenceArrange.push({ sentence: '' });
            container.insertAdjacentHTML('beforeend', renderExamSentenceArrangeQ(null, index));
        }
        
        // Listening Quiz Builder
        function renderExamListeningQ(q = null, index = 0) {
            const question = q || { correctWord: '', wrongOptions: ['', ''] };
            return `
                <div class="question-builder" id="examLQ-${index}">
                    <span class="question-number">Q${index + 1}</span>
                    <button class="remove-question" onclick="removeExamQ('listeningQuiz', ${index})">&times;</button>
                    <div class="form-group">
                        <label>Correct Word (will be spoken aloud)</label>
                        <input type="text" id="examLQWord-${index}" value="${question.correctWord}" placeholder="Enter the word students need to identify">
                    </div>
                    <div class="form-group">
                        <label>Wrong Options (2-3 similar sounding or looking words)</label>
                        <div class="options-container">
                            <input type="text" id="examLQOpt-${index}-0" value="${question.wrongOptions[0] || ''}" placeholder="Wrong option 1">
                            <input type="text" id="examLQOpt-${index}-1" value="${question.wrongOptions[1] || ''}" placeholder="Wrong option 2">
                            <input type="text" id="examLQOpt-${index}-2" value="${question.wrongOptions[2] || ''}" placeholder="Wrong option 3 (optional)">
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="testSpeech('${index}')" style="margin-top: 0.5rem;">
                        üîä Test Speech
                    </button>
                    <p class="form-hint">Uses browser text-to-speech. Works best with Arabic words.</p>
                </div>
            `;
        }
        
        function addExamListeningQ() {
            const container = document.getElementById('listeningQuizContainer');
            const index = container.children.length;
            if (!examBuilder.questions.listeningQuiz) examBuilder.questions.listeningQuiz = [];
            examBuilder.questions.listeningQuiz.push({ correctWord: '', wrongOptions: ['', ''] });
            container.insertAdjacentHTML('beforeend', renderExamListeningQ(null, index));
        }
        
        function testSpeech(index) {
            const input = document.getElementById(`examLQWord-${index}`);
            const word = input?.value?.trim() || '';
            if (!word) {
                alert('Please enter a word first');
                return;
            }
            // Directly use speechSynthesis to ensure it works
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'ar-SA';
                utterance.rate = 0.8;
                
                // Get voices and try to find Arabic
                const voices = speechSynthesis.getVoices();
                const arabicVoice = voices.find(v => v.lang.startsWith('ar'));
                if (arabicVoice) utterance.voice = arabicVoice;
                
                // If voices not loaded yet, wait for them
                if (voices.length === 0) {
                    speechSynthesis.onvoiceschanged = function() {
                        const loadedVoices = speechSynthesis.getVoices();
                        const arabic = loadedVoices.find(v => v.lang.startsWith('ar'));
                        if (arabic) utterance.voice = arabic;
                        speechSynthesis.speak(utterance);
                    };
                } else {
                    speechSynthesis.speak(utterance);
                }
            } else {
                alert('Text-to-speech is not supported in your browser');
            }
        }
        
        // Store loaded voices globally for admin panel
        let adminSpeechVoices = [];
        
        function loadVoicesAndSpeak(word) {
            const voices = speechSynthesis.getVoices();
            if (voices.length > 0) {
                adminSpeechVoices = voices;
                doSpeak(word);
            } else {
                // Wait for voices to load
                speechSynthesis.onvoiceschanged = function() {
                    adminSpeechVoices = speechSynthesis.getVoices();
                    doSpeak(word);
                };
            }
        }
        
        function doSpeak(word) {
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'ar-SA';
            utterance.rate = 0.8;
            // Try to use Arabic voice
            const arabicVoice = adminSpeechVoices.find(v => v.lang.startsWith('ar'));
            if (arabicVoice) utterance.voice = arabicVoice;
            speechSynthesis.speak(utterance);
        }
        
        function speakWord(word) {
            if ('speechSynthesis' in window) {
                if (adminSpeechVoices.length > 0) {
                    doSpeak(word);
                } else {
                    loadVoicesAndSpeak(word);
                }
            } else {
                alert('Text-to-speech is not supported in your browser');
            }
        }
        
        // Pre-load voices when available
        if ('speechSynthesis' in window) {
            adminSpeechVoices = speechSynthesis.getVoices();
            speechSynthesis.onvoiceschanged = () => {
                adminSpeechVoices = speechSynthesis.getVoices();
            };
        }
        
        function removeExamQ(type, index) {
            const containerIds = {
                fillBlank: 'fillBlankContainer',
                trueFalse: 'trueFalseContainer',
                matchWords: 'matchWordsContainer',
                relatedWords: 'relatedWordsContainer',
                sentenceArrange: 'sentenceArrangeContainer',
                listeningQuiz: 'listeningQuizContainer'
            };
            const container = document.getElementById(containerIds[type]);
            if (container && container.children.length > 1) {
                container.children[index].remove();
                if (type === 'relatedWords') {
                    delete examTempWords[index];
                    delete examTempImages[index];
                }
            }
        }
        
        function collectExamQuestions() {
            const questions = {
                fillBlank: [],
                trueFalse: [],
                matchWords: [],
                relatedWords: [],
                sentenceArrange: [],
                listeningQuiz: [],
                decoyWords: examTempDecoyWords || []
            };
            
            // Fill in the Blank
            if (examBuilder.selectedTypes.includes('fillBlank')) {
                const container = document.getElementById('fillBlankContainer');
                for (let i = 0; i < container.children.length; i++) {
                    const sentence = document.getElementById(`examFBSentence-${i}`)?.value || '';
                    const blankWord = document.getElementById(`examFBAnswer-${i}`)?.value || '';
                    const options = [0, 1, 2].map(j => document.getElementById(`examFBOpt-${i}-${j}`)?.value || '').filter(o => o);
                    
                    if (sentence && blankWord) {
                        questions.fillBlank.push({ sentence, blankWord, options });
                    }
                }
            }
            
            // True/False
            if (examBuilder.selectedTypes.includes('trueFalse')) {
                const container = document.getElementById('trueFalseContainer');
                for (let i = 0; i < container.children.length; i++) {
                    const statement = document.getElementById(`examTFStatement-${i}`)?.value || '';
                    const answerRadio = document.querySelector(`input[name="examTFAnswer-${i}"]:checked`);
                    const isTrue = answerRadio ? answerRadio.value === 'true' : true;
                    
                    if (statement) {
                        questions.trueFalse.push({ statement, isTrue });
                    }
                }
            }
            
            // Match Words
            if (examBuilder.selectedTypes.includes('matchWords')) {
                const container = document.getElementById('matchWordsContainer');
                for (let i = 0; i < container.children.length; i++) {
                    const word1 = document.getElementById(`examMatchW1-${i}`)?.value || '';
                    const word2 = document.getElementById(`examMatchW2-${i}`)?.value || '';
                    
                    if (word1 && word2) {
                        questions.matchWords.push({ word1, word2 });
                    }
                }
            }
            
            // Related Words (Category Match - NO images to keep URL small)
            if (examBuilder.selectedTypes.includes('relatedWords')) {
                const container = document.getElementById('relatedWordsContainer');
                for (let i = 0; i < container.children.length; i++) {
                    const name = document.getElementById(`examCatName-${i}`)?.value || '';
                    const words = examTempWords[i] || [];
                    
                    if (name && words.length > 0) {
                        questions.relatedWords.push({ name, words });
                    }
                }
            }
            
            // Sentence Arrange
            if (examBuilder.selectedTypes.includes('sentenceArrange')) {
                const container = document.getElementById('sentenceArrangeContainer');
                for (let i = 0; i < container.children.length; i++) {
                    const sentence = document.getElementById(`examSASentence-${i}`)?.value || '';
                    
                    if (sentence.trim()) {
                        questions.sentenceArrange.push({ sentence: sentence.trim() });
                    }
                }
            }
            
            // Listening Quiz
            if (examBuilder.selectedTypes.includes('listeningQuiz')) {
                const container = document.getElementById('listeningQuizContainer');
                for (let i = 0; i < container.children.length; i++) {
                    const correctWord = document.getElementById(`examLQWord-${i}`)?.value || '';
                    const wrongOptions = [0, 1, 2].map(j => document.getElementById(`examLQOpt-${i}-${j}`)?.value || '').filter(o => o);
                    
                    if (correctWord) {
                        questions.listeningQuiz.push({ correctWord, wrongOptions });
                    }
                }
            }
            
            return questions;
        }
        
        async function generateExamLink() {
            const questions = collectExamQuestions();
            
            // Validate
            let hasQuestions = false;
            for (const type of examBuilder.selectedTypes) {
                if (questions[type] && questions[type].length > 0) {
                    hasQuestions = true;
                    break;
                }
            }
            
            if (!hasQuestions) {
                alert('Please add at least one question to generate the exam link');
                return;
            }
            
            // Build the full exam object for local storage
            const examId = 'e_' + Date.now().toString(36);
            const fullExam = {
                id: examId,
                title: examBuilder.title,
                questions: questions,
                telegramChatId: TELEGRAM_CHAT_ID || '',
                createdAt: new Date().toISOString()
            };
            
            // Save locally with full format
            examsData[examId] = fullExam;
            saveExams();
            
            // Generate URL with SUPER COMPRESSED data using minification
            const compressedData = compressExamData(fullExam);
            const baseUrl = window.location.href.split('?')[0];
            const longExamLink = `${baseUrl}?e=${compressedData}`;
            
            // Reset temp data
            examTempImages = {};
            examTempWords = {};
            examTempDecoyWords = [];
            
            // Show loading state while shortening
            const body = document.getElementById('modalBody');
            body.innerHTML = `
                <div class="success-animation">
                    <div class="checkmark" style="background: var(--primary); animation: pulse 1s infinite;">‚è≥</div>
                    <h3>Creating Your Short Link...</h3>
                    <p style="color: var(--text-secondary);">Please wait while we generate a compact URL</p>
                </div>
            `;
            
            // Try to shorten the URL
            let examLink = longExamLink;
            let wasShortened = false;
            
            try {
                const shortUrl = await shortenUrl(longExamLink);
                if (shortUrl && shortUrl.length < longExamLink.length) {
                    examLink = shortUrl;
                    wasShortened = true;
                }
            } catch (e) {
                console.log('URL shortening failed, using compressed link:', e);
            }
            
            // Show link with size comparison
            const originalSize = JSON.stringify(fullExam).length;
            const finalSize = examLink.length;
            const savings = Math.round((1 - finalSize / originalSize) * 100);
            
            body.innerHTML = `
                <div class="success-animation">
                    <div class="checkmark">‚úì</div>
                    <h3>Exam Created Successfully!</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        ${wasShortened ? 'üéâ Short link generated! Easy to share!' : 'Share this compact link with your students'}
                    </p>

                </div>
                
                <div class="link-display" style="${wasShortened ? 'border-color: var(--success);' : ''}">
                    <input type="text" id="examLinkInput" value="${examLink}" readonly onclick="this.select()" 
                        style="${wasShortened ? 'color: var(--success); font-size: 1rem; font-weight: 600;' : ''}">
                </div>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="copyExamLink()" style="flex: 1;">
                        üìã Copy Link
                    </button>
                    ${!wasShortened ? `
                        <button class="btn btn-secondary" onclick="retryShorten('${longExamLink.replace(/'/g, "\\'")}')">
                            üîÑ Try Shorten Again
                        </button>
                    ` : ''}
                    <button class="btn btn-secondary" onclick="closeModal()">
                        Done
                    </button>
                </div>
                
                ${!wasShortened ? `
                    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); border-radius: var(--radius-md);">
                        <p style="color: var(--warning); font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">
                            üí° Tip: Use a URL shortener for easier sharing
                        </p>
                        <p style="color: var(--text-secondary); font-size: 0.8125rem;">
                            Copy the link above and paste it into <a href="https://tinyurl.com" target="_blank" style="color: var(--accent);">TinyURL.com</a> 
                            or <a href="https://bit.ly" target="_blank" style="color: var(--accent);">Bit.ly</a> to get a shorter link.
                        </p>
                    </div>
                ` : ''}
                
                <p style="margin-top: 1.5rem; color: var(--text-muted); font-size: 0.8125rem; text-align: center;">
                    This link contains all exam data and works on any device/browser.<br>
                    Students can only submit once per name.
                </p>
            `;
            
            createConfetti();
        }
        
        // URL Shortening using multiple services
        async function shortenUrl(longUrl) {
            // Try TinyURL first (free, no API key needed)
            try {
                const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`);
                if (response.ok) {
                    const shortUrl = await response.text();
                    if (shortUrl && shortUrl.startsWith('http')) {
                        return shortUrl;
                    }
                }
            } catch (e) {
                console.log('TinyURL failed:', e);
            }
            
            // Try is.gd as fallback
            try {
                const response = await fetch(`https://is.gd/create.php?format=simple&url=${encodeURIComponent(longUrl)}`);
                if (response.ok) {
                    const shortUrl = await response.text();
                    if (shortUrl && shortUrl.startsWith('http')) {
                        return shortUrl;
                    }
                }
            } catch (e) {
                console.log('is.gd failed:', e);
            }
            
            // Return null if all services fail
            return null;
        }
        
        async function retryShorten(longUrl) {
            const body = document.getElementById('modalBody');
            const currentLink = document.getElementById('examLinkInput')?.value || longUrl;
            
            body.innerHTML = `
                <div class="success-animation">
                    <div class="checkmark" style="background: var(--primary); animation: pulse 1s infinite;">‚è≥</div>
                    <h3>Trying to shorten URL...</h3>
                    <p style="color: var(--text-secondary);">Please wait...</p>
                </div>
            `;
            
            try {
                const shortUrl = await shortenUrl(longUrl);
                if (shortUrl && shortUrl.length < longUrl.length) {
                    // Success! Show the short URL
                    const savings = Math.round((1 - shortUrl.length / longUrl.length) * 100);
                    body.innerHTML = `
                        <div class="success-animation">
                            <div class="checkmark">‚úì</div>
                            <h3>Short Link Created!</h3>
                            <p style="color: var(--text-secondary);">üéâ ${savings}% shorter - easy to share!</p>
                        </div>
                        
                        <div class="link-display" style="border-color: var(--success);">
                            <input type="text" id="examLinkInput" value="${shortUrl}" readonly onclick="this.select()" 
                                style="color: var(--success); font-size: 1rem; font-weight: 600;">
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-primary" onclick="copyExamLink()" style="flex: 1;">
                                üìã Copy Short Link
                            </button>
                            <button class="btn btn-secondary" onclick="closeModal()">
                                Done
                            </button>
                        </div>
                    `;
                    createConfetti();
                } else {
                    throw new Error('Could not shorten');
                }
            } catch (e) {
                body.innerHTML = `
                    <div class="success-animation">
                        <div class="checkmark" style="background: var(--warning);">‚ö†Ô∏è</div>
                        <h3>URL Shortening Unavailable</h3>
                        <p style="color: var(--text-secondary);">Use the original link or try an external shortener</p>
                    </div>
                    
                    <div class="link-display">
                        <input type="text" id="examLinkInput" value="${longUrl}" readonly onclick="this.select()">
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="copyExamLink()" style="flex: 1;">
                            üìã Copy Link
                        </button>
                        <button class="btn btn-secondary" onclick="closeModal()">
                            Done
                        </button>
                    </div>
                    
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(6, 182, 212, 0.1); border: 1px solid var(--accent); border-radius: var(--radius-md);">
                        <p style="color: var(--accent); font-size: 0.875rem;">
                            üí° Copy the link and paste it into <a href="https://tinyurl.com" target="_blank" style="color: var(--primary); font-weight: 600;">TinyURL.com</a> to shorten it manually.
                        </p>
                    </div>
                `;
            }
        }
        
        function copyExamLink() {
            const input = document.getElementById('examLinkInput');
            input.select();
            input.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(input.value).then(() => {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úì Copied!';
                btn.style.background = 'var(--success)';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            });
        }
        
        // ==================== STUDENT VIEW ====================
        function renderStudentExam() {
            // Decode compressed exam format
            const exam = currentExamData;
            
            // Handle both old and new format
            const examTitle = exam.title || exam.t || 'Exam';
            const examQuestions = exam.questions || exam.q || {};
            const telegramId = exam.telegramChatId || exam.c || '';
            
            // Store normalized data
            currentExamData = {
                id: exam.id,
                title: examTitle,
                questions: examQuestions,
                telegramChatId: telegramId
            };
            
            if (!currentExamData) {
                renderExamNotFound();
                return;
            }
            
            const container = document.getElementById('mainContainer');
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <button class="btn btn-icon" onclick="toggleTheme()" title="Toggle Theme" id="studentThemeBtn">
                        ${document.body.classList.contains('light-theme') ? 'üåô' : '‚òÄÔ∏è'}
                    </button>
                </div>
                <div class="student-header">
                    <h2>${currentExamData.title}</h2>
                    <p>Enter your name to begin the exam</p>
                </div>
                
                <div class="student-name-input">
                    <div class="form-group">
                        <label style="text-align: center; font-size: 1rem;">Your Name</label>
                        <input type="text" id="studentNameInput" placeholder="Enter your full name" autofocus>
                    </div>
                    <button class="btn btn-gradient" onclick="startExam()" style="width: 100%; margin-top: 1rem; font-size: 1.125rem; padding: 1.25rem;">
                        Start Exam ‚Üí
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 2rem; color: var(--text-secondary);">
                    <p>You can change your answers before submitting.</p>
                    <p style="color: var(--warning); font-weight: 500; margin-top: 0.5rem;">‚ö†Ô∏è You can only submit once!</p>
                </div>
            `;
            
            document.getElementById('studentNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') startExam();
            });
        }
        
        function startExam() {
            const name = document.getElementById('studentNameInput').value.trim();
            if (!name) {
                alert('Please enter your name to start the exam');
                return;
            }
            
            // Check if this student already submitted
            const submissionKey = `${currentExamId}_${name.toLowerCase()}`;
            if (submissionsData[submissionKey]) {
                const prev = submissionsData[submissionKey];
                alert(`You have already submitted this exam!\n\nYour previous score: ${prev.score}/${prev.total} (${prev.percentage}%)`);
                return;
            }
            
            studentName = name;
            studentAnswers = {
                fillBlank: {},
                trueFalse: {},
                matchWords: {},
                relatedWords: {},
                sentenceArrange: {},
                listeningQuiz: {}
            };
            renderStudentQuestions(currentExamData);
        }
        
        function renderStudentQuestions(exam) {
            const container = document.getElementById('mainContainer');
            
            let totalQuestions = 0;
            let sectionsHtml = '';
            let questionNum = 0;
            
            // Fill in the Blank
            if (exam.questions.fillBlank && exam.questions.fillBlank.length > 0) {
                totalQuestions += exam.questions.fillBlank.length;
                sectionsHtml += `
                    <h3 style="margin: 2rem 0 1rem; display: flex; align-items: center; gap: 0.625rem;">
                        <span style="background: var(--gradient-primary); padding: 0.5rem 1rem; border-radius: var(--radius-md); color: white;">üìù</span>
                        Fill in the Blank
                    </h3>
                    <p style="color: var(--accent); font-size: 0.875rem; margin-bottom: 1rem;">Click on a filled blank to change your answer</p>
                `;
                exam.questions.fillBlank.forEach((q, i) => {
                    questionNum++;
                    const options = [q.blankWord, ...q.options];
                    // Fisher-Yates shuffle
                    for (let i = options.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [options[i], options[j]] = [options[j], options[i]];
                    }
                    sectionsHtml += `
                        <div class="quiz-question-card" id="studentQ-fillBlank-${i}">
                            <p class="question-text">
                                <strong>Q${questionNum}.</strong> ${q.sentence.replace('[BLANK]', `<span class="blank-space" id="blank-fb-${i}" onclick="clearFillBlank(${i})">???</span>`)}
                            </p>
                            <div class="options-grid" id="opts-fb-${i}">
                                ${options.map((opt, oi) => `
                                    <button class="option-btn" onclick="selectStudentAnswer('fillBlank', ${i}, '${opt.replace(/'/g, "\\'")}')" 
                                        id="opt-fb-${i}-${oi}">${opt}</button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
            }
            
            // True/False
            if (exam.questions.trueFalse && exam.questions.trueFalse.length > 0) {
                totalQuestions += exam.questions.trueFalse.length;
                sectionsHtml += `
                    <h3 style="margin: 2rem 0 1rem; display: flex; align-items: center; gap: 0.625rem;">
                        <span style="background: var(--gradient-success); padding: 0.5rem 1rem; border-radius: var(--radius-md); color: white;">‚úì‚úó</span>
                        True or False
                    </h3>
                `;
                exam.questions.trueFalse.forEach((q, i) => {
                    questionNum++;
                    sectionsHtml += `
                        <div class="quiz-question-card" id="studentQ-trueFalse-${i}">
                            <p class="question-text"><strong>Q${questionNum}.</strong> ${q.statement}</p>
                            <div class="tf-buttons">
                                <button class="tf-btn true" id="tf-true-${i}" onclick="selectStudentAnswer('trueFalse', ${i}, true)">
                                    TRUE
                                </button>
                                <button class="tf-btn false" id="tf-false-${i}" onclick="selectStudentAnswer('trueFalse', ${i}, false)">
                                    FALSE
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            // Match Words
            if (exam.questions.matchWords && exam.questions.matchWords.length > 0) {
                totalQuestions += exam.questions.matchWords.length;
                const leftWords = exam.questions.matchWords.map((p, i) => ({ word: p.word1, idx: i }));
                const rightWords = exam.questions.matchWords.map((p, i) => ({ word: p.word2, idx: i }));
                // Fisher-Yates shuffle for both columns
                for (let i = leftWords.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [leftWords[i], leftWords[j]] = [leftWords[j], leftWords[i]];
                }
                for (let i = rightWords.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [rightWords[i], rightWords[j]] = [rightWords[j], rightWords[i]];
                }
                
                sectionsHtml += `
                    <h3 style="margin: 2rem 0 1rem; display: flex; align-items: center; gap: 0.625rem;">
                        <span style="background: var(--gradient-accent); padding: 0.5rem 1rem; border-radius: var(--radius-md); color: #1e293b;">üîó</span>
                        Match the Words
                    </h3>
                    <p style="color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.875rem;">Click a word from each column to match them. Click a matched pair to unmatch.</p>
                    <div class="quiz-question-card">
                        <div class="match-container">
                            <div class="match-column">
                                <h4>Column A</h4>
                                ${leftWords.map(w => `
                                    <button class="option-btn" style="width: 100%; margin-bottom: 0.5rem;"
                                        id="match-left-${w.idx}" data-idx="${w.idx}" data-side="left"
                                        onclick="selectMatchStudent(this, ${w.idx}, 'left')">${w.word}</button>
                                `).join('')}
                            </div>
                            <div class="match-column">
                                <h4>Column B</h4>
                                ${rightWords.map(w => `
                                    <button class="option-btn" style="width: 100%; margin-bottom: 0.5rem;"
                                        id="match-right-${w.idx}" data-idx="${w.idx}" data-side="right"
                                        onclick="selectMatchStudent(this, ${w.idx}, 'right')">${w.word}</button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Related Words (Picture Match) - with decoy words support
            if (exam.questions.relatedWords && exam.questions.relatedWords.length > 0) {
                let allWords = [];
                exam.questions.relatedWords.forEach((cat, catIdx) => {
                    cat.words.forEach(word => {
                        allWords.push({ word, catIdx, isDecoy: false });
                    });
                });
                
                // Add decoy words (they don't belong to any category)
                const decoyWords = exam.questions.decoyWords || [];
                decoyWords.forEach(word => {
                    allWords.push({ word, catIdx: -1, isDecoy: true });
                });
                
                // Only count real words for total (not decoys)
                totalQuestions += allWords.filter(w => !w.isDecoy).length;
                // Fisher-Yates shuffle for truly random order
                for (let i = allWords.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allWords[i], allWords[j]] = [allWords[j], allWords[i]];
                }
                
                sectionsHtml += `
                    <h3 style="margin: 2rem 0 1rem; display: flex; align-items: center; gap: 0.625rem;">
                        <span style="background: var(--gradient-secondary); padding: 0.5rem 1rem; border-radius: var(--radius-md); color: white;">üìÅ</span>
                        Category Word Match
                    </h3>
                    <p style="color: var(--accent); text-align: center; margin-bottom: 1rem; font-size: 0.9rem;" id="picMatchInstruction">
                        Click a word, then click the category it belongs to
                    </p>
                    ${decoyWords.length > 0 ? `<p style="color: var(--warning); text-align: center; font-size: 0.875rem; margin-bottom: 1rem; padding: 0.75rem; background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-md); border: 1px solid rgba(245, 158, 11, 0.3);">
                        ‚ö†Ô∏è <strong>Warning:</strong> Some words don't belong to any category!<br>
                        <span style="font-size: 0.8125rem;">Leave fake words in the word bank. Placing them in a category will be marked wrong!</span>
                    </p>` : ''}
                    <div class="quiz-question-card">
                        <div class="match-container" style="flex-wrap: wrap; justify-content: center;">
                            ${exam.questions.relatedWords.map((cat, catIdx) => `
                                <div class="match-column" style="min-width: 150px; flex: 1;">
                                    <div class="image-drop-zone" id="picCat-${catIdx}" data-catidx="${catIdx}"
                                        onclick="selectPicCategory(${catIdx})">
                                        <h5>${cat.name}</h5>
                                        <div class="dropped-words" id="picDropped-${catIdx}"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <h4 style="margin: 1.5rem 0 0.75rem; color: var(--text-muted); font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.05em;">Word Bank</h4>
                        <div class="word-bank" id="picWordBank">
                            ${allWords.map((w, wi) => `
                                <span class="word-chip" id="picWord-${wi}" data-wordidx="${wi}" data-catidx="${w.catIdx}" data-isdecoy="${w.isDecoy}"
                                    onclick="selectPicWord(${wi}, ${w.catIdx}, ${w.isDecoy})">${w.word}</span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Sentence Arrange Quiz
            if (exam.questions.sentenceArrange && exam.questions.sentenceArrange.length > 0) {
                totalQuestions += exam.questions.sentenceArrange.length;
                sectionsHtml += `
                    <h3 style="margin: 2rem 0 1rem; display: flex; align-items: center; gap: 0.625rem;">
                        <span style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); padding: 0.5rem 1rem; border-radius: var(--radius-md); color: white;">üîÄ</span>
                        Arrange the Sentence
                    </h3>
                    <p style="color: var(--accent); font-size: 0.875rem; margin-bottom: 1rem;">Click words in the correct order to form the sentence. Click a placed word to remove it.</p>
                `;
                exam.questions.sentenceArrange.forEach((q, i) => {
                    questionNum++;
                    const words = q.sentence.split(/\s+/).filter(w => w);
                    // Shuffle words
                    const shuffled = [...words];
                    for (let j = shuffled.length - 1; j > 0; j--) {
                        const k = Math.floor(Math.random() * (j + 1));
                        [shuffled[j], shuffled[k]] = [shuffled[k], shuffled[j]];
                    }
                    sectionsHtml += `
                        <div class="quiz-question-card" id="studentQ-sentenceArrange-${i}" data-correct="${words.join(' ')}">
                            <p class="question-text"><strong>Q${questionNum}.</strong> Arrange the words to form a correct sentence:</p>
                            <div class="word-bank" id="saDropZone-${i}" style="min-height: 50px; margin-bottom: 1rem; border: 2px dashed var(--border); border-radius: var(--radius-md); padding: 0.75rem;">
                                <span style="color: var(--text-muted); font-size: 0.875rem;" id="saPlaceholder-${i}">Your sentence will appear here...</span>
                            </div>
                            <div class="word-bank" id="saWordBank-${i}">
                                ${shuffled.map((word, wi) => `
                                    <span class="word-chip" id="saWord-${i}-${wi}" data-word="${word}" data-qidx="${i}"
                                        onclick="selectSentenceWord(${i}, ${wi}, '${word.replace(/'/g, "\\'")}')">${word}</span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
            }
            
            // Listening Quiz
            if (exam.questions.listeningQuiz && exam.questions.listeningQuiz.length > 0) {
                totalQuestions += exam.questions.listeningQuiz.length;
                sectionsHtml += `
                    <h3 style="margin: 2rem 0 1rem; display: flex; align-items: center; gap: 0.625rem;">
                        <span style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%); padding: 0.5rem 1rem; border-radius: var(--radius-md); color: white;">üéß</span>
                        Listening Quiz
                    </h3>
                    <p style="color: var(--accent); font-size: 0.875rem; margin-bottom: 1rem;">Listen to the word and select the correct answer</p>
                `;
                exam.questions.listeningQuiz.forEach((q, i) => {
                    questionNum++;
                    const options = [q.correctWord, ...q.wrongOptions];
                    // Shuffle options
                    for (let j = options.length - 1; j > 0; j--) {
                        const k = Math.floor(Math.random() * (j + 1));
                        [options[j], options[k]] = [options[k], options[j]];
                    }
                    sectionsHtml += `
                        <div class="quiz-question-card" id="studentQ-listeningQuiz-${i}">
                            <p class="question-text"><strong>Q${questionNum}.</strong> Listen to the word and select the correct answer:</p>
                            <button class="btn btn-primary" onclick="playListeningWord(${i}, '${q.correctWord.replace(/'/g, "\\'")}')" style="margin: 1rem 0;">
                                üîä Play Sound
                            </button>
                            <div class="options-grid" id="lqOpts-${i}">
                                ${options.map((opt, oi) => `
                                    <button class="option-btn" onclick="selectListeningAnswer(${i}, '${opt.replace(/'/g, "\\'")}', '${q.correctWord.replace(/'/g, "\\'")}')" 
                                        id="lqOpt-${i}-${oi}">${opt}</button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <button class="btn btn-icon" onclick="toggleTheme(); updateStudentThemeBtn()" title="Toggle Theme" id="studentThemeBtn">
                        ${document.body.classList.contains('light-theme') ? 'üåô' : '‚òÄÔ∏è'}
                    </button>
                </div>
                <div class="student-header">
                    <h2>${exam.title}</h2>
                    <p>Good luck, ${studentName}!</p>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <p style="text-align: center; color: var(--text-muted); margin-bottom: 2rem; font-size: 0.9rem;" id="progressText">
                    0 of ${totalQuestions} questions answered
                </p>
                
                ${sectionsHtml}
                
                <div style="margin-top: 3rem; padding: 2rem; background: var(--bg-card); border-radius: var(--radius-xl); text-align: center; border: 1px solid var(--border);">
                    <p style="margin-bottom: 0.5rem; color: var(--text-secondary);">
                        Review your answers above before submitting.
                    </p>
                    <p style="margin-bottom: 1.5rem; color: var(--warning); font-weight: 600;">
                        ‚ö†Ô∏è You can only submit once!
                    </p>
                    <button class="btn btn-gradient" onclick="confirmSubmitExam()" style="font-size: 1.125rem; padding: 1.25rem 3rem;">
                        Submit Exam
                    </button>
                </div>
            `;
            
            window.totalQuestions = totalQuestions;
        }
        
        function updateStudentThemeBtn() {
            const btn = document.getElementById('studentThemeBtn');
            if (btn) {
                btn.textContent = document.body.classList.contains('light-theme') ? 'üåô' : '‚òÄÔ∏è';
            }
        }
        
        // Clear fill in the blank
        function clearFillBlank(index) {
            if (studentAnswers.fillBlank[index] !== undefined) {
                const blank = document.getElementById(`blank-fb-${index}`);
                blank.textContent = '???';
                blank.classList.remove('filled');
                
                const card = document.getElementById(`studentQ-fillBlank-${index}`);
                card.classList.remove('answered');
                card.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                
                delete studentAnswers.fillBlank[index];
                updateProgress();
            }
        }
        
        function selectStudentAnswer(type, index, value) {
            if (type === 'fillBlank') {
                studentAnswers[type][index] = value;
                
                const blank = document.getElementById(`blank-fb-${index}`);
                if (blank) {
                    blank.textContent = value;
                    blank.classList.add('filled');
                }
                const card = document.getElementById(`studentQ-fillBlank-${index}`);
                card.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                card.querySelectorAll('.option-btn').forEach(btn => {
                    if (btn.textContent === value) btn.classList.add('selected');
                });
                card.classList.add('answered');
            } else if (type === 'trueFalse') {
                if (studentAnswers[type][index] === value) {
                    delete studentAnswers[type][index];
                    const trueBtn = document.getElementById(`tf-true-${index}`);
                    const falseBtn = document.getElementById(`tf-false-${index}`);
                    const card = document.getElementById(`studentQ-trueFalse-${index}`);
                    trueBtn.classList.remove('selected');
                    falseBtn.classList.remove('selected');
                    card.classList.remove('answered');
                } else {
                    studentAnswers[type][index] = value;
                    const trueBtn = document.getElementById(`tf-true-${index}`);
                    const falseBtn = document.getElementById(`tf-false-${index}`);
                    const card = document.getElementById(`studentQ-trueFalse-${index}`);
                    
                    trueBtn.classList.remove('selected');
                    falseBtn.classList.remove('selected');
                    
                    if (value === true) {
                        trueBtn.classList.add('selected');
                    } else {
                        falseBtn.classList.add('selected');
                    }
                    card.classList.add('answered');
                }
            }
            
            updateProgress();
        }
        
        // Match Words Student Logic
        let selectedMatchStudent = null;
        let matchedPairs = {};
        let usedColorIndices = [];
        
        const matchPairColors = [
            { bg: '#6366f1', border: '#4f46e5' },
            { bg: '#ec4899', border: '#db2777' },
            { bg: '#06b6d4', border: '#0891b2' },
            { bg: '#f59e0b', border: '#d97706' },
            { bg: '#10b981', border: '#059669' },
            { bg: '#f97316', border: '#ea580c' },
            { bg: '#ef4444', border: '#dc2626' },
            { bg: '#8b5cf6', border: '#7c3aed' },
            { bg: '#14b8a6', border: '#0d9488' },
            { bg: '#a855f7', border: '#9333ea' },
        ];
        
        function getNextColorIndex() {
            for (let i = 0; i < matchPairColors.length; i++) {
                if (!usedColorIndices.includes(i)) {
                    return i;
                }
            }
            return 0;
        }
        
        function selectMatchStudent(element, idx, side) {
            if (element.classList.contains('matched')) {
                unmatchWord(element, idx, side);
                return;
            }
            
            if (!selectedMatchStudent) {
                selectedMatchStudent = { element, idx, side };
                element.classList.add('selected');
                return;
            }
            
            if (selectedMatchStudent.side === side) {
                selectedMatchStudent.element.classList.remove('selected');
                selectedMatchStudent = { element, idx, side };
                element.classList.add('selected');
                return;
            }
            
            const leftIdx = side === 'left' ? idx : selectedMatchStudent.idx;
            const rightIdx = side === 'right' ? idx : selectedMatchStudent.idx;
            const leftEl = side === 'left' ? element : selectedMatchStudent.element;
            const rightEl = side === 'right' ? element : selectedMatchStudent.element;
            
            const colorIdx = getNextColorIndex();
            usedColorIndices.push(colorIdx);
            const color = matchPairColors[colorIdx];
            
            studentAnswers.matchWords[leftIdx] = rightIdx;
            matchedPairs[leftIdx] = { leftEl, rightEl, rightIdx, colorIdx };
            
            leftEl.classList.remove('selected');
            rightEl.classList.remove('selected');
            leftEl.classList.add('matched');
            rightEl.classList.add('matched');
            
            leftEl.style.background = color.bg;
            leftEl.style.borderColor = color.border;
            leftEl.style.color = 'white';
            rightEl.style.background = color.bg;
            rightEl.style.borderColor = color.border;
            rightEl.style.color = 'white';
            
            selectedMatchStudent = null;
            updateProgress();
        }
        
        function unmatchWord(element, idx, side) {
            let leftIdx = null;
            
            if (side === 'left') {
                leftIdx = idx;
            } else {
                for (const [lIdx, pair] of Object.entries(matchedPairs)) {
                    if (pair.rightIdx === idx) {
                        leftIdx = parseInt(lIdx);
                        break;
                    }
                }
            }
            
            if (leftIdx !== null && matchedPairs[leftIdx]) {
                const pair = matchedPairs[leftIdx];
                const colorIdx = pair.colorIdx;
                usedColorIndices = usedColorIndices.filter(c => c !== colorIdx);
                
                pair.leftEl.classList.remove('matched', 'selected');
                pair.rightEl.classList.remove('matched', 'selected');
                pair.leftEl.style.background = '';
                pair.leftEl.style.borderColor = '';
                pair.leftEl.style.color = '';
                pair.rightEl.style.background = '';
                pair.rightEl.style.borderColor = '';
                pair.rightEl.style.color = '';
                
                delete studentAnswers.matchWords[leftIdx];
                delete matchedPairs[leftIdx];
                
                updateProgress();
            }
        }
        
        // Picture Match Student Logic
        let selectedPicWordStudent = null;
        let placedPicWords = {};
        
        function selectPicWord(wordIdx, correctCatIdx, isDecoy) {
            document.querySelectorAll('#picWordBank .word-chip').forEach(chip => chip.classList.remove('selected'));
            
            const wordEl = document.getElementById(`picWord-${wordIdx}`);
            wordEl.classList.add('selected');
            selectedPicWordStudent = { wordIdx, correctCatIdx, element: wordEl, isDecoy };
            
            document.querySelectorAll('.image-drop-zone').forEach(zone => zone.classList.add('selectable'));
            
            document.getElementById('picMatchInstruction').textContent = 'Now click the category for this word';
            document.getElementById('picMatchInstruction').style.color = 'var(--accent)';
        }
        
        function returnPicWord(wordIdx) {
            const placed = placedPicWords[wordIdx];
            if (!placed) return;
            
            if (studentAnswers.relatedWords[placed.catIdx]) {
                studentAnswers.relatedWords[placed.catIdx] = studentAnswers.relatedWords[placed.catIdx].filter(
                    w => w.wordIdx !== wordIdx
                );
            }
            
            placed.element.remove();
            placed.originalEl.style.display = 'inline-block';
            
            delete placedPicWords[wordIdx];
            
            document.getElementById('picMatchInstruction').textContent = 'Word returned! Click a word to place it again';
            document.getElementById('picMatchInstruction').style.color = 'var(--accent)';
            
            updateProgress();
        }
        
        function selectPicCategory(catIdx) {
            if (!selectedPicWordStudent) {
                document.getElementById('picMatchInstruction').textContent = 'First, click a word from the word bank below!';
                document.getElementById('picMatchInstruction').style.color = 'var(--warning)';
                return;
            }
            
            const wordEl = selectedPicWordStudent.element;
            const dropZone = document.getElementById(`picDropped-${catIdx}`);
            const wordIdx = selectedPicWordStudent.wordIdx;
            const isDecoy = selectedPicWordStudent.isDecoy;
            
            if (!studentAnswers.relatedWords[catIdx]) studentAnswers.relatedWords[catIdx] = [];
            studentAnswers.relatedWords[catIdx].push({
                wordIdx: wordIdx,
                word: wordEl.textContent,
                correctCatIdx: selectedPicWordStudent.correctCatIdx,
                isDecoy: isDecoy
            });
            
            const newWord = document.createElement('span');
            newWord.className = 'word-chip placed-word';
            newWord.textContent = wordEl.textContent;
            newWord.style.cursor = 'pointer';
            newWord.title = 'Click to return this word';
            newWord.onclick = () => returnPicWord(wordIdx);
            dropZone.appendChild(newWord);
            
            placedPicWords[wordIdx] = {
                catIdx: catIdx,
                element: newWord,
                originalEl: wordEl,
                word: wordEl.textContent,
                correctCatIdx: selectedPicWordStudent.correctCatIdx,
                isDecoy: isDecoy
            };
            
            wordEl.style.display = 'none';
            
            document.querySelectorAll('.image-drop-zone').forEach(zone => zone.classList.remove('selectable'));
            selectedPicWordStudent = null;
            
            document.getElementById('picMatchInstruction').textContent = 'Great! Select another word or submit when ready';
            document.getElementById('picMatchInstruction').style.color = 'var(--success)';
            
            updateProgress();
        }
        
        // ==================== SENTENCE ARRANGE QUIZ ====================
        function selectSentenceWord(questionIdx, wordIdx, word) {
            const wordEl = document.getElementById(`saWord-${questionIdx}-${wordIdx}`);
            const dropZone = document.getElementById(`saDropZone-${questionIdx}`);
            const placeholder = document.getElementById(`saPlaceholder-${questionIdx}`);
            const card = document.getElementById(`studentQ-sentenceArrange-${questionIdx}`);
            
            // If word is already placed, return it to word bank
            if (wordEl.classList.contains('placed')) {
                wordEl.classList.remove('placed');
                wordEl.style.display = 'inline-block';
                
                // Remove from drop zone
                const placedWord = dropZone.querySelector(`[data-source-id="saWord-${questionIdx}-${wordIdx}"]`);
                if (placedWord) placedWord.remove();
                
                // Update answer
                rebuildSentenceAnswer(questionIdx);
                return;
            }
            
            // Hide placeholder
            if (placeholder) placeholder.style.display = 'none';
            
            // Create placed word in drop zone
            const placedWord = document.createElement('span');
            placedWord.className = 'word-chip placed-word';
            placedWord.textContent = word;
            placedWord.setAttribute('data-source-id', `saWord-${questionIdx}-${wordIdx}`);
            placedWord.setAttribute('data-word', word);
            placedWord.onclick = function() {
                // Click to remove
                this.remove();
                wordEl.classList.remove('placed');
                wordEl.style.display = 'inline-block';
                rebuildSentenceAnswer(questionIdx);
            };
            dropZone.appendChild(placedWord);
            
            // Hide original word
            wordEl.classList.add('placed');
            wordEl.style.display = 'none';
            
            // Update answer
            rebuildSentenceAnswer(questionIdx);
            
            // Mark card as answered if all words placed
            const wordBank = document.getElementById(`saWordBank-${questionIdx}`);
            const remainingWords = wordBank.querySelectorAll('.word-chip:not(.placed)');
            if (remainingWords.length === 0) {
                card.classList.add('answered');
            } else {
                card.classList.remove('answered');
            }
            
            updateProgress();
        }
        
        function rebuildSentenceAnswer(questionIdx) {
            const dropZone = document.getElementById(`saDropZone-${questionIdx}`);
            const placeholder = document.getElementById(`saPlaceholder-${questionIdx}`);
            const placedWords = dropZone.querySelectorAll('.placed-word');
            
            if (placedWords.length === 0) {
                if (placeholder) placeholder.style.display = 'inline';
                delete studentAnswers.sentenceArrange[questionIdx];
            } else {
                const sentence = Array.from(placedWords).map(w => w.getAttribute('data-word')).join(' ');
                studentAnswers.sentenceArrange[questionIdx] = sentence;
            }
            
            updateProgress();
        }
        
        // ==================== LISTENING QUIZ ====================
        // Pre-load voices for speech synthesis
        let speechVoices = [];
        if ('speechSynthesis' in window) {
            // Load voices
            speechVoices = window.speechSynthesis.getVoices();
            // Some browsers load voices asynchronously
            window.speechSynthesis.onvoiceschanged = function() {
                speechVoices = window.speechSynthesis.getVoices();
            };
        }
        
        function playListeningWord(questionIdx, word) {
            // Use Web Speech API to speak the word
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'ar-SA'; // Arabic (Saudi Arabia)
                utterance.rate = 0.8; // Slightly slower for clarity
                utterance.pitch = 1;
                utterance.volume = 1;
                
                // Try to find an Arabic voice
                const voices = speechVoices.length > 0 ? speechVoices : window.speechSynthesis.getVoices();
                const arabicVoice = voices.find(v => v.lang.startsWith('ar'));
                if (arabicVoice) {
                    utterance.voice = arabicVoice;
                }
                
                window.speechSynthesis.speak(utterance);
            } else {
                alert('Sorry, your browser does not support text-to-speech. Please use a modern browser like Chrome or Edge.');
            }
        }
        
        function selectListeningAnswer(questionIdx, selectedWord, correctWord) {
            const card = document.getElementById(`studentQ-listeningQuiz-${questionIdx}`);
            const optionsContainer = document.getElementById(`lqOpts-${questionIdx}`);
            
            // Remove previous selection
            optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Find and mark selected button
            optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
                if (btn.textContent === selectedWord) {
                    btn.classList.add('selected');
                }
            });
            
            // Store answer
            studentAnswers.listeningQuiz[questionIdx] = {
                selected: selectedWord,
                correct: correctWord
            };
            
            // Mark as answered
            card.classList.add('answered');
            
            updateProgress();
        }
        
        function updateProgress() {
            let answered = 0;
            
            answered += Object.keys(studentAnswers.fillBlank).length;
            answered += Object.keys(studentAnswers.trueFalse).length;
            answered += Object.keys(studentAnswers.matchWords).length;
            answered += Object.keys(studentAnswers.sentenceArrange).length;
            answered += Object.keys(studentAnswers.listeningQuiz).length;
            
            // Only count non-decoy placed words
            for (const [wordIdx, placed] of Object.entries(placedPicWords)) {
                if (!placed.isDecoy) {
                    answered++;
                }
            }
            
            const total = window.totalQuestions || 1;
            const percent = Math.round((answered / total) * 100);
            
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${answered} of ${total} questions answered`;
        }
        
        function confirmSubmitExam() {
            if (!confirm('Are you sure you want to submit? You cannot change your answers after submission!')) {
                return;
            }
            submitExam();
        }
        
        function submitExam() {
            const exam = currentExamData;
            let correct = 0;
            let total = 0;
            let details = [];
            
            // Grade Fill in the Blank
            if (exam.questions.fillBlank) {
                exam.questions.fillBlank.forEach((q, i) => {
                    total++;
                    const answer = studentAnswers.fillBlank[i];
                    const isCorrect = answer && answer.toLowerCase() === q.blankWord.toLowerCase();
                    if (isCorrect) correct++;
                    details.push({
                        type: 'Fill Blank',
                        question: q.sentence,
                        studentAnswer: answer || '(no answer)',
                        correctAnswer: q.blankWord,
                        isCorrect
                    });
                });
            }
            
            // Grade True/False
            if (exam.questions.trueFalse) {
                exam.questions.trueFalse.forEach((q, i) => {
                    total++;
                    const answer = studentAnswers.trueFalse[i];
                    const isCorrect = answer === q.isTrue;
                    if (isCorrect) correct++;
                    details.push({
                        type: 'True/False',
                        question: q.statement,
                        studentAnswer: answer === undefined ? '(no answer)' : (answer ? 'True' : 'False'),
                        correctAnswer: q.isTrue ? 'True' : 'False',
                        isCorrect
                    });
                });
            }
            
            // Grade Match Words
            if (exam.questions.matchWords) {
                exam.questions.matchWords.forEach((q, i) => {
                    total++;
                    const matchedRightIdx = studentAnswers.matchWords[i];
                    const isCorrect = matchedRightIdx === i;
                    if (isCorrect) correct++;
                    
                    let studentAnswer = '(no match)';
                    if (matchedRightIdx !== undefined) {
                        studentAnswer = exam.questions.matchWords[matchedRightIdx]?.word2 || '(invalid)';
                    }
                    
                    details.push({
                        type: 'Match',
                        question: q.word1,
                        studentAnswer: studentAnswer,
                        correctAnswer: q.word2,
                        isCorrect
                    });
                });
            }
            
            // Grade Picture Match (including penalty for placing decoys)
            if (exam.questions.relatedWords) {
                // Check placed non-decoy words
                for (const [wordIdx, placed] of Object.entries(placedPicWords)) {
                    if (!placed.isDecoy) {
                        total++;
                        const isCorrect = placed.catIdx === placed.correctCatIdx;
                        if (isCorrect) correct++;
                        
                        const placedCatName = exam.questions.relatedWords[placed.catIdx]?.name || '(unknown)';
                        const correctCatName = exam.questions.relatedWords[placed.correctCatIdx]?.name || '(unknown)';
                        
                        details.push({
                            type: 'Picture Match',
                            question: placed.word,
                            studentAnswer: placedCatName,
                            correctAnswer: correctCatName,
                            isCorrect
                        });
                    } else {
                        // DECOY WORD WAS PLACED IN A CATEGORY - THIS IS WRONG!
                        // Decoy words should be left in the word bank
                        total++;
                        const placedCatName = exam.questions.relatedWords[placed.catIdx]?.name || '(unknown)';
                        
                        details.push({
                            type: 'Picture Match (Decoy)',
                            question: placed.word,
                            studentAnswer: `Placed in "${placedCatName}"`,
                            correctAnswer: 'Should be left in word bank (decoy word)',
                            isCorrect: false
                        });
                    }
                }
                
                // Count unplaced non-decoy words as wrong
                exam.questions.relatedWords.forEach((cat, catIdx) => {
                    cat.words.forEach(word => {
                        const wasPlaced = Object.values(placedPicWords).some(p => p.word === word && !p.isDecoy);
                        if (!wasPlaced) {
                            total++;
                            details.push({
                                type: 'Picture Match',
                                question: word,
                                studentAnswer: '(not placed)',
                                correctAnswer: cat.name,
                                isCorrect: false
                            });
                        }
                    });
                });
                
                // Reward for correctly leaving decoys in word bank
                const decoyWords = exam.questions.decoyWords || [];
                decoyWords.forEach(decoyWord => {
                    const wasPlaced = Object.values(placedPicWords).some(p => p.word === decoyWord && p.isDecoy);
                    if (!wasPlaced) {
                        // Student correctly left the decoy in the word bank!
                        total++;
                        correct++;
                        details.push({
                            type: 'Picture Match (Decoy)',
                            question: decoyWord,
                            studentAnswer: 'Left in word bank',
                            correctAnswer: 'Left in word bank (decoy word)',
                            isCorrect: true
                        });
                    }
                });
            }
            
            // Grade Sentence Arrange
            if (exam.questions.sentenceArrange && exam.questions.sentenceArrange.length > 0) {
                exam.questions.sentenceArrange.forEach((q, i) => {
                    total++;
                    const studentSentence = studentAnswers.sentenceArrange[i] || '';
                    const correctSentence = q.sentence.trim();
                    const isCorrect = studentSentence.trim() === correctSentence;
                    if (isCorrect) correct++;
                    details.push({
                        type: 'Arrange Sentence',
                        question: 'Arrange: ' + correctSentence.split(/\s+/).slice(0, 3).join(' ') + '...',
                        studentAnswer: studentSentence || '(no answer)',
                        correctAnswer: correctSentence,
                        isCorrect
                    });
                });
            }
            
            // Grade Listening Quiz
            if (exam.questions.listeningQuiz && exam.questions.listeningQuiz.length > 0) {
                exam.questions.listeningQuiz.forEach((q, i) => {
                    total++;
                    const answer = studentAnswers.listeningQuiz[i];
                    const isCorrect = answer && answer.selected === q.correctWord;
                    if (isCorrect) correct++;
                    details.push({
                        type: 'Listening',
                        question: 'üîä (audio word)',
                        studentAnswer: answer?.selected || '(no answer)',
                        correctAnswer: q.correctWord,
                        isCorrect
                    });
                });
            }
            
            const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
            
            // Save submission
            const submissionKey = `${currentExamId}_${studentName.toLowerCase()}`;
            submissionsData[submissionKey] = {
                name: studentName,
                score: correct,
                total: total,
                percentage: percentage,
                submittedAt: new Date().toISOString()
            };
            saveSubmissions();
            
            // Send to Telegram
            sendResultsToTelegram(exam.title, studentName, correct, total, percentage, details);
            
            // Show results
            showResults(exam.title, correct, total, percentage, details);
        }
        
        function sendResultsToTelegram(examTitle, name, correct, total, percentage, details) {
            const chatId = currentExamData?.telegramChatId || TELEGRAM_CHAT_ID;
            if (!chatId) {
                console.log('No Telegram Chat ID configured');
                return;
            }
            
            let gradeEmoji = '';
            if (percentage >= 90) gradeEmoji = 'üåü Excellent!';
            else if (percentage >= 70) gradeEmoji = '‚úÖ Good job!';
            else if (percentage >= 50) gradeEmoji = '‚ö†Ô∏è Needs improvement';
            else gradeEmoji = '‚ùå Needs more practice';
            
            let message = `üìù *EXAM SUBMISSION*\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            message += `üìö *Exam:* ${examTitle}\n`;
            message += `üë§ *Student:* ${name}\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            
            message += `üéØ *GRADE: ${percentage}%* ${gradeEmoji}\n`;
            message += `üìä *Score:* ${correct} / ${total}\n\n`;
            
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            message += `üìã *DETAILED ANSWERS:*\n`;
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            
            details.forEach((d, i) => {
                const icon = d.isCorrect ? '‚úì' : '‚úó';
                message += `${i + 1}. [${d.type}] ${icon}\n`;
                message += `   Q: ${d.question.substring(0, 50)}${d.question.length > 50 ? '...' : ''}\n`;
                message += `   Student: ${d.studentAnswer}\n`;
                if (!d.isCorrect) {
                    message += `   Correct: ${d.correctAnswer}\n`;
                }
                message += `\n`;
            });
            
            message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            message += `‚è∞ Submitted: ${new Date().toLocaleString()}`;
            
            fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: message,
                    parse_mode: 'Markdown'
                })
            }).catch(err => console.error('Telegram error:', err));
        }
        
        function showResults(examTitle, correct, total, percentage, details) {
            const container = document.getElementById('mainContainer');
            
            let gradeClass = 'success';
            let gradeText = 'Excellent!';
            if (percentage < 90) { gradeClass = 'success'; gradeText = 'Good Job!'; }
            if (percentage < 70) { gradeClass = 'warning'; gradeText = 'Keep Practicing!'; }
            if (percentage < 50) { gradeClass = 'error'; gradeText = 'Needs Improvement'; }
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <button class="btn btn-icon" onclick="toggleTheme(); updateStudentThemeBtn()" title="Toggle Theme" id="studentThemeBtn">
                        ${document.body.classList.contains('light-theme') ? 'üåô' : '‚òÄÔ∏è'}
                    </button>
                </div>
                <div class="success-animation">
                    <div class="checkmark" style="background: var(--${gradeClass});">‚úì</div>
                    <h2 style="font-size: 1.5rem;">Exam Submitted!</h2>
                    <p style="color: var(--text-secondary);">${gradeText}</p>
                </div>
                
                <div class="score-display">
                    <div class="score-circle" style="--score-percent: ${percentage}%">
                        <span class="score-text">${percentage}%</span>
                    </div>
                    <p class="score-label">${correct} out of ${total} correct</p>
                </div>
                
                <h3 style="margin: 2rem 0 1rem; font-size: 1.125rem;">Your Answers:</h3>
                ${details.map((d, i) => `
                    <div class="quiz-question-card ${d.isCorrect ? 'correct' : 'incorrect'}">
                        <p><strong>${i + 1}. [${d.type}]</strong> ${d.question}</p>
                        <p style="margin-top: 0.5rem;">Your answer: <strong>${d.studentAnswer}</strong></p>
                        ${!d.isCorrect ? `<p style="color: var(--success); margin-top: 0.25rem;">Correct answer: <strong>${d.correctAnswer}</strong></p>` : ''}
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin-top: 2rem; padding: 2rem; background: var(--bg-card); border-radius: var(--radius-xl); border: 1px solid var(--border);">
                    <p style="color: var(--text-secondary);">Your results have been sent to your teacher.</p>
                    <p style="color: var(--warning); margin-top: 0.5rem;">This exam link is now closed for you.</p>
                </div>
            `;
            
            if (percentage >= 70) {
                createConfetti();
            }
        }
        
        // ==================== QUIZ MODALS (Practice Mode) ====================
        function openQuizModal(type) {
            const modal = document.getElementById('modalOverlay');
            const modalEl = document.getElementById('modal');
            modalEl.classList.remove('wide');
            modal.classList.add('active');
            
            const titles = {
                fillBlank: 'üìù Fill in the Blank',
                relatedWords: 'üñºÔ∏è Picture Word Match',
                matchWords: 'üîó Match the Words',
                trueFalse: '‚úì‚úó True or False'
            };
            
            document.getElementById('modalTitle').innerHTML = titles[type];
            currentView = 'main';
            renderQuizModal(type);
        }
        
        function renderQuizModal(type) {
            const body = document.getElementById('modalBody');
            
            switch(type) {
                case 'fillBlank':
                    renderFillBlankModal(body);
                    break;
                case 'relatedWords':
                    renderRelatedWordsModal(body);
                    break;
                case 'matchWords':
                    renderMatchWordsModal(body);
                    break;
                case 'trueFalse':
                    renderTrueFalseModal(body);
                    break;
            }
        }
        
        function closeModal() {
            const modal = document.getElementById('modalOverlay');
            const modalEl = document.getElementById('modal');
            modal.classList.remove('active');
            modalEl.classList.remove('wide');
            currentView = 'main';
            renderTeacherHome();
        }
        
        // ==================== FILL IN THE BLANK ====================
        function renderFillBlankModal(body) {
            if (quizData.fillBlank.questions.length === 0 && currentView === 'main') {
                body.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <h3>No Quiz Created Yet</h3>
                        <p>Create sentences with blanks for students to fill in!</p>
                        <button class="btn btn-primary" onclick="showFillBlankCreate()">
                            Create Quiz
                        </button>
                    </div>
                `;
            } else if (currentView === 'main') {
                body.innerHTML = `
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('play')">Play Quiz</button>
                        <button class="tab" onclick="switchTab('edit')">Edit Quiz</button>
                    </div>
                    <div id="tabContent"></div>
                `;
                renderFillBlankPlay();
            } else if (currentView === 'create') {
                renderFillBlankCreate(body);
            }
        }
        
        function showFillBlankCreate() {
            currentView = 'create';
            renderFillBlankCreate(document.getElementById('modalBody'));
        }
        
        function renderFillBlankCreate(body) {
            const questions = quizData.fillBlank.questions;
            body.innerHTML = `
                <div id="questionsContainer">
                    ${questions.map((q, i) => renderQuestionBuilder(q, i)).join('')}
                </div>
                <button class="btn btn-secondary" onclick="addQuestion()" style="width: 100%; margin-top: 1rem;">
                    + Add Question
                </button>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="currentView='main'; renderQuizModal('fillBlank')">
                        Back
                    </button>
                    <button class="btn btn-success" onclick="saveFillBlankQuiz()" style="flex: 1;">
                        Save Quiz
                    </button>
                </div>
            `;
            
            if (questions.length === 0) {
                addQuestion();
            }
        }
        
        function renderQuestionBuilder(question = null, index = 0) {
            const q = question || { sentence: '', blankWord: '', options: ['', '', '', ''], correctIndex: 0 };
            return `
                <div class="question-builder" id="q-${index}">
                    <span class="question-number">Q${index + 1}</span>
                    <button class="remove-question" onclick="removeFillBlankQuestion(${index})">&times;</button>
                    <div class="form-group">
                        <label>Sentence (use [BLANK] where the word should be hidden)</label>
                        <input type="text" id="sentence-${index}" value="${q.sentence}" 
                            placeholder="Example: The [BLANK] is very tall.">
                    </div>
                    <div class="form-group">
                        <label>Hidden Word (correct answer)</label>
                        <input type="text" id="blankWord-${index}" value="${q.blankWord}" placeholder="giraffe">
                    </div>
                    <div class="form-group">
                        <label>Answer Options (check the correct one)</label>
                        <div class="options-container">
                            ${[0, 1, 2, 3].map(i => `
                                <div class="option-input-group">
                                    <input type="radio" name="correct-${index}" value="${i}" ${q.correctIndex === i ? 'checked' : ''}>
                                    <input type="text" id="option-${index}-${i}" value="${q.options[i] || ''}" placeholder="Option ${i + 1}">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function addQuestion() {
            const container = document.getElementById('questionsContainer');
            const index = container.children.length;
            container.insertAdjacentHTML('beforeend', renderQuestionBuilder(null, index));
        }
        
        function removeFillBlankQuestion(index) {
            const container = document.getElementById('questionsContainer');
            if (container.children.length > 1) {
                container.children[index].remove();
                const questions = collectFillBlankQuestions();
                quizData.fillBlank.questions = questions;
                renderFillBlankCreate(document.getElementById('modalBody'));
            }
        }
        
        function collectFillBlankQuestions() {
            const container = document.getElementById('questionsContainer');
            const questions = [];
            
            for (let i = 0; i < container.children.length; i++) {
                const sentence = document.getElementById(`sentence-${i}`)?.value || '';
                const blankWord = document.getElementById(`blankWord-${i}`)?.value || '';
                const options = [0, 1, 2, 3].map(j => document.getElementById(`option-${i}-${j}`)?.value || '');
                const correctRadio = document.querySelector(`input[name="correct-${i}"]:checked`);
                const correctIndex = correctRadio ? parseInt(correctRadio.value) : 0;
                
                if (sentence && blankWord) {
                    questions.push({ sentence, blankWord, options, correctIndex });
                }
            }
            
            return questions;
        }
        
        function saveFillBlankQuiz() {
            quizData.fillBlank.questions = collectFillBlankQuestions();
            saveData();
            currentView = 'main';
            renderQuizModal('fillBlank');
            createConfetti();
        }
        
        function renderFillBlankPlay() {
            const content = document.getElementById('tabContent');
            const questions = quizData.fillBlank.questions;
            
            content.innerHTML = `
                <div class="score-display">
                    <div class="score-circle" id="scoreCircle" style="--score-percent: 0%">
                        <span class="score-text" id="scoreText">0/${questions.length}</span>
                    </div>
                    <p class="score-label">Questions Answered</p>
                </div>
                <div id="questionsPlayContainer">
                    ${questions.map((q, i) => renderFillBlankPlayQuestion(q, i)).join('')}
                </div>
                <button class="btn btn-primary" onclick="resetFillBlankQuiz()" style="width: 100%; margin-top: 1rem;">
                    Reset Quiz
                </button>
            `;
        }
        
        function renderFillBlankPlayQuestion(question, index) {
            const displaySentence = question.sentence.replace('[BLANK]', 
                `<span class="blank-space" id="blank-${index}" onclick="selectBlank(${index})">???</span>`);
            
            return `
                <div class="quiz-question-card" id="card-${index}">
                    <p class="question-text">${displaySentence}</p>
                    <div class="options-grid">
                        ${question.options.filter(o => o).map((opt, i) => `
                            <button class="option-btn" onclick="selectFillBlankOption(${index}, ${i}, '${opt.replace(/'/g, "\\'")}')" 
                                id="opt-${index}-${i}">${opt}</button>
                        `).join('')}
                    </div>
                    <div id="feedback-${index}"></div>
                </div>
            `;
        }
        
        let selectedAnswers = {};
        
        function selectFillBlankOption(questionIndex, optionIndex, value) {
            const blank = document.getElementById(`blank-${questionIndex}`);
            const question = quizData.fillBlank.questions[questionIndex];
            const card = document.getElementById(`card-${questionIndex}`);
            const feedback = document.getElementById(`feedback-${questionIndex}`);
            
            blank.textContent = value;
            blank.classList.add('filled');
            
            question.options.forEach((_, i) => {
                document.getElementById(`opt-${questionIndex}-${i}`)?.classList.remove('selected');
            });
            document.getElementById(`opt-${questionIndex}-${optionIndex}`).classList.add('selected');
            
            const isCorrect = value.toLowerCase() === question.blankWord.toLowerCase();
            selectedAnswers[questionIndex] = isCorrect;
            
            if (isCorrect) {
                blank.classList.add('correct-answer');
                blank.classList.remove('wrong-answer');
                card.classList.add('correct');
                card.classList.remove('incorrect');
                feedback.innerHTML = '<div class="feedback correct">‚úì Correct! Well done!</div>';
                createConfetti();
            } else {
                blank.classList.add('wrong-answer');
                blank.classList.remove('correct-answer');
                card.classList.add('incorrect');
                card.classList.remove('correct');
                feedback.innerHTML = `<div class="feedback incorrect">‚úó Not quite! The correct answer is: ${question.blankWord}</div>`;
            }
            
            updateScore();
            
            question.options.forEach((_, i) => {
                const btn = document.getElementById(`opt-${questionIndex}-${i}`);
                if (btn) btn.disabled = true;
            });
        }
        
        function updateScore() {
            const questions = quizData.fillBlank.questions;
            const answered = Object.keys(selectedAnswers).length;
            const correct = Object.values(selectedAnswers).filter(v => v).length;
            const percent = questions.length > 0 ? (correct / questions.length) * 100 : 0;
            
            document.getElementById('scoreText').textContent = `${correct}/${questions.length}`;
            document.getElementById('scoreCircle').style.setProperty('--score-percent', `${percent}%`);
        }
        
        function resetFillBlankQuiz() {
            selectedAnswers = {};
            renderFillBlankPlay();
        }
        
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'play') {
                tabs[0].classList.add('active');
                renderFillBlankPlay();
            } else {
                tabs[1].classList.add('active');
                currentView = 'create';
                renderFillBlankCreate(document.getElementById('tabContent'));
            }
        }
        
        // ==================== RELATED WORDS MODAL (Simplified) ====================
        function renderRelatedWordsModal(body) {
            body.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üñºÔ∏è</div>
                    <h3>Picture Word Match</h3>
                    <p>This quiz type is designed for exams. Create an exam to use Picture Word Match with categories and decoy words!</p>
                    <button class="btn btn-primary" onclick="closeModal(); openExamBuilder();">
                        Create Exam
                    </button>
                </div>
            `;
        }
        
        // ==================== MATCH WORDS MODAL (Simplified) ====================
        function renderMatchWordsModal(body) {
            body.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üîó</div>
                    <h3>Match the Words</h3>
                    <p>This quiz type is designed for exams. Create an exam to use word matching!</p>
                    <button class="btn btn-primary" onclick="closeModal(); openExamBuilder();">
                        Create Exam
                    </button>
                </div>
            `;
        }
        
        // ==================== TRUE/FALSE MODAL (Simplified) ====================
        function renderTrueFalseModal(body) {
            body.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚úì‚úó</div>
                    <h3>True or False</h3>
                    <p>This quiz type is designed for exams. Create an exam to use True/False questions!</p>
                    <button class="btn btn-primary" onclick="closeModal(); openExamBuilder();">
                        Create Exam
                    </button>
                </div>
            `;
        }
        
        // ==================== EFFECTS ====================
        function createConfetti() {
            const container = document.getElementById('confetti');
            const colors = ['#6366f1', '#ec4899', '#06b6d4', '#10b981', '#f59e0b', '#8b5cf6'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                container.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            loadTheme();
            
            if (!checkStudentMode()) {
                renderTeacherHome();
            }
        });
        
        // Close modal on overlay click
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeModal();
            }
        });
        
        // Escape key closes modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
