<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arabic by Rolla</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Fredoka+One&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --secondary: #f472b6;
            --accent: #22d3ee;
            --accent2: #fbbf24;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        /* Light Theme */
        body.light-theme {
            --primary: #ec4899;
            --primary-dark: #db2777;
            --secondary: #f97316;
            --accent: #06b6d4;
            --accent2: #eab308;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #fdf2f8;
            --bg-card: #ffffff;
            --bg-card-hover: #fce7f3;
            --text: #1f2937;
            --text-muted: #6b7280;
            --gradient-1: linear-gradient(135deg, #f472b6 0%, #ec4899 100%);
            --gradient-2: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
            --gradient-3: linear-gradient(135deg, #67e8f9 0%, #06b6d4 100%);
            --gradient-4: linear-gradient(135deg, #86efac 0%, #22c55e 100%);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        .bg-animation::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background: radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(244, 114, 182, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(34, 211, 238, 0.1) 0%, transparent 40%),
                        radial-gradient(circle at 60% 60%, rgba(251, 191, 36, 0.08) 0%, transparent 35%);
            animation: bgMove 20s ease-in-out infinite;
        }
        
        body.light-theme .bg-animation::before {
            background: radial-gradient(circle at 20% 80%, rgba(236, 72, 153, 0.2) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(249, 115, 22, 0.2) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(6, 182, 212, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at 60% 60%, rgba(234, 179, 8, 0.1) 0%, transparent 35%);
        }
        
        @keyframes bgMove {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(2%, 2%) rotate(1deg); }
            50% { transform: translate(0, 4%) rotate(0deg); }
            75% { transform: translate(-2%, 2%) rotate(-1deg); }
        }
        
        /* Floating Particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            opacity: 0.3;
            animation: float 15s infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(30, 41, 59, 0.8) 100%);
            backdrop-filter: blur(20px);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        body.light-theme .header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(253, 242, 248, 0.9) 100%);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .logo h1 {
            font-family: 'Fredoka One', cursive;
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        /* Theme Toggle Button */
        .theme-toggle {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: var(--text);
            cursor: pointer;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            transform: translateY(-2px);
            background: var(--primary);
            border-color: var(--primary);
        }
        
        body.light-theme .theme-toggle {
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(239, 68, 68, 0.5);
        }
        
        .btn-secondary {
            background: var(--bg-card-hover);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5);
        }
        
        .btn-accent {
            background: linear-gradient(135deg, var(--accent2) 0%, #f59e0b 100%);
            color: #1e293b;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
        }
        
        .btn-accent:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(251, 191, 36, 0.5);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            font-size: 1rem;
            padding: 1rem 2rem;
        }
        
        .btn-gradient:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
        }
        
        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Quiz Type Cards */
        .quiz-types-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .quiz-card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .quiz-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .quiz-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: var(--primary);
            box-shadow: 0 20px 40px rgba(139, 92, 246, 0.2);
        }
        
        .quiz-card:hover::before {
            opacity: 1;
        }
        
        .quiz-card-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .quiz-card-icon.fill-blank {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        }
        
        .quiz-card-icon.related-words {
            background: linear-gradient(135deg, #f472b6 0%, #ec4899 100%);
        }
        
        .quiz-card-icon.match-words {
            background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%);
        }
        
        .quiz-card-icon.true-false {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }
        
        .quiz-card h3 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .quiz-card p {
            color: var(--text-muted);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .quiz-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-ready {
            background: var(--success);
            color: white;
        }
        
        .badge-empty {
            background: var(--bg-card-hover);
            color: var(--text-muted);
        }
        
        /* Create Exam Card */
        .create-exam-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(240, 147, 251, 0.2) 100%);
            border: 2px dashed var(--primary);
            border-radius: 24px;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            grid-column: 1 / -1;
            margin-bottom: 1rem;
        }
        
        .create-exam-card:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(240, 147, 251, 0.3) 100%);
            transform: scale(1.02);
            border-style: solid;
        }
        
        .create-exam-card h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 2rem;
        }
        
        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal {
            background: var(--bg-card);
            border-radius: 24px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .modal.wide {
            max-width: 1100px;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--bg-card-hover);
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: var(--error);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
        }
        
        .empty-state-icon {
            width: 120px;
            height: 120px;
            background: var(--bg-card-hover);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 1.5rem;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .empty-state p {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--bg-dark);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
        
        /* Question Builder */
        .question-builder {
            background: var(--bg-dark);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.05);
            position: relative;
        }
        
        .question-builder:hover {
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .question-number {
            position: absolute;
            top: -10px;
            left: 1rem;
            background: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .remove-question {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0.5;
            transition: all 0.3s ease;
        }
        
        .remove-question:hover {
            opacity: 1;
            background: rgba(239, 68, 68, 0.2);
        }
        
        .options-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .option-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .option-input-group input[type="text"] {
            flex: 1;
        }
        
        .option-input-group input[type="radio"],
        .option-input-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--success);
        }
        
        /* Quiz Play View */
        .quiz-play {
            padding: 2rem;
        }
        
        .quiz-question-card {
            background: var(--bg-dark);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .quiz-question-card.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .quiz-question-card.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .quiz-question-card.answered {
            border-color: var(--accent);
            background: rgba(34, 211, 238, 0.1);
        }
        
        .question-text {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            line-height: 1.8;
        }
        
        .blank-space {
            display: inline-block;
            min-width: 120px;
            padding: 0.25rem 0.5rem;
            background: var(--primary);
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .blank-space:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }
        
        .blank-space.filled {
            background: var(--accent);
        }
        
        .blank-space.correct-answer {
            background: var(--success);
        }
        
        .blank-space.wrong-answer {
            background: var(--error);
        }
        
        .options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .option-btn {
            padding: 0.75rem 1.25rem;
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text);
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .option-btn:hover:not(:disabled) {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.2);
            transform: translateY(-2px);
        }
        
        .option-btn.selected {
            border-color: var(--accent);
            background: rgba(34, 211, 238, 0.2);
        }
        
        .option-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* True/False Buttons */
        .tf-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .tf-btn {
            flex: 1;
            padding: 1.5rem;
            border: 3px solid;
            border-radius: 16px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            transition: all 0.3s ease;
            background: transparent;
        }
        
        .tf-btn.true {
            border-color: var(--success);
            color: var(--success);
        }
        
        .tf-btn.true:hover:not(:disabled) {
            background: var(--success);
            color: white;
            transform: scale(1.05);
        }
        
        .tf-btn.false {
            border-color: var(--error);
            color: var(--error);
        }
        
        .tf-btn.false:hover:not(:disabled) {
            background: var(--error);
            color: white;
            transform: scale(1.05);
        }
        
        .tf-btn.selected {
            transform: scale(1.05);
        }
        
        .tf-btn.selected.true {
            background: var(--success);
            color: white;
        }
        
        .tf-btn.selected.false {
            background: var(--error);
            color: white;
        }
        
        /* Match/Drag Quiz */
        .match-container {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .match-column {
            flex: 1;
            min-width: 250px;
        }
        
        .match-column h4 {
            margin-bottom: 1rem;
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .image-drop-zone {
            background: var(--bg-dark);
            border: 3px dashed rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 1.5rem;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        
        .image-drop-zone:hover {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.1);
        }
        
        .image-drop-zone.selectable {
            cursor: pointer;
            border-color: var(--accent);
            animation: pulse-border 1s infinite;
        }
        
        @keyframes pulse-border {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 211, 238, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(34, 211, 238, 0); }
        }
        
        .image-drop-zone img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .image-drop-zone h5 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .dropped-words {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            min-height: 40px;
            justify-content: center;
        }
        
        .word-chip {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .word-chip:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }
        
        .word-chip.selected {
            background: linear-gradient(135deg, var(--accent) 0%, #0891b2 100%);
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.6);
            transform: scale(1.15);
        }
        
        .word-chip.correct {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }
        
        .word-chip.incorrect {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
        }
        
        .word-chip.placed-word {
            position: relative;
        }
        
        .word-chip.placed-word::after {
            content: 'x';
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            background: var(--error);
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .word-chip.placed-word:hover::after {
            opacity: 1;
        }
        
        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            padding: 1.5rem;
            background: var(--bg-dark);
            border-radius: 16px;
            min-height: 80px;
            justify-content: center;
        }
        
        /* Image Upload */
        .image-upload-zone {
            border: 3px dashed rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        
        .image-upload-zone:hover {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.1);
        }
        
        .image-upload-zone input {
            display: none;
        }
        
        /* Score Display */
        .score-display {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-card-hover) 100%);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(var(--success) var(--score-percent, 0%), var(--bg-dark) 0%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            position: relative;
        }
        
        .score-circle::before {
            content: '';
            position: absolute;
            width: 120px;
            height: 120px;
            background: var(--bg-card);
            border-radius: 50%;
        }
        
        .score-text {
            position: relative;
            z-index: 1;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .score-label {
            color: var(--text-muted);
            font-size: 1.1rem;
        }
        
        /* Feedback Messages */
        .feedback {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .feedback.correct {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid var(--success);
            color: var(--success);
        }
        
        .feedback.incorrect {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--error);
            color: var(--error);
        }
        
        /* Confetti */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confetti-fall 3s linear forwards;
        }
        
        @keyframes confetti-fall {
            0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        
        /* Section Title */
        .section-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .section-subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: var(--bg-dark);
            padding: 0.5rem;
            border-radius: 12px;
        }
        
        .tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        .tab:hover:not(.active) {
            color: var(--text);
            background: var(--bg-card-hover);
        }

        /* Category Item Builder */
        .category-builder {
            background: var(--bg-dark);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.05);
        }

        .category-builder-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .tags-input {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-card);
            border-radius: 12px;
            min-height: 50px;
            align-items: center;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: var(--primary);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            font-size: 1rem;
            line-height: 1;
        }

        .tags-input input {
            border: none;
            background: transparent;
            color: var(--text);
            outline: none;
            font-size: 0.95rem;
            flex: 1;
            min-width: 100px;
        }
        
        /* Exam Builder Styles */
        .exam-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .exam-type-option {
            background: var(--bg-dark);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .exam-type-option:hover {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.1);
        }
        
        .exam-type-option.selected {
            border-color: var(--accent);
            background: rgba(34, 211, 238, 0.15);
        }
        
        .exam-type-option input {
            display: none;
        }
        
        .exam-type-option .icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .exam-type-option .name {
            font-weight: 600;
            font-size: 1rem;
        }
        
        /* Link Display */
        .link-display {
            background: var(--bg-dark);
            border: 2px solid var(--accent);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .link-display input {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--accent);
            font-size: 0.95rem;
            font-family: monospace;
        }
        
        .link-display input:focus {
            outline: none;
        }
        
        /* Student View Styles */
        .student-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 2rem;
            border-radius: 24px;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .student-header h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        
        .student-header p {
            opacity: 0.9;
        }
        
        .student-name-input {
            max-width: 400px;
            margin: 2rem auto;
            text-align: center;
        }
        
        .student-name-input input {
            width: 100%;
            padding: 1.25rem;
            font-size: 1.2rem;
            text-align: center;
            background: var(--bg-card);
            border: 3px solid var(--primary);
            border-radius: 16px;
            color: var(--text);
            font-family: 'Poppins', sans-serif;
        }
        
        .student-name-input input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(34, 211, 238, 0.2);
        }
        
        /* Progress Bar */
        .progress-bar {
            background: var(--bg-card);
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .header-actions {
                justify-content: center;
            }
            
            .quiz-types-grid {
                grid-template-columns: 1fr;
            }
            
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .match-container {
                flex-direction: column;
            }
            
            .modal {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
            }
            
            .exam-type-selector {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-card-hover);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        /* Success Animation */
        .success-animation {
            text-align: center;
            padding: 3rem;
        }
        
        .success-animation .checkmark {
            width: 100px;
            height: 100px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 1.5rem;
            animation: pop 0.5s ease;
        }
        
        @keyframes pop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Matched words indicator */
        .option-btn.matched {
            cursor: pointer;
        }
        
        .option-btn.matched:hover {
            opacity: 0.8;
        }
        
        /* Error Page */
        .error-page {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .error-icon {
            width: 120px;
            height: 120px;
            background: var(--error);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 2rem;
        }
        
        .error-page h2 {
            color: var(--error);
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        
        .error-page p {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Background Animation -->
    <div class="bg-animation"></div>
    <div class="particles" id="particles"></div>
    
    <!-- Confetti Container -->
    <div class="confetti-container" id="confetti"></div>
    
    <!-- Header -->
    <header class="header" id="mainHeader">
        <div class="logo">
            <div class="logo-icon">&#x1F4DA;</div>
            <h1>Arabic by Rolla</h1>
        </div>
        <div class="header-actions" id="headerActions">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Light/Dark Mode" id="themeToggleBtn">
                &#x2600;
            </button>
            <button class="btn btn-secondary" onclick="goHome()">
                Home
            </button>
            <button class="btn btn-danger" onclick="resetAll()">
                Reset All
            </button>
        </div>
    </header>
    
    <!-- Main Container -->
    <main class="main-container" id="mainContainer">
        <!-- Will be dynamically rendered -->
    </main>
    
    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Quiz</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const TELEGRAM_BOT_TOKEN = '6759901283:AAGGfZvU2EX59mK6uefmHV69GJ-NKPbCdQ4';
        let TELEGRAM_CHAT_ID = localStorage.getItem('telegramChatId') || '';
        const STORAGE_KEY = 'arabicByRolla';
        const EXAMS_STORAGE_KEY = 'arabicByRollaExams';
        const SUBMISSIONS_KEY = 'arabicByRollaSubmissions';
        
        // ==================== DATA STORAGE ====================
        let quizData = {
            fillBlank: { questions: [] },
            relatedWords: { categories: [] },
            matchWords: { pairs: [] },
            trueFalse: { questions: [] }
        };
        
        let examsData = {};
        let submissionsData = {}; // Track who submitted what exam
        let isStudentMode = false;
        let currentExamId = null;
        let currentExamData = null; // For URL-based exam data
        let studentName = '';
        let studentAnswers = {};
        let currentView = 'main';
        
        // ==================== THEME TOGGLE ====================
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            updateThemeIcon();
        }
        
        function updateThemeIcon() {
            const btn = document.getElementById('themeToggleBtn');
            if (btn) {
                const isLight = document.body.classList.contains('light-theme');
                btn.innerHTML = isLight ? '&#x1F319;' : '&#x2600;';
            }
        }
        
        function loadTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'light') {
                document.body.classList.add('light-theme');
            }
            updateThemeIcon();
        }
        
        // Load from localStorage
        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                quizData = JSON.parse(saved);
            }
            const savedExams = localStorage.getItem(EXAMS_STORAGE_KEY);
            if (savedExams) {
                examsData = JSON.parse(savedExams);
            }
            const savedSubmissions = localStorage.getItem(SUBMISSIONS_KEY);
            if (savedSubmissions) {
                submissionsData = JSON.parse(savedSubmissions);
            }
        }
        
        // Save to localStorage
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(quizData));
        }
        
        function saveExams() {
            localStorage.setItem(EXAMS_STORAGE_KEY, JSON.stringify(examsData));
        }
        
        function saveSubmissions() {
            localStorage.setItem(SUBMISSIONS_KEY, JSON.stringify(submissionsData));
        }
        
        // ==================== URL-BASED EXAM DATA ====================
        // Compress and encode exam data for URL
        function encodeExamData(exam) {
            const json = JSON.stringify(exam);
            // Use base64 encoding
            return btoa(unescape(encodeURIComponent(json)));
        }
        
        // Decode exam data from URL
        function decodeExamData(encoded) {
            try {
                const json = decodeURIComponent(escape(atob(encoded)));
                return JSON.parse(json);
            } catch (e) {
                console.error('Failed to decode exam data:', e);
                return null;
            }
        }
        
        // Check if we're in student mode from URL
        function checkStudentMode() {
            const params = new URLSearchParams(window.location.search);
            const examData = params.get('data');
            const examId = params.get('exam');
            
            // New URL format with embedded data
            if (examData) {
                const decoded = decodeExamData(examData);
                if (decoded) {
                    isStudentMode = true;
                    currentExamId = decoded.id || 'embedded';
                    currentExamData = decoded;
                    document.getElementById('mainHeader').style.display = 'none';
                    renderStudentExam();
                    return true;
                } else {
                    renderExamNotFound();
                    return true;
                }
            }
            
            // Legacy support for old localStorage-based links
            if (examId && examsData[examId]) {
                isStudentMode = true;
                currentExamId = examId;
                currentExamData = examsData[examId];
                document.getElementById('mainHeader').style.display = 'none';
                renderStudentExam();
                return true;
            }
            
            // If there's an exam parameter but no data found
            if (examId || examData) {
                renderExamNotFound();
                return true;
            }
            
            return false;
        }
        
        function renderExamNotFound() {
            document.getElementById('mainHeader').style.display = 'none';
            const container = document.getElementById('mainContainer');
            container.innerHTML = `
                <div class="error-page">
                    <div class="error-icon">&#x26A0;</div>
                    <h2>Exam Not Found</h2>
                    <p>This exam link may have expired, been deleted, or is no longer available.</p>
                    <p>Please contact your teacher for a new link.</p>
                </div>
            `;
        }
        
        // Reset all data
        function resetAll() {
            if (confirm('Are you sure you want to reset all quizzes and exams? This cannot be undone!')) {
                quizData = {
                    fillBlank: { questions: [] },
                    relatedWords: { categories: [] },
                    matchWords: { pairs: [] },
                    trueFalse: { questions: [] }
                };
                examsData = {};
                saveData();
                saveExams();
                goHome();
                createConfetti();
            }
        }
        
        // ==================== NAVIGATION ====================
        function goHome() {
            closeModal();
            renderTeacherHome();
        }
        
        function renderTeacherHome() {
            const container = document.getElementById('mainContainer');
            container.innerHTML = `
                <section id="homeView">
                    <h2 class="section-title">Welcome, Teacher!</h2>
                    <p class="section-subtitle">Create interactive quizzes and exams for your students</p>
                    
                    <!-- Telegram Settings -->
                    <div style="background: var(--bg-card); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">&#x1F4E9;</span> Telegram Settings
                        </h3>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label>Your Telegram Chat ID</label>
                            <input type="text" id="chatIdInput" placeholder="Enter your Telegram Chat ID" 
                                value="${TELEGRAM_CHAT_ID}" onchange="saveChatId(this.value)">
                            <p class="form-hint">Get your Chat ID by messaging @userinfobot on Telegram</p>
                        </div>
                    </div>
                    
                    <!-- Create Exam Button -->
                    <div class="create-exam-card" onclick="openExamBuilder()">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">&#x1F4DD;</div>
                        <h3>Create Shareable Exam</h3>
                        <p style="color: var(--text-muted);">Combine quiz types into an exam and share with students via link</p>
                    </div>
                    
                    <h3 style="margin: 2rem 0 1rem; color: var(--text-muted);">Practice Quiz Types</h3>
                    
                    <div class="quiz-types-grid">
                        <!-- Fill the Blank -->
                        <div class="quiz-card" onclick="openQuizModal('fillBlank')">
                            <span class="quiz-badge ${quizData.fillBlank.questions.length > 0 ? 'badge-ready' : 'badge-empty'}" id="fillBlankBadge">
                                ${quizData.fillBlank.questions.length > 0 ? quizData.fillBlank.questions.length + ' Questions' : 'No Quiz'}
                            </span>
                            <div class="quiz-card-icon fill-blank">&#x1F4DD;</div>
                            <h3>Fill in the Blank</h3>
                            <p>Create sentences with missing words. Students choose from multiple options.</p>
                        </div>
                        
                        <!-- Related Words -->
                        <div class="quiz-card" onclick="openQuizModal('relatedWords')">
                            <span class="quiz-badge ${quizData.relatedWords.categories.length > 0 ? 'badge-ready' : 'badge-empty'}" id="relatedWordsBadge">
                                ${quizData.relatedWords.categories.length > 0 ? quizData.relatedWords.categories.length + ' Categories' : 'No Quiz'}
                            </span>
                            <div class="quiz-card-icon related-words">&#x1F5BC;</div>
                            <h3>Picture Word Match</h3>
                            <p>Upload images and let students match related words to pictures.</p>
                        </div>
                        
                        <!-- Match Words -->
                        <div class="quiz-card" onclick="openQuizModal('matchWords')">
                            <span class="quiz-badge ${quizData.matchWords.pairs.length > 0 ? 'badge-ready' : 'badge-empty'}" id="matchWordsBadge">
                                ${quizData.matchWords.pairs.length > 0 ? quizData.matchWords.pairs.length + ' Pairs' : 'No Quiz'}
                            </span>
                            <div class="quiz-card-icon match-words">&#x1F517;</div>
                            <h3>Match the Words</h3>
                            <p>Create word pairs for students to match - great for synonyms and translations!</p>
                        </div>
                        
                        <!-- True/False -->
                        <div class="quiz-card" onclick="openQuizModal('trueFalse')">
                            <span class="quiz-badge ${quizData.trueFalse.questions.length > 0 ? 'badge-ready' : 'badge-empty'}" id="trueFalseBadge">
                                ${quizData.trueFalse.questions.length > 0 ? quizData.trueFalse.questions.length + ' Questions' : 'No Quiz'}
                            </span>
                            <div class="quiz-card-icon true-false">&#x2713;&#x2717;</div>
                            <h3>True or False</h3>
                            <p>Create statements and let students decide if they are true or false.</p>
                        </div>
                    </div>
                </section>
            `;
        }
        
        function saveChatId(value) {
            TELEGRAM_CHAT_ID = value.trim();
            localStorage.setItem('telegramChatId', TELEGRAM_CHAT_ID);
        }
        
        // ==================== EXAM BUILDER ====================
        function openExamBuilder() {
            const modal = document.getElementById('modalOverlay');
            const modalEl = document.getElementById('modal');
            modalEl.classList.add('wide');
            modal.classList.add('active');
            document.getElementById('modalTitle').innerHTML = 'Create Shareable Exam';
            renderExamBuilderStep1();
        }
        
        let examBuilder = {
            title: '',
            selectedTypes: [],
            questions: {
                fillBlank: [],
                trueFalse: [],
                matchWords: [],
                relatedWords: []
            }
        };
        
        function renderExamBuilderStep1() {
            examBuilder = {
                title: '',
                selectedTypes: [],
                questions: {
                    fillBlank: [],
                    trueFalse: [],
                    matchWords: [],
                    relatedWords: []
                }
            };
            
            const body = document.getElementById('modalBody');
            body.innerHTML = `
                <div class="form-group">
                    <label>Exam Title</label>
                    <input type="text" id="examTitle" placeholder="e.g., Arabic Vocabulary Test Week 3" value="${examBuilder.title}">
                </div>
                
                <label style="display: block; margin-bottom: 1rem; font-weight: 600;">Select Quiz Types to Include</label>
                <div class="exam-type-selector">
                    <label class="exam-type-option" id="opt-fillBlank">
                        <input type="checkbox" value="fillBlank" onchange="toggleExamType('fillBlank')">
                        <div class="icon">&#x1F4DD;</div>
                        <div class="name">Fill in the Blank</div>
                    </label>
                    <label class="exam-type-option" id="opt-trueFalse">
                        <input type="checkbox" value="trueFalse" onchange="toggleExamType('trueFalse')">
                        <div class="icon">&#x2713;&#x2717;</div>
                        <div class="name">True or False</div>
                    </label>
                    <label class="exam-type-option" id="opt-matchWords">
                        <input type="checkbox" value="matchWords" onchange="toggleExamType('matchWords')">
                        <div class="icon">&#x1F517;</div>
                        <div class="name">Match Words</div>
                    </label>
                    <label class="exam-type-option" id="opt-relatedWords">
                        <input type="checkbox" value="relatedWords" onchange="toggleExamType('relatedWords')">
                        <div class="icon">&#x1F5BC;</div>
                        <div class="name">Picture Match</div>
                    </label>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-gradient" onclick="goToExamStep2()" style="flex: 1;">
                        Continue to Add Questions
                    </button>
                </div>
            `;
        }
        
        function toggleExamType(type) {
            const opt = document.getElementById(`opt-${type}`);
            const idx = examBuilder.selectedTypes.indexOf(type);
            if (idx > -1) {
                examBuilder.selectedTypes.splice(idx, 1);
                opt.classList.remove('selected');
            } else {
                examBuilder.selectedTypes.push(type);
                opt.classList.add('selected');
            }
        }
        
        function goToExamStep2() {
            examBuilder.title = document.getElementById('examTitle').value.trim();
            if (!examBuilder.title) {
                alert('Please enter an exam title');
                return;
            }
            if (examBuilder.selectedTypes.length === 0) {
                alert('Please select at least one quiz type');
                return;
            }
            renderExamBuilderStep2();
        }
        
        function renderExamBuilderStep2() {
            const body = document.getElementById('modalBody');
            
            let sectionsHtml = '';
            
            if (examBuilder.selectedTypes.includes('fillBlank')) {
                sectionsHtml += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: var(--primary); padding: 0.25rem 0.75rem; border-radius: 8px;">&#x1F4DD;</span>
                            Fill in the Blank Questions
                        </h3>
                        <div id="fillBlankContainer">
                            ${examBuilder.questions.fillBlank.map((q, i) => renderExamFillBlankQ(q, i)).join('')}
                        </div>
                        <button class="btn btn-secondary" onclick="addExamFillBlankQ()" style="width: 100%; margin-top: 0.5rem;">
                            + Add Fill in the Blank Question
                        </button>
                    </div>
                `;
            }
            
            if (examBuilder.selectedTypes.includes('trueFalse')) {
                sectionsHtml += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: var(--success); padding: 0.25rem 0.75rem; border-radius: 8px;">&#x2713;&#x2717;</span>
                            True or False Questions
                        </h3>
                        <div id="trueFalseContainer">
                            ${examBuilder.questions.trueFalse.map((q, i) => renderExamTFQ(q, i)).join('')}
                        </div>
                        <button class="btn btn-secondary" onclick="addExamTFQ()" style="width: 100%; margin-top: 0.5rem;">
                            + Add True/False Question
                        </button>
                    </div>
                `;
            }
            
            if (examBuilder.selectedTypes.includes('matchWords')) {
                sectionsHtml += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: var(--accent); padding: 0.25rem 0.75rem; border-radius: 8px; color: #1e293b;">&#x1F517;</span>
                            Match Words Pairs
                        </h3>
                        <div id="matchWordsContainer">
                            ${examBuilder.questions.matchWords.map((q, i) => renderExamMatchQ(q, i)).join('')}
                        </div>
                        <button class="btn btn-secondary" onclick="addExamMatchQ()" style="width: 100%; margin-top: 0.5rem;">
                            + Add Word Pair
                        </button>
                    </div>
                `;
            }
            
            if (examBuilder.selectedTypes.includes('relatedWords')) {
                sectionsHtml += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="background: var(--secondary); padding: 0.25rem 0.75rem; border-radius: 8px;">&#x1F5BC;</span>
                            Picture Word Match Categories
                        </h3>
                        <div id="relatedWordsContainer">
                            ${examBuilder.questions.relatedWords.map((q, i) => renderExamCategoryQ(q, i)).join('')}
                        </div>
                        <button class="btn btn-secondary" onclick="addExamCategoryQ()" style="width: 100%; margin-top: 0.5rem;">
                            + Add Category
                        </button>
                    </div>
                `;
            }
            
            body.innerHTML = `
                <h3 style="margin-bottom: 1.5rem;">Add Questions for: ${examBuilder.title}</h3>
                ${sectionsHtml}
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="renderExamBuilderStep1()">Back</button>
                    <button class="btn btn-success" onclick="generateExamLink()" style="flex: 1;">
                        Generate Exam Link
                    </button>
                </div>
            `;
            
            // Initialize with one question each if empty
            if (examBuilder.selectedTypes.includes('fillBlank') && examBuilder.questions.fillBlank.length === 0) {
                addExamFillBlankQ();
            }
            if (examBuilder.selectedTypes.includes('trueFalse') && examBuilder.questions.trueFalse.length === 0) {
                addExamTFQ();
            }
            if (examBuilder.selectedTypes.includes('matchWords') && examBuilder.questions.matchWords.length === 0) {
                addExamMatchQ();
            }
            if (examBuilder.selectedTypes.includes('relatedWords') && examBuilder.questions.relatedWords.length === 0) {
                addExamCategoryQ();
            }
        }
        
        // Fill in the Blank for Exam
        function renderExamFillBlankQ(q = null, index = 0) {
            const question = q || { sentence: '', blankWord: '', options: ['', '', '', ''] };
            return `
                <div class="question-builder" id="examFB-${index}">
                    <span class="question-number">Q${index + 1}</span>
                    <button class="remove-question" onclick="removeExamQ('fillBlank', ${index})">&times;</button>
                    <div class="form-group">
                        <label>Sentence (use [BLANK] for hidden word)</label>
                        <input type="text" id="examFBSentence-${index}" value="${question.sentence}" 
                            placeholder="The cat is [BLANK] on the mat.">
                    </div>
                    <div class="form-group">
                        <label>Correct Answer</label>
                        <input type="text" id="examFBAnswer-${index}" value="${question.blankWord}" placeholder="sitting">
                    </div>
                    <div class="form-group">
                        <label>Wrong Options (3 distractors)</label>
                        <div class="options-container">
                            <input type="text" id="examFBOpt-${index}-0" value="${question.options[0] || ''}" placeholder="Option 1">
                            <input type="text" id="examFBOpt-${index}-1" value="${question.options[1] || ''}" placeholder="Option 2">
                            <input type="text" id="examFBOpt-${index}-2" value="${question.options[2] || ''}" placeholder="Option 3">
                        </div>
                    </div>
                </div>
            `;
        }
        
        function addExamFillBlankQ() {
            const container = document.getElementById('fillBlankContainer');
            const index = container.children.length;
            examBuilder.questions.fillBlank.push({ sentence: '', blankWord: '', options: ['', '', ''] });
            container.insertAdjacentHTML('beforeend', renderExamFillBlankQ(null, index));
        }
        
        // True/False for Exam
        function renderExamTFQ(q = null, index = 0) {
            const question = q || { statement: '', isTrue: true };
            return `
                <div class="question-builder" id="examTF-${index}">
                    <span class="question-number">Q${index + 1}</span>
                    <button class="remove-question" onclick="removeExamQ('trueFalse', ${index})">&times;</button>
                    <div class="form-group">
                        <label>Statement</label>
                        <textarea id="examTFStatement-${index}" placeholder="Enter a statement...">${question.statement}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Correct Answer</label>
                        <div style="display: flex; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="examTFAnswer-${index}" value="true" ${question.isTrue ? 'checked' : ''}>
                                <span style="color: var(--success);">True</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="examTFAnswer-${index}" value="false" ${!question.isTrue ? 'checked' : ''}>
                                <span style="color: var(--error);">False</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function addExamTFQ() {
            const container = document.getElementById('trueFalseContainer');
            const index = container.children.length;
            examBuilder.questions.trueFalse.push({ statement: '', isTrue: true });
            container.insertAdjacentHTML('beforeend', renderExamTFQ(null, index));
        }
        
        // Match Words for Exam
        function renderExamMatchQ(q = null, index = 0) {
            const question = q || { word1: '', word2: '' };
            return `
                <div class="question-builder" id="examMatch-${index}" style="display: flex; gap: 1rem; align-items: center;">
                    <span class="question-number">${index + 1}</span>
                    <input type="text" id="examMatchW1-${index}" value="${question.word1}" placeholder="Word 1" style="flex: 1;">
                    <span style="font-size: 1.5rem;">&#x2194;</span>
                    <input type="text" id="examMatchW2-${index}" value="${question.word2}" placeholder="Word 2" style="flex: 1;">
                    <button class="remove-question" onclick="removeExamQ('matchWords', ${index})" style="position: relative; top: 0; right: 0;">&times;</button>
                </div>
            `;
        }
        
        function addExamMatchQ() {
            const container = document.getElementById('matchWordsContainer');
            const index = container.children.length;
            examBuilder.questions.matchWords.push({ word1: '', word2: '' });
            container.insertAdjacentHTML('beforeend', renderExamMatchQ(null, index));
        }
        
        // Category for Exam (Picture Match)
        let examTempImages = {};
        let examTempWords = {};
        
        function renderExamCategoryQ(q = null, index = 0) {
            const cat = q || { name: '', image: '', words: [] };
            examTempWords[index] = examTempWords[index] || [...(cat.words || [])];
            return `
                <div class="category-builder" id="examCat-${index}">
                    <div class="category-builder-header">
                        <span style="background: var(--secondary); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">
                            Category ${index + 1}
                        </span>
                        <button class="remove-question" onclick="removeExamQ('relatedWords', ${index})" style="position: relative; top: 0; right: 0;">&times;</button>
                    </div>
                    <div class="form-group">
                        <label>Category Name</label>
                        <input type="text" id="examCatName-${index}" value="${cat.name}" placeholder="e.g., Animals, Fruits">
                    </div>
                    <div class="form-group">
                        <label>Image (optional)</label>
                        <div class="image-upload-zone" onclick="document.getElementById('examCatImg-${index}').click()">
                            <input type="file" id="examCatImg-${index}" accept="image/*" onchange="handleExamCatImage(${index}, this)" style="display:none;">
                            <div id="examCatImgPreview-${index}">
                                ${cat.image ? `<img src="${cat.image}" style="max-width: 150px; border-radius: 12px;">` : 'Click to upload image'}
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Words that belong to this category</label>
                        <div class="tags-input" id="examCatTags-${index}">
                            ${(examTempWords[index] || []).map(w => `
                                <span class="tag">${w} <button onclick="removeExamCatWord(${index}, '${escapeHtml(w)}')">&times;</button></span>
                            `).join('')}
                            <input type="text" id="examCatWordInput-${index}" placeholder="Type word and press Enter" 
                                onkeypress="handleExamCatWord(event, ${index})">
                        </div>
                        <p class="form-hint">Press Enter to add each word</p>
                    </div>
                </div>
            `;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, "\\'");
        }
        
        function handleExamCatImage(index, input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById(`examCatImgPreview-${index}`);
                    preview.innerHTML = `<img src="${e.target.result}" style="max-width: 150px; border-radius: 12px;">`;
                    examTempImages[index] = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function handleExamCatWord(event, index) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById(`examCatWordInput-${index}`);
                const word = input.value.trim();
                if (word) {
                    if (!examTempWords[index]) examTempWords[index] = [];
                    examTempWords[index].push(word);
                    
                    const container = document.getElementById(`examCatTags-${index}`);
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.innerHTML = `${word} <button onclick="removeExamCatWord(${index}, '${escapeHtml(word)}')">&times;</button>`;
                    container.insertBefore(tag, input);
                    input.value = '';
                }
            }
        }
        
        function removeExamCatWord(index, word) {
            if (examTempWords[index]) {
                examTempWords[index] = examTempWords[index].filter(w => w !== word);
            }
            const container = document.getElementById(`examCatTags-${index}`);
            const tags = container.querySelectorAll('.tag');
            tags.forEach(tag => {
                if (tag.textContent.trim().replace('x', '').trim() === word) {
                    tag.remove();
                }
            });
        }
        
        function addExamCategoryQ() {
            const container = document.getElementById('relatedWordsContainer');
            const index = container.children.length;
            examBuilder.questions.relatedWords.push({ name: '', image: '', words: [] });
            examTempWords[index] = [];
            container.insertAdjacentHTML('beforeend', renderExamCategoryQ(null, index));
        }
        
        function removeExamQ(type, index) {
            const containerIds = {
                fillBlank: 'fillBlankContainer',
                trueFalse: 'trueFalseContainer',
                matchWords: 'matchWordsContainer',
                relatedWords: 'relatedWordsContainer'
            };
            const container = document.getElementById(containerIds[type]);
            if (container && container.children.length > 1) {
                container.children[index].remove();
                // Re-render to fix indices
                if (type === 'relatedWords') {
                    delete examTempWords[index];
                    delete examTempImages[index];
                }
            }
        }
        
        function collectExamQuestions() {
            const questions = {
                fillBlank: [],
                trueFalse: [],
                matchWords: [],
                relatedWords: []
            };
            
            // Fill in the Blank
            if (examBuilder.selectedTypes.includes('fillBlank')) {
                const container = document.getElementById('fillBlankContainer');
                for (let i = 0; i < container.children.length; i++) {
                    const sentence = document.getElementById(`examFBSentence-${i}`)?.value || '';
                    const blankWord = document.getElementById(`examFBAnswer-${i}`)?.value || '';
                    const options = [0, 1, 2].map(j => document.getElementById(`examFBOpt-${i}-${j}`)?.value || '').filter(o => o);
                    
                    if (sentence && blankWord) {
                        questions.fillBlank.push({ sentence, blankWord, options });
                    }
                }
            }
            
            // True/False
            if (examBuilder.selectedTypes.includes('trueFalse')) {
                const container = document.getElementById('trueFalseContainer');
                for (let i = 0; i < container.children.length; i++) {
                    const statement = document.getElementById(`examTFStatement-${i}`)?.value || '';
                    const answerRadio = document.querySelector(`input[name="examTFAnswer-${i}"]:checked`);
                    const isTrue = answerRadio ? answerRadio.value === 'true' : true;
                    
                    if (statement) {
                        questions.trueFalse.push({ statement, isTrue });
                    }
                }
            }
            
            // Match Words
            if (examBuilder.selectedTypes.includes('matchWords')) {
                const container = document.getElementById('matchWordsContainer');
                for (let i = 0; i < container.children.length; i++) {
                    const word1 = document.getElementById(`examMatchW1-${i}`)?.value || '';
                    const word2 = document.getElementById(`examMatchW2-${i}`)?.value || '';
                    
                    if (word1 && word2) {
                        questions.matchWords.push({ word1, word2 });
                    }
                }
            }
            
            // Related Words (Category Match - NO images in exam to keep URL small)
            if (examBuilder.selectedTypes.includes('relatedWords')) {
                const container = document.getElementById('relatedWordsContainer');
                for (let i = 0; i < container.children.length; i++) {
                    const name = document.getElementById(`examCatName-${i}`)?.value || '';
                    // NOTE: We intentionally do NOT include images in exam data to keep URL size manageable
                    // Images are stored as base64 which makes URLs too long and uncopiable
                    const words = examTempWords[i] || [];
                    
                    if (name && words.length > 0) {
                        questions.relatedWords.push({ name, words }); // No image field
                    }
                }
            }
            
            return questions;
        }
        
        function generateExamLink() {
            const questions = collectExamQuestions();
            
            // Validate
            let hasQuestions = false;
            for (const type of examBuilder.selectedTypes) {
                if (questions[type] && questions[type].length > 0) {
                    hasQuestions = true;
                    break;
                }
            }
            
            if (!hasQuestions) {
                alert('Please add at least one question to generate the exam link');
                return;
            }
            
            const examId = 'exam_' + Date.now();
            const exam = {
                id: examId,
                title: examBuilder.title,
                questions: questions,
                createdAt: new Date().toISOString(),
                telegramChatId: TELEGRAM_CHAT_ID || ''  // Embed chat ID in exam data
            };
            
            // Save locally too
            examsData[examId] = exam;
            saveExams();
            
            // Generate URL with embedded data
            const encodedData = encodeExamData(exam);
            const baseUrl = window.location.href.split('?')[0];
            const examLink = `${baseUrl}?data=${encodedData}`;
            
            // Reset temp data
            examTempImages = {};
            examTempWords = {};
            
            // Show link
            const body = document.getElementById('modalBody');
            body.innerHTML = `
                <div class="success-animation">
                    <div class="checkmark">&#x2713;</div>
                    <h3>Exam Created Successfully!</h3>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Share this link with your students</p>
                </div>
                
                <div class="link-display">
                    <input type="text" id="examLinkInput" value="${examLink}" readonly onclick="this.select()">
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="copyExamLink()" style="flex: 1;">
                        Copy Link
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal()">
                        Done
                    </button>
                </div>
                
                <p style="margin-top: 1.5rem; color: var(--text-muted); font-size: 0.9rem; text-align: center;">
                    Note: This link contains all exam data and will work for anyone you share it with.
                    <br>Students can only submit once per name.
                </p>
            `;
            
            createConfetti();
        }
        
        function copyExamLink() {
            const input = document.getElementById('examLinkInput');
            input.select();
            document.execCommand('copy');
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.style.background = 'var(--success)';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 2000);
        }
        
        // ==================== STUDENT VIEW ====================
        function renderStudentExam() {
            const exam = currentExamData;
            if (!exam) {
                renderExamNotFound();
                return;
            }
            
            const container = document.getElementById('mainContainer');
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Light/Dark Mode" id="studentThemeBtn">
                        ${document.body.classList.contains('light-theme') ? '&#x1F319;' : '&#x2600;'}
                    </button>
                </div>
                <div class="student-header">
                    <h2>${exam.title}</h2>
                    <p>Enter your name to begin</p>
                </div>
                
                <div class="student-name-input">
                    <div class="form-group">
                        <label style="text-align: center; font-size: 1.1rem;">Your Name</label>
                        <input type="text" id="studentNameInput" placeholder="Enter your full name" autofocus>
                    </div>
                    <button class="btn btn-gradient" onclick="startExam()" style="width: 100%; margin-top: 1rem; font-size: 1.1rem; padding: 1.25rem;">
                        Start Exam
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 2rem; color: var(--text-muted);">
                    <p>You can change your answers before submitting.</p>
                    <p style="color: var(--warning);">Note: You can only submit once!</p>
                    <p>Good luck!</p>
                </div>
            `;
            
            document.getElementById('studentNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') startExam();
            });
        }
        
        function startExam() {
            const name = document.getElementById('studentNameInput').value.trim();
            if (!name) {
                alert('Please enter your name to start the exam');
                return;
            }
            
            // Check if this student already submitted this exam
            const submissionKey = `${currentExamId}_${name.toLowerCase()}`;
            if (submissionsData[submissionKey]) {
                const prevSubmission = submissionsData[submissionKey];
                alert(`You have already submitted this exam!\n\nYour previous score: ${prevSubmission.score}/${prevSubmission.total} (${prevSubmission.percentage}%)`);
                return;
            }
            
            studentName = name;
            studentAnswers = {
                fillBlank: {},
                trueFalse: {},
                matchWords: {},
                relatedWords: {}
            };
            renderStudentQuestions(currentExamData);
        }
        
        function renderStudentQuestions(exam) {
            const container = document.getElementById('mainContainer');
            
            let totalQuestions = 0;
            let sectionsHtml = '';
            let questionNum = 0;
            
            // Fill in the Blank
            if (exam.questions.fillBlank && exam.questions.fillBlank.length > 0) {
                totalQuestions += exam.questions.fillBlank.length;
                sectionsHtml += `
                    <h3 style="margin: 2rem 0 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="background: var(--primary); padding: 0.5rem 1rem; border-radius: 12px;">&#x1F4DD;</span>
                        Fill in the Blank
                    </h3>
                    <p style="color: var(--accent); font-size: 0.9rem; margin-bottom: 1rem;">Click on a filled blank to change your answer</p>
                `;
                exam.questions.fillBlank.forEach((q, i) => {
                    questionNum++;
                    const options = [q.blankWord, ...q.options].sort(() => Math.random() - 0.5);
                    sectionsHtml += `
                        <div class="quiz-question-card" id="studentQ-fillBlank-${i}">
                            <p class="question-text">
                                <strong>Q${questionNum}.</strong> ${q.sentence.replace('[BLANK]', `<span class="blank-space" id="blank-fb-${i}" onclick="clearFillBlank(${i})">???</span>`)}
                            </p>
                            <div class="options-grid" id="opts-fb-${i}">
                                ${options.map((opt, oi) => `
                                    <button class="option-btn" onclick="selectStudentAnswer('fillBlank', ${i}, '${opt.replace(/'/g, "\\'")}')" 
                                        id="opt-fb-${i}-${oi}">${opt}</button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
            }
            
            // True/False
            if (exam.questions.trueFalse && exam.questions.trueFalse.length > 0) {
                totalQuestions += exam.questions.trueFalse.length;
                sectionsHtml += `
                    <h3 style="margin: 2rem 0 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="background: var(--success); padding: 0.5rem 1rem; border-radius: 12px;">&#x2713;&#x2717;</span>
                        True or False
                    </h3>
                    <p style="color: var(--accent); font-size: 0.9rem; margin-bottom: 1rem;">Click your selection again to change it</p>
                `;
                exam.questions.trueFalse.forEach((q, i) => {
                    questionNum++;
                    sectionsHtml += `
                        <div class="quiz-question-card" id="studentQ-trueFalse-${i}">
                            <p class="question-text"><strong>Q${questionNum}.</strong> ${q.statement}</p>
                            <div class="tf-buttons">
                                <button class="tf-btn true" id="tf-true-${i}" onclick="selectStudentAnswer('trueFalse', ${i}, true)">
                                    TRUE
                                </button>
                                <button class="tf-btn false" id="tf-false-${i}" onclick="selectStudentAnswer('trueFalse', ${i}, false)">
                                    FALSE
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            // Match Words
            if (exam.questions.matchWords && exam.questions.matchWords.length > 0) {
                totalQuestions += exam.questions.matchWords.length;
                const leftWords = exam.questions.matchWords.map((p, i) => ({ word: p.word1, idx: i })).sort(() => Math.random() - 0.5);
                const rightWords = exam.questions.matchWords.map((p, i) => ({ word: p.word2, idx: i })).sort(() => Math.random() - 0.5);
                
                sectionsHtml += `
                    <h3 style="margin: 2rem 0 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="background: var(--accent); padding: 0.5rem 1rem; border-radius: 12px; color: #1e293b;">&#x1F517;</span>
                        Match the Words
                    </h3>
                    <p style="color: var(--text-muted); margin-bottom: 0.5rem;">Click a word from each column to match them.</p>
                    <p style="color: var(--accent); font-size: 0.9rem; margin-bottom: 1rem;">Click a matched pair to unmatch and try again</p>
                    <div class="quiz-question-card">
                        <div class="match-container">
                            <div class="match-column">
                                <h4>Column A</h4>
                                ${leftWords.map(w => `
                                    <button class="option-btn" style="width: 100%; margin-bottom: 0.5rem;"
                                        id="match-left-${w.idx}" data-idx="${w.idx}" data-side="left"
                                        onclick="selectMatchStudent(this, ${w.idx}, 'left')">${w.word}</button>
                                `).join('')}
                            </div>
                            <div class="match-column">
                                <h4>Column B</h4>
                                ${rightWords.map(w => `
                                    <button class="option-btn" style="width: 100%; margin-bottom: 0.5rem;"
                                        id="match-right-${w.idx}" data-idx="${w.idx}" data-side="right"
                                        onclick="selectMatchStudent(this, ${w.idx}, 'right')">${w.word}</button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Related Words (Picture Match)
            if (exam.questions.relatedWords && exam.questions.relatedWords.length > 0) {
                let allWords = [];
                exam.questions.relatedWords.forEach((cat, catIdx) => {
                    cat.words.forEach(word => {
                        allWords.push({ word, catIdx });
                    });
                });
                totalQuestions += allWords.length;
                allWords = allWords.sort(() => Math.random() - 0.5);
                
                sectionsHtml += `
                    <h3 style="margin: 2rem 0 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="background: var(--secondary); padding: 0.5rem 1rem; border-radius: 12px;">&#x1F4C1;</span>
                        Category Word Match
                    </h3>
                    <p style="color: var(--accent); text-align: center; margin-bottom: 1rem;" id="picMatchInstruction">
                        Click a word, then click the category it belongs to
                    </p>
                    <p style="color: var(--text-muted); text-align: center; font-size: 0.9rem; margin-bottom: 1rem;">
                        Click placed words to return them to the word bank
                    </p>
                    <div class="quiz-question-card">
                        <div class="match-container" style="flex-wrap: wrap; justify-content: center;">
                            ${exam.questions.relatedWords.map((cat, catIdx) => `
                                <div class="match-column" style="min-width: 150px; flex: 1;">
                                    <div class="image-drop-zone" id="picCat-${catIdx}" data-catidx="${catIdx}"
                                        onclick="selectPicCategory(${catIdx})"
                                        style="min-height: 120px; padding: 1rem;">
                                        <h5 style="font-size: 1.1rem; margin-bottom: 0.5rem;">${cat.name}</h5>
                                        <div class="dropped-words" id="picDropped-${catIdx}"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <h4 style="margin: 1.5rem 0 0.75rem; color: var(--text-muted);">Word Bank</h4>
                        <div class="word-bank" id="picWordBank">
                            ${allWords.map((w, wi) => `
                                <span class="word-chip" id="picWord-${wi}" data-wordidx="${wi}" data-catidx="${w.catIdx}"
                                    onclick="selectPicWord(${wi}, ${w.catIdx})">${w.word}</span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <button class="theme-toggle" onclick="toggleTheme(); updateStudentThemeBtn()" title="Toggle Light/Dark Mode" id="studentThemeBtn">
                        ${document.body.classList.contains('light-theme') ? '&#x1F319;' : '&#x2600;'}
                    </button>
                </div>
                <div class="student-header">
                    <h2>${exam.title}</h2>
                    <p>Good luck, ${studentName}!</p>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <p style="text-align: center; color: var(--text-muted); margin-bottom: 2rem;" id="progressText">
                    0 of ${totalQuestions} questions answered
                </p>
                
                ${sectionsHtml}
                
                <div style="margin-top: 3rem; padding: 2rem; background: var(--bg-card); border-radius: 20px; text-align: center;">
                    <p style="margin-bottom: 0.5rem; color: var(--text-muted);">
                        Review your answers above. You can change them before submitting.
                    </p>
                    <p style="margin-bottom: 1rem; color: var(--warning); font-weight: 600;">
                        Warning: You can only submit once!
                    </p>
                    <button class="btn btn-gradient" onclick="confirmSubmitExam()" style="font-size: 1.2rem; padding: 1.25rem 3rem;">
                        Submit Exam
                    </button>
                </div>
            `;
            
            // Store total for progress tracking
            window.totalQuestions = totalQuestions;
        }
        
        function updateStudentThemeBtn() {
            const btn = document.getElementById('studentThemeBtn');
            if (btn) {
                btn.innerHTML = document.body.classList.contains('light-theme') ? '&#x1F319;' : '&#x2600;';
            }
        }
        
        // Clear fill in the blank answer
        function clearFillBlank(index) {
            if (studentAnswers.fillBlank[index] !== undefined) {
                const blank = document.getElementById(`blank-fb-${index}`);
                blank.textContent = '???';
                blank.classList.remove('filled');
                
                const card = document.getElementById(`studentQ-fillBlank-${index}`);
                card.classList.remove('answered');
                card.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                
                delete studentAnswers.fillBlank[index];
                updateProgress();
            }
        }
        
        function selectStudentAnswer(type, index, value) {
            if (type === 'fillBlank') {
                studentAnswers[type][index] = value;
                
                // Update blank
                const blank = document.getElementById(`blank-fb-${index}`);
                if (blank) {
                    blank.textContent = value;
                    blank.classList.add('filled');
                }
                // Update button styles
                const card = document.getElementById(`studentQ-fillBlank-${index}`);
                card.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                card.querySelectorAll('.option-btn').forEach(btn => {
                    if (btn.textContent === value) btn.classList.add('selected');
                });
                card.classList.add('answered');
            } else if (type === 'trueFalse') {
                // Toggle - if clicking same answer, deselect
                if (studentAnswers[type][index] === value) {
                    delete studentAnswers[type][index];
                    const trueBtn = document.getElementById(`tf-true-${index}`);
                    const falseBtn = document.getElementById(`tf-false-${index}`);
                    const card = document.getElementById(`studentQ-trueFalse-${index}`);
                    trueBtn.classList.remove('selected');
                    falseBtn.classList.remove('selected');
                    card.classList.remove('answered');
                } else {
                    studentAnswers[type][index] = value;
                    const trueBtn = document.getElementById(`tf-true-${index}`);
                    const falseBtn = document.getElementById(`tf-false-${index}`);
                    const card = document.getElementById(`studentQ-trueFalse-${index}`);
                    
                    trueBtn.classList.remove('selected');
                    falseBtn.classList.remove('selected');
                    
                    if (value === true) {
                        trueBtn.classList.add('selected');
                    } else {
                        falseBtn.classList.add('selected');
                    }
                    card.classList.add('answered');
                }
            }
            
            updateProgress();
        }
        
        let selectedMatchStudent = null;
        let matchedPairs = {}; // Track matched pairs: leftIdx -> { leftEl, rightEl, rightIdx, colorIdx }
        let usedColorIndices = []; // Track which colors are in use
        
        // Distinct colors for matched pairs
        const matchPairColors = [
            { bg: '#8b5cf6', border: '#7c3aed' },  // Purple
            { bg: '#f472b6', border: '#ec4899' },  // Pink
            { bg: '#22d3ee', border: '#06b6d4' },  // Cyan
            { bg: '#fbbf24', border: '#f59e0b' },  // Yellow
            { bg: '#10b981', border: '#059669' },  // Green
            { bg: '#f97316', border: '#ea580c' },  // Orange
            { bg: '#ef4444', border: '#dc2626' },  // Red
            { bg: '#6366f1', border: '#4f46e5' },  // Indigo
            { bg: '#14b8a6', border: '#0d9488' },  // Teal
            { bg: '#a855f7', border: '#9333ea' },  // Violet
        ];
        
        function getNextColorIndex() {
            for (let i = 0; i < matchPairColors.length; i++) {
                if (!usedColorIndices.includes(i)) {
                    return i;
                }
            }
            return 0; // Fallback to first color if all used
        }
        
        function selectMatchStudent(element, idx, side) {
            // Check if this element is already matched - if so, unmatch it
            if (element.classList.contains('matched')) {
                unmatchWord(element, idx, side);
                return;
            }
            
            if (!selectedMatchStudent) {
                selectedMatchStudent = { element, idx, side };
                element.classList.add('selected');
                return;
            }
            
            if (selectedMatchStudent.side === side) {
                selectedMatchStudent.element.classList.remove('selected');
                selectedMatchStudent = { element, idx, side };
                element.classList.add('selected');
                return;
            }
            
            // Record the match
            const leftIdx = side === 'left' ? idx : selectedMatchStudent.idx;
            const rightIdx = side === 'right' ? idx : selectedMatchStudent.idx;
            const leftEl = side === 'left' ? element : selectedMatchStudent.element;
            const rightEl = side === 'right' ? element : selectedMatchStudent.element;
            
            // Get a unique color for this pair
            const colorIdx = getNextColorIndex();
            usedColorIndices.push(colorIdx);
            const color = matchPairColors[colorIdx];
            
            studentAnswers.matchWords[leftIdx] = rightIdx;
            matchedPairs[leftIdx] = { leftEl, rightEl, rightIdx, colorIdx };
            
            // Visual feedback - mark as matched with unique color (clickable to unmatch)
            leftEl.classList.remove('selected');
            rightEl.classList.remove('selected');
            leftEl.classList.add('matched');
            rightEl.classList.add('matched');
            
            leftEl.style.background = color.bg;
            leftEl.style.borderColor = color.border;
            leftEl.style.color = 'white';
            rightEl.style.background = color.bg;
            rightEl.style.borderColor = color.border;
            rightEl.style.color = 'white';
            
            selectedMatchStudent = null;
            updateProgress();
        }
        
        function unmatchWord(element, idx, side) {
            // Find and remove the match
            let leftIdx = null;
            
            if (side === 'left') {
                leftIdx = idx;
            } else {
                // Find which left word this right word is matched to
                for (const [lIdx, pair] of Object.entries(matchedPairs)) {
                    if (pair.rightIdx === idx) {
                        leftIdx = parseInt(lIdx);
                        break;
                    }
                }
            }
            
            if (leftIdx !== null && matchedPairs[leftIdx]) {
                const pair = matchedPairs[leftIdx];
                
                // Release the color back to the pool
                const colorIdx = pair.colorIdx;
                usedColorIndices = usedColorIndices.filter(c => c !== colorIdx);
                
                // Reset both elements
                pair.leftEl.classList.remove('matched', 'selected');
                pair.rightEl.classList.remove('matched', 'selected');
                pair.leftEl.style.background = '';
                pair.leftEl.style.borderColor = '';
                pair.leftEl.style.color = '';
                pair.rightEl.style.background = '';
                pair.rightEl.style.borderColor = '';
                pair.rightEl.style.color = '';
                
                // Remove from answers
                delete studentAnswers.matchWords[leftIdx];
                delete matchedPairs[leftIdx];
                
                updateProgress();
            }
        }
        
        let selectedPicWordStudent = null;
        let placedPicWords = {}; // Track placed words: wordIdx -> { catIdx, element, originalEl, word, correctCatIdx }
        
        function selectPicWord(wordIdx, correctCatIdx) {
            // Deselect previous
            document.querySelectorAll('#picWordBank .word-chip').forEach(chip => chip.classList.remove('selected'));
            
            const wordEl = document.getElementById(`picWord-${wordIdx}`);
            wordEl.classList.add('selected');
            selectedPicWordStudent = { wordIdx, correctCatIdx, element: wordEl };
            
            // Highlight categories
            document.querySelectorAll('.image-drop-zone').forEach(zone => zone.classList.add('selectable'));
            
            document.getElementById('picMatchInstruction').textContent = 'Now click the category for this word';
            document.getElementById('picMatchInstruction').style.color = 'var(--accent)';
        }
        
        function returnPicWord(wordIdx) {
            const placed = placedPicWords[wordIdx];
            if (!placed) return;
            
            // Remove from category answers
            if (studentAnswers.relatedWords[placed.catIdx]) {
                studentAnswers.relatedWords[placed.catIdx] = studentAnswers.relatedWords[placed.catIdx].filter(
                    w => w.wordIdx !== wordIdx
                );
            }
            
            // Remove the placed element
            placed.element.remove();
            
            // Show original word in bank again
            placed.originalEl.style.display = 'inline-block';
            
            // Remove from tracking
            delete placedPicWords[wordIdx];
            
            document.getElementById('picMatchInstruction').textContent = 'Word returned! Click a word to place it again';
            document.getElementById('picMatchInstruction').style.color = 'var(--accent)';
            
            updateProgress();
        }
        
        function selectPicCategory(catIdx) {
            if (!selectedPicWordStudent) {
                document.getElementById('picMatchInstruction').textContent = 'First, click a word from the word bank below!';
                document.getElementById('picMatchInstruction').style.color = 'var(--warning)';
                return;
            }
            
            const wordEl = selectedPicWordStudent.element;
            const dropZone = document.getElementById(`picDropped-${catIdx}`);
            const wordIdx = selectedPicWordStudent.wordIdx;
            
            // Record answer
            if (!studentAnswers.relatedWords[catIdx]) studentAnswers.relatedWords[catIdx] = [];
            studentAnswers.relatedWords[catIdx].push({
                wordIdx: wordIdx,
                word: wordEl.textContent,
                correctCatIdx: selectedPicWordStudent.correctCatIdx
            });
            
            // Move word to category - make it clickable to return
            const newWord = document.createElement('span');
            newWord.className = 'word-chip placed-word';
            newWord.textContent = wordEl.textContent;
            newWord.style.cursor = 'pointer';
            newWord.title = 'Click to return this word';
            newWord.onclick = () => returnPicWord(wordIdx);
            dropZone.appendChild(newWord);
            
            // Track the placed word
            placedPicWords[wordIdx] = {
                catIdx: catIdx,
                element: newWord,
                originalEl: wordEl,
                word: wordEl.textContent,
                correctCatIdx: selectedPicWordStudent.correctCatIdx
            };
            
            wordEl.style.display = 'none';
            
            // Reset state
            document.querySelectorAll('.image-drop-zone').forEach(zone => zone.classList.remove('selectable'));
            selectedPicWordStudent = null;
            
            document.getElementById('picMatchInstruction').textContent = 'Great! Select another word or submit when ready';
            document.getElementById('picMatchInstruction').style.color = 'var(--success)';
            
            updateProgress();
        }
        
        function updateProgress() {
            let answered = 0;
            const exam = currentExamData;
            
            // Count answered fill in the blank
            answered += Object.keys(studentAnswers.fillBlank).length;
            
            // Count answered true/false
            answered += Object.keys(studentAnswers.trueFalse).length;
            
            // Count matched words
            answered += Object.keys(studentAnswers.matchWords).length;
            
            // Count placed picture words
            answered += Object.keys(placedPicWords).length;
            
            const total = window.totalQuestions || 1;
            const percent = Math.round((answered / total) * 100);
            
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${answered} of ${total} questions answered`;
        }
        
        function confirmSubmitExam() {
            if (!confirm('Are you sure you want to submit? You cannot change your answers after submission!')) {
                return;
            }
            submitExam();
        }
        
        function submitExam() {
            const exam = currentExamData;
            let correct = 0;
            let total = 0;
            let details = [];
            
            // Grade Fill in the Blank
            if (exam.questions.fillBlank) {
                exam.questions.fillBlank.forEach((q, i) => {
                    total++;
                    const answer = studentAnswers.fillBlank[i];
                    const isCorrect = answer && answer.toLowerCase() === q.blankWord.toLowerCase();
                    if (isCorrect) correct++;
                    details.push({
                        type: 'Fill Blank',
                        question: q.sentence,
                        studentAnswer: answer || '(no answer)',
                        correctAnswer: q.blankWord,
                        isCorrect
                    });
                });
            }
            
            // Grade True/False
            if (exam.questions.trueFalse) {
                exam.questions.trueFalse.forEach((q, i) => {
                    total++;
                    const answer = studentAnswers.trueFalse[i];
                    const isCorrect = answer === q.isTrue;
                    if (isCorrect) correct++;
                    details.push({
                        type: 'True/False',
                        question: q.statement,
                        studentAnswer: answer === undefined ? '(no answer)' : (answer ? 'True' : 'False'),
                        correctAnswer: q.isTrue ? 'True' : 'False',
                        isCorrect
                    });
                });
            }
            
            // Grade Match Words
            if (exam.questions.matchWords) {
                exam.questions.matchWords.forEach((q, i) => {
                    total++;
                    const matchedRightIdx = studentAnswers.matchWords[i];
                    const isCorrect = matchedRightIdx === i;
                    if (isCorrect) correct++;
                    
                    let studentAnswer = '(no match)';
                    if (matchedRightIdx !== undefined) {
                        studentAnswer = exam.questions.matchWords[matchedRightIdx]?.word2 || '(invalid)';
                    }
                    
                    details.push({
                        type: 'Match',
                        question: q.word1,
                        studentAnswer: studentAnswer,
                        correctAnswer: q.word2,
                        isCorrect
                    });
                });
            }
            
            // Grade Picture Match
            if (exam.questions.relatedWords) {
                for (const [wordIdx, placed] of Object.entries(placedPicWords)) {
                    total++;
                    const isCorrect = placed.catIdx === placed.correctCatIdx;
                    if (isCorrect) correct++;
                    
                    const placedCatName = exam.questions.relatedWords[placed.catIdx]?.name || '(unknown)';
                    const correctCatName = exam.questions.relatedWords[placed.correctCatIdx]?.name || '(unknown)';
                    
                    details.push({
                        type: 'Picture Match',
                        question: placed.word,
                        studentAnswer: placedCatName,
                        correctAnswer: correctCatName,
                        isCorrect
                    });
                }
                
                // Count unplaced words as wrong
                exam.questions.relatedWords.forEach((cat, catIdx) => {
                    cat.words.forEach(word => {
                        // Check if this word was placed
                        const wasPlaced = Object.values(placedPicWords).some(p => p.word === word);
                        if (!wasPlaced) {
                            total++;
                            details.push({
                                type: 'Picture Match',
                                question: word,
                                studentAnswer: '(not placed)',
                                correctAnswer: cat.name,
                                isCorrect: false
                            });
                        }
                    });
                });
            }
            
            const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
            
            // Save submission to prevent re-taking
            const submissionKey = `${currentExamId}_${studentName.toLowerCase()}`;
            submissionsData[submissionKey] = {
                name: studentName,
                score: correct,
                total: total,
                percentage: percentage,
                submittedAt: new Date().toISOString()
            };
            saveSubmissions();
            
            // Send to Telegram
            sendResultsToTelegram(exam.title, studentName, correct, total, percentage, details);
            
            // Show results
            showResults(exam.title, correct, total, percentage, details);
        }
        
        function sendResultsToTelegram(examTitle, name, correct, total, percentage, details) {
            // Use chat ID from exam data (embedded in URL) or fallback to local setting
            const chatId = currentExamData?.telegramChatId || TELEGRAM_CHAT_ID;
            if (!chatId) {
                console.log('No Telegram Chat ID configured');
                return;
            }
            
            // Grade emoji
            let gradeEmoji = '';
            if (percentage >= 90) gradeEmoji = ' Excellent!';
            else if (percentage >= 70) gradeEmoji = ' Good job!';
            else if (percentage >= 50) gradeEmoji = ' Needs improvement';
            else gradeEmoji = ' Needs more practice';
            
            let message = ` *EXAM SUBMISSION*\n`;
            message += `\n`;
            message += ` *Exam:* ${examTitle}\n`;
            message += ` *Student:* ${name}\n`;
            message += `\n\n`;
            
            message += ` *GRADE: ${percentage}%* ${gradeEmoji}\n`;
            message += ` *Score:* ${correct} / ${total}\n\n`;
            
            message += `\n`;
            message += ` *DETAILED ANSWERS:*\n`;
            message += `\n\n`;
            
            details.forEach((d, i) => {
                const icon = d.isCorrect ? '' : '';
                message += `${i + 1}. [${d.type}] ${icon}\n`;
                message += `   Q: ${d.question.substring(0, 50)}${d.question.length > 50 ? '...' : ''}\n`;
                message += `   Student: ${d.studentAnswer}\n`;
                if (!d.isCorrect) {
                    message += `   Correct: ${d.correctAnswer}\n`;
                }
                message += `\n`;
            });
            
            message += `\n`;
            message += ` Submitted: ${new Date().toLocaleString()}`;
            
            fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: message,
                    parse_mode: 'Markdown'
                })
            }).catch(err => console.error('Telegram error:', err));
        }
        
        function showResults(examTitle, correct, total, percentage, details) {
            const container = document.getElementById('mainContainer');
            
            let gradeClass = 'success';
            let gradeText = 'Excellent!';
            if (percentage < 90) { gradeClass = 'success'; gradeText = 'Good Job!'; }
            if (percentage < 70) { gradeClass = 'warning'; gradeText = 'Keep Practicing!'; }
            if (percentage < 50) { gradeClass = 'error'; gradeText = 'Needs Improvement'; }
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <button class="theme-toggle" onclick="toggleTheme(); updateStudentThemeBtn()" title="Toggle Light/Dark Mode" id="studentThemeBtn">
                        ${document.body.classList.contains('light-theme') ? '&#x1F319;' : '&#x2600;'}
                    </button>
                </div>
                <div class="success-animation">
                    <div class="checkmark" style="background: var(--${gradeClass});">&#x2713;</div>
                    <h2>Exam Submitted!</h2>
                    <p style="color: var(--text-muted);">${gradeText}</p>
                </div>
                
                <div class="score-display">
                    <div class="score-circle" style="--score-percent: ${percentage}%">
                        <span class="score-text">${percentage}%</span>
                    </div>
                    <p class="score-label">${correct} out of ${total} correct</p>
                </div>
                
                <h3 style="margin: 2rem 0 1rem;">Your Answers:</h3>
                ${details.map((d, i) => `
                    <div class="quiz-question-card ${d.isCorrect ? 'correct' : 'incorrect'}">
                        <p><strong>${i + 1}. [${d.type}]</strong> ${d.question}</p>
                        <p>Your answer: <strong>${d.studentAnswer}</strong></p>
                        ${!d.isCorrect ? `<p style="color: var(--success);">Correct answer: <strong>${d.correctAnswer}</strong></p>` : ''}
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin-top: 2rem; padding: 2rem; background: var(--bg-card); border-radius: 20px;">
                    <p style="color: var(--text-muted);">Your results have been sent to your teacher.</p>
                    <p style="color: var(--warning); margin-top: 0.5rem;">This exam link is now closed for you.</p>
                </div>
            `;
            
            if (percentage >= 70) {
                createConfetti();
            }
        }
        
        // ==================== QUIZ MODALS (Practice Mode) ====================
        function openQuizModal(type) {
            const modal = document.getElementById('modalOverlay');
            const modalEl = document.getElementById('modal');
            modalEl.classList.remove('wide');
            modal.classList.add('active');
            
            const titles = {
                fillBlank: '&#x1F4DD; Fill in the Blank',
                relatedWords: '&#x1F5BC; Picture Word Match',
                matchWords: '&#x1F517; Match the Words',
                trueFalse: '&#x2713;&#x2717; True or False'
            };
            
            document.getElementById('modalTitle').innerHTML = titles[type];
            currentView = 'main';
            renderQuizModal(type);
        }
        
        function renderQuizModal(type) {
            const body = document.getElementById('modalBody');
            
            switch(type) {
                case 'fillBlank':
                    renderFillBlankModal(body);
                    break;
                case 'relatedWords':
                    renderRelatedWordsModal(body);
                    break;
                case 'matchWords':
                    renderMatchWordsModal(body);
                    break;
                case 'trueFalse':
                    renderTrueFalseModal(body);
                    break;
            }
        }
        
        function closeModal() {
            const modal = document.getElementById('modalOverlay');
            const modalEl = document.getElementById('modal');
            modal.classList.remove('active');
            modalEl.classList.remove('wide');
            currentView = 'main';
        }
        
        // ==================== FILL IN THE BLANK ====================
        function renderFillBlankModal(body) {
            if (quizData.fillBlank.questions.length === 0 && currentView === 'main') {
                body.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#x1F4DD;</div>
                        <h3>No Quiz Created Yet</h3>
                        <p>Create sentences with blanks for students to fill in!</p>
                        <button class="btn btn-primary" onclick="showFillBlankCreate()">
                            Create Quiz
                        </button>
                    </div>
                `;
            } else if (currentView === 'main') {
                body.innerHTML = `
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('play')">Play Quiz</button>
                        <button class="tab" onclick="switchTab('edit')">Edit Quiz</button>
                    </div>
                    <div id="tabContent"></div>
                `;
                renderFillBlankPlay();
            } else if (currentView === 'create') {
                renderFillBlankCreate(body);
            }
        }
        
        function showFillBlankCreate() {
            currentView = 'create';
            renderFillBlankCreate(document.getElementById('modalBody'));
        }
        
        function renderFillBlankCreate(body) {
            const questions = quizData.fillBlank.questions;
            body.innerHTML = `
                <div id="questionsContainer">
                    ${questions.map((q, i) => renderQuestionBuilder(q, i)).join('')}
                </div>
                <button class="btn btn-secondary" onclick="addQuestion()" style="width: 100%; margin-top: 1rem;">
                    + Add Question
                </button>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="currentView='main'; renderQuizModal('fillBlank')">
                        Back
                    </button>
                    <button class="btn btn-success" onclick="saveFillBlankQuiz()" style="flex: 1;">
                        Save Quiz
                    </button>
                </div>
            `;
            
            if (questions.length === 0) {
                addQuestion();
            }
        }
        
        function renderQuestionBuilder(question = null, index = 0) {
            const q = question || { sentence: '', blankWord: '', options: ['', '', '', ''], correctIndex: 0 };
            return `
                <div class="question-builder" id="q-${index}">
                    <span class="question-number">Q${index + 1}</span>
                    <button class="remove-question" onclick="removeFillBlankQuestion(${index})">&times;</button>
                    <div class="form-group">
                        <label>Sentence (use [BLANK] where the word should be hidden)</label>
                        <input type="text" id="sentence-${index}" value="${q.sentence}" 
                            placeholder="Example: The [BLANK] is very tall.">
                    </div>
                    <div class="form-group">
                        <label>Hidden Word (correct answer)</label>
                        <input type="text" id="blankWord-${index}" value="${q.blankWord}" placeholder="giraffe">
                    </div>
                    <div class="form-group">
                        <label>Answer Options (check the correct one)</label>
                        <div class="options-container">
                            ${[0, 1, 2, 3].map(i => `
                                <div class="option-input-group">
                                    <input type="radio" name="correct-${index}" value="${i}" ${q.correctIndex === i ? 'checked' : ''}>
                                    <input type="text" id="option-${index}-${i}" value="${q.options[i] || ''}" placeholder="Option ${i + 1}">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function addQuestion() {
            const container = document.getElementById('questionsContainer');
            const index = container.children.length;
            container.insertAdjacentHTML('beforeend', renderQuestionBuilder(null, index));
        }
        
        function removeFillBlankQuestion(index) {
            const container = document.getElementById('questionsContainer');
            if (container.children.length > 1) {
                container.children[index].remove();
                const questions = collectFillBlankQuestions();
                quizData.fillBlank.questions = questions;
                renderFillBlankCreate(document.getElementById('modalBody'));
            }
        }
        
        function collectFillBlankQuestions() {
            const container = document.getElementById('questionsContainer');
            const questions = [];
            
            for (let i = 0; i < container.children.length; i++) {
                const sentence = document.getElementById(`sentence-${i}`)?.value || '';
                const blankWord = document.getElementById(`blankWord-${i}`)?.value || '';
                const options = [0, 1, 2, 3].map(j => document.getElementById(`option-${i}-${j}`)?.value || '');
                const correctRadio = document.querySelector(`input[name="correct-${i}"]:checked`);
                const correctIndex = correctRadio ? parseInt(correctRadio.value) : 0;
                
                if (sentence && blankWord) {
                    questions.push({ sentence, blankWord, options, correctIndex });
                }
            }
            
            return questions;
        }
        
        function saveFillBlankQuiz() {
            quizData.fillBlank.questions = collectFillBlankQuestions();
            saveData();
            currentView = 'main';
            renderQuizModal('fillBlank');
            createConfetti();
        }
        
        function renderFillBlankPlay() {
            const content = document.getElementById('tabContent');
            const questions = quizData.fillBlank.questions;
            
            content.innerHTML = `
                <div class="score-display">
                    <div class="score-circle" id="scoreCircle" style="--score-percent: 0%">
                        <span class="score-text" id="scoreText">0/${questions.length}</span>
                    </div>
                    <p class="score-label">Questions Answered</p>
                </div>
                <div id="questionsPlayContainer">
                    ${questions.map((q, i) => renderFillBlankPlayQuestion(q, i)).join('')}
                </div>
                <button class="btn btn-primary" onclick="resetFillBlankQuiz()" style="width: 100%; margin-top: 1rem;">
                    Reset Quiz
                </button>
            `;
        }
        
        function renderFillBlankPlayQuestion(question, index) {
            const displaySentence = question.sentence.replace('[BLANK]', 
                `<span class="blank-space" id="blank-${index}" onclick="selectBlank(${index})">???</span>`);
            
            return `
                <div class="quiz-question-card" id="card-${index}">
                    <p class="question-text">${displaySentence}</p>
                    <div class="options-grid">
                        ${question.options.filter(o => o).map((opt, i) => `
                            <button class="option-btn" onclick="selectFillBlankOption(${index}, ${i}, '${opt.replace(/'/g, "\\'")}')" 
                                id="opt-${index}-${i}">${opt}</button>
                        `).join('')}
                    </div>
                    <div id="feedback-${index}"></div>
                </div>
            `;
        }
        
        let selectedAnswers = {};
        
        function selectFillBlankOption(questionIndex, optionIndex, value) {
            const blank = document.getElementById(`blank-${questionIndex}`);
            const question = quizData.fillBlank.questions[questionIndex];
            const card = document.getElementById(`card-${questionIndex}`);
            const feedback = document.getElementById(`feedback-${questionIndex}`);
            
            blank.textContent = value;
            blank.classList.add('filled');
            
            question.options.forEach((_, i) => {
                document.getElementById(`opt-${questionIndex}-${i}`)?.classList.remove('selected');
            });
            document.getElementById(`opt-${questionIndex}-${optionIndex}`).classList.add('selected');
            
            const isCorrect = value.toLowerCase() === question.blankWord.toLowerCase();
            selectedAnswers[questionIndex] = isCorrect;
            
            if (isCorrect) {
                blank.classList.add('correct-answer');
                blank.classList.remove('wrong-answer');
                card.classList.add('correct');
                card.classList.remove('incorrect');
                feedback.innerHTML = '<div class="feedback correct">Correct! Well done!</div>';
                createConfetti();
            } else {
                blank.classList.add('wrong-answer');
                blank.classList.remove('correct-answer');
                card.classList.add('incorrect');
                card.classList.remove('correct');
                feedback.innerHTML = `<div class="feedback incorrect">Not quite! The correct answer is: ${question.blankWord}</div>`;
            }
            
            updateScore();
            
            question.options.forEach((_, i) => {
                const btn = document.getElementById(`opt-${questionIndex}-${i}`);
                if (btn) btn.disabled = true;
            });
        }
        
        function updateScore() {
            const questions = quizData.fillBlank.questions;
            const answered = Object.keys(selectedAnswers).length;
            const correct = Object.values(selectedAnswers).filter(v => v).length;
            const percent = questions.length > 0 ? (correct / questions.length) * 100 : 0;
            
            document.getElementById('scoreText').textContent = `${correct}/${questions.length}`;
            document.getElementById('scoreCircle').style.setProperty('--score-percent', `${percent}%`);
        }
        
        function resetFillBlankQuiz() {
            selectedAnswers = {};
            renderFillBlankPlay();
        }
        
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'play') {
                tabs[0].classList.add('active');
                renderFillBlankPlay();
            } else {
                tabs[1].classList.add('active');
                currentView = 'create';
                renderFillBlankCreate(document.getElementById('tabContent'));
            }
        }
        
        // ==================== RELATED WORDS (Picture Match) ====================
        function renderRelatedWordsModal(body) {
            if (quizData.relatedWords.categories.length === 0 && currentView === 'main') {
                body.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#x1F5BC;</div>
                        <h3>No Quiz Created Yet</h3>
                        <p>Create a picture-word matching quiz with images!</p>
                        <button class="btn btn-primary" onclick="showRelatedWordsCreate()">
                            Create Quiz
                        </button>
                    </div>
                `;
            } else if (currentView === 'main') {
                body.innerHTML = `
                    <div class="tabs">
                        <button class="tab active" onclick="switchRelatedTab('play')">Play Quiz</button>
                        <button class="tab" onclick="switchRelatedTab('edit')">Edit Quiz</button>
                    </div>
                    <div id="relatedTabContent"></div>
                `;
                renderRelatedWordsPlay();
            } else if (currentView === 'create') {
                renderRelatedWordsCreate(body);
            }
        }
        
        function showRelatedWordsCreate() {
            currentView = 'create';
            renderRelatedWordsCreate(document.getElementById('modalBody'));
        }
        
        function renderRelatedWordsCreate(body) {
            const categories = quizData.relatedWords.categories;
            body.innerHTML = `
                <div id="categoriesContainer">
                    ${categories.map((c, i) => renderCategoryBuilder(c, i)).join('')}
                </div>
                <button class="btn btn-secondary" onclick="addCategory()" style="width: 100%; margin-top: 1rem;">
                    + Add Category
                </button>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="currentView='main'; renderQuizModal('relatedWords')">
                        Back
                    </button>
                    <button class="btn btn-success" onclick="saveRelatedWordsQuiz()" style="flex: 1;">
                        Save Quiz
                    </button>
                </div>
            `;
            
            if (categories.length === 0) {
                addCategory();
            }
        }
        
        function renderCategoryBuilder(category = null, index = 0) {
            const c = category || { name: '', image: '', words: [] };
            return `
                <div class="category-builder" id="category-${index}">
                    <div class="category-builder-header">
                        <span style="background: var(--primary); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">
                            Category ${index + 1}
                        </span>
                        <button class="remove-question" onclick="removeCategory(${index})" style="position: relative; top: 0; right: 0;">&times;</button>
                    </div>
                    <div class="form-group">
                        <label>Category Name</label>
                        <input type="text" id="catName-${index}" value="${c.name}" placeholder="e.g., Cat, Dog, Animals">
                    </div>
                    <div class="form-group">
                        <label>Image</label>
                        <div class="image-upload-zone" onclick="document.getElementById('imgInput-${index}').click()">
                            <input type="file" id="imgInput-${index}" accept="image/*" onchange="handleImageUpload(${index}, this)">
                            <div id="imgPreview-${index}">
                                ${c.image ? `<img src="${c.image}" style="max-width: 150px; border-radius: 12px;">` : 'Click to upload image'}
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Words that belong to this category</label>
                        <div class="tags-input" id="tagsContainer-${index}">
                            ${c.words.map(w => `
                                <span class="tag">${w} <button onclick="removeWord(${index}, '${escapeHtml(w)}')">&times;</button></span>
                            `).join('')}
                            <input type="text" id="wordInput-${index}" placeholder="Type word and press Enter" 
                                onkeypress="handleWordInput(event, ${index})">
                        </div>
                        <p class="form-hint">Press Enter to add each word</p>
                    </div>
                </div>
            `;
        }
        
        let tempCategoryData = {};
        
        function handleImageUpload(index, input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById(`imgPreview-${index}`);
                    preview.innerHTML = `<img src="${e.target.result}" style="max-width: 150px; border-radius: 12px;">`;
                    if (!tempCategoryData[index]) tempCategoryData[index] = {};
                    tempCategoryData[index].image = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function handleWordInput(event, index) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById(`wordInput-${index}`);
                const word = input.value.trim();
                if (word) {
                    if (!tempCategoryData[index]) tempCategoryData[index] = { words: [] };
                    if (!tempCategoryData[index].words) tempCategoryData[index].words = [];
                    tempCategoryData[index].words.push(word);
                    
                    const container = document.getElementById(`tagsContainer-${index}`);
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.innerHTML = `${word} <button onclick="removeWord(${index}, '${escapeHtml(word)}')">&times;</button>`;
                    container.insertBefore(tag, input);
                    input.value = '';
                }
            }
        }
        
        function removeWord(index, word) {
            if (tempCategoryData[index] && tempCategoryData[index].words) {
                tempCategoryData[index].words = tempCategoryData[index].words.filter(w => w !== word);
            }
            const container = document.getElementById(`tagsContainer-${index}`);
            const tags = container.querySelectorAll('.tag');
            tags.forEach(tag => {
                if (tag.textContent.includes(word)) tag.remove();
            });
        }
        
        function addCategory() {
            const container = document.getElementById('categoriesContainer');
            const index = container.children.length;
            container.insertAdjacentHTML('beforeend', renderCategoryBuilder(null, index));
        }
        
        function removeCategory(index) {
            const container = document.getElementById('categoriesContainer');
            if (container.children.length > 1) {
                container.children[index].remove();
                delete tempCategoryData[index];
            }
        }
        
        function collectCategories() {
            const container = document.getElementById('categoriesContainer');
            const categories = [];
            
            for (let i = 0; i < container.children.length; i++) {
                const name = document.getElementById(`catName-${i}`)?.value || '';
                const image = tempCategoryData[i]?.image || quizData.relatedWords.categories[i]?.image || '';
                const words = tempCategoryData[i]?.words || quizData.relatedWords.categories[i]?.words || [];
                
                const tagsContainer = document.getElementById(`tagsContainer-${i}`);
                if (tagsContainer) {
                    const existingTags = tagsContainer.querySelectorAll('.tag');
                    existingTags.forEach(tag => {
                        const word = tag.textContent.replace('x', '').trim();
                        if (word && !words.includes(word)) {
                            words.push(word);
                        }
                    });
                }
                
                if (name && words.length > 0) {
                    categories.push({ name, image, words: [...new Set(words)] });
                }
            }
            
            return categories;
        }
        
        function saveRelatedWordsQuiz() {
            quizData.relatedWords.categories = collectCategories();
            saveData();
            tempCategoryData = {};
            currentView = 'main';
            renderQuizModal('relatedWords');
            createConfetti();
        }
        
        function switchRelatedTab(tab) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'play') {
                tabs[0].classList.add('active');
                renderRelatedWordsPlay();
            } else {
                tabs[1].classList.add('active');
                currentView = 'create';
                tempCategoryData = {};
                quizData.relatedWords.categories.forEach((c, i) => {
                    tempCategoryData[i] = { image: c.image, words: [...c.words] };
                });
                renderRelatedWordsCreate(document.getElementById('relatedTabContent'));
            }
        }
        
        // Play Related Words Quiz - Click to Select Mode
        let selectedWordIdx = null;
        let allWordsArray = [];
        let categoriesArray = [];
        let wordToCategoryMap = {};
        let droppedWords = {};
        
        function renderRelatedWordsPlay() {
            const content = document.getElementById('relatedTabContent');
            categoriesArray = quizData.relatedWords.categories;
            
            allWordsArray = [];
            wordToCategoryMap = {};
            droppedWords = {};
            selectedWordIdx = null;
            
            categoriesArray.forEach((cat, catIdx) => {
                droppedWords[catIdx] = [];
                cat.words.forEach(word => {
                    const wordIdx = allWordsArray.length;
                    allWordsArray.push(word);
                    wordToCategoryMap[wordIdx] = catIdx;
                });
            });
            
            let shuffledIndices = allWordsArray.map((_, i) => i).sort(() => Math.random() - 0.5);
            
            content.innerHTML = `
                <div class="score-display">
                    <div class="score-circle" id="relatedScoreCircle" style="--score-percent: 0%">
                        <span class="score-text" id="relatedScoreText">0/${allWordsArray.length}</span>
                    </div>
                    <p class="score-label">Words Sorted</p>
                </div>
                <p style="text-align: center; color: var(--accent); margin-bottom: 1rem; font-weight: 500;" id="instruction">
                    Click a word, then click the picture it belongs to
                </p>
                <div class="match-container">
                    ${categoriesArray.map((cat, catIdx) => `
                        <div class="match-column">
                            <div class="image-drop-zone" id="drop-${catIdx}" data-category="${catIdx}">
                                ${cat.image ? `<img src="${cat.image}" alt="${cat.name}">` : ''}
                                <h5>${cat.name}</h5>
                                <div class="dropped-words" id="dropped-${catIdx}"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <h4 style="margin: 1.5rem 0 0.75rem; color: var(--text-muted);">Click a word to select it</h4>
                <div class="word-bank" id="wordBank">
                    ${shuffledIndices.map(wordIdx => `
                        <span class="word-chip" id="word-${wordIdx}" data-word="${wordIdx}">${allWordsArray[wordIdx]}</span>
                    `).join('')}
                </div>
                <button class="btn btn-primary" onclick="resetRelatedWordsQuiz()" style="width: 100%; margin-top: 1.5rem;">
                    Reset Quiz
                </button>
            `;
            
            document.querySelectorAll('#wordBank .word-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    const wordIdx = parseInt(this.dataset.word);
                    handleWordClick(wordIdx);
                });
            });
            
            document.querySelectorAll('.image-drop-zone').forEach(zone => {
                zone.addEventListener('click', function() {
                    const catIdx = parseInt(this.dataset.category);
                    handleCategoryClick(catIdx);
                });
            });
        }
        
        function handleWordClick(wordIdx) {
            document.querySelectorAll('#wordBank .word-chip').forEach(c => c.classList.remove('selected'));
            
            const chip = document.getElementById(`word-${wordIdx}`);
            chip.classList.add('selected');
            selectedWordIdx = wordIdx;
            
            document.querySelectorAll('.image-drop-zone').forEach(zone => zone.classList.add('selectable'));
            document.getElementById('instruction').textContent = 'Now click the category for this word';
        }
        
        function handleCategoryClick(catIdx) {
            if (selectedWordIdx === null) {
                document.getElementById('instruction').textContent = 'First, click a word to select it!';
                document.getElementById('instruction').style.color = 'var(--warning)';
                return;
            }
            
            const wordChip = document.getElementById(`word-${selectedWordIdx}`);
            const dropZone = document.getElementById(`dropped-${catIdx}`);
            const correctCategory = wordToCategoryMap[selectedWordIdx];
            
            const newChip = wordChip.cloneNode(true);
            newChip.classList.remove('selected');
            
            if (catIdx === correctCategory) {
                newChip.classList.add('correct');
                document.getElementById('instruction').textContent = 'Correct! Keep going!';
                document.getElementById('instruction').style.color = 'var(--success)';
                createConfetti();
            } else {
                newChip.classList.add('incorrect');
                document.getElementById('instruction').textContent = `Wrong! "${allWordsArray[selectedWordIdx]}" belongs to "${categoriesArray[correctCategory].name}"`;
                document.getElementById('instruction').style.color = 'var(--error)';
            }
            
            dropZone.appendChild(newChip);
            wordChip.style.display = 'none';
            droppedWords[catIdx].push(selectedWordIdx);
            
            document.querySelectorAll('.image-drop-zone').forEach(zone => zone.classList.remove('selectable'));
            selectedWordIdx = null;
            
            updateRelatedScore();
        }
        
        function updateRelatedScore() {
            let correct = 0;
            let total = 0;
            
            Object.entries(droppedWords).forEach(([catIdx, words]) => {
                words.forEach(wordIdx => {
                    total++;
                    if (wordToCategoryMap[wordIdx] === parseInt(catIdx)) {
                        correct++;
                    }
                });
            });
            
            const percent = allWordsArray.length > 0 ? (correct / allWordsArray.length) * 100 : 0;
            document.getElementById('relatedScoreText').textContent = `${correct}/${allWordsArray.length}`;
            document.getElementById('relatedScoreCircle').style.setProperty('--score-percent', `${percent}%`);
        }
        
        function resetRelatedWordsQuiz() {
            renderRelatedWordsPlay();
        }
        
        // ==================== MATCH WORDS ====================
        function renderMatchWordsModal(body) {
            if (quizData.matchWords.pairs.length === 0 && currentView === 'main') {
                body.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#x1F517;</div>
                        <h3>No Quiz Created Yet</h3>
                        <p>Create word pairs for matching - great for translations!</p>
                        <button class="btn btn-primary" onclick="showMatchWordsCreate()">
                            Create Quiz
                        </button>
                    </div>
                `;
            } else if (currentView === 'main') {
                body.innerHTML = `
                    <div class="tabs">
                        <button class="tab active" onclick="switchMatchTab('play')">Play Quiz</button>
                        <button class="tab" onclick="switchMatchTab('edit')">Edit Quiz</button>
                    </div>
                    <div id="matchTabContent"></div>
                `;
                renderMatchWordsPlay();
            } else if (currentView === 'create') {
                renderMatchWordsCreate(body);
            }
        }
        
        function showMatchWordsCreate() {
            currentView = 'create';
            renderMatchWordsCreate(document.getElementById('modalBody'));
        }
        
        function renderMatchWordsCreate(body) {
            const pairs = quizData.matchWords.pairs;
            body.innerHTML = `
                <div id="pairsContainer">
                    ${pairs.map((p, i) => renderPairBuilder(p, i)).join('')}
                </div>
                <button class="btn btn-secondary" onclick="addPair()" style="width: 100%; margin-top: 1rem;">
                    + Add Word Pair
                </button>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="currentView='main'; renderQuizModal('matchWords')">
                        Back
                    </button>
                    <button class="btn btn-success" onclick="saveMatchWordsQuiz()" style="flex: 1;">
                        Save Quiz
                    </button>
                </div>
            `;
            
            if (pairs.length === 0) {
                addPair();
            }
        }
        
        function renderPairBuilder(pair = null, index = 0) {
            const p = pair || { word1: '', word2: '' };
            return `
                <div class="question-builder" id="pair-${index}" style="display: flex; gap: 1rem; align-items: center;">
                    <span class="question-number">${index + 1}</span>
                    <input type="text" id="word1-${index}" value="${p.word1}" placeholder="Word 1 (e.g., Apple)" style="flex: 1;">
                    <span style="font-size: 1.5rem;">&#x2194;</span>
                    <input type="text" id="word2-${index}" value="${p.word2}" placeholder="Word 2 (e.g., Pomme)" style="flex: 1;">
                    <button class="remove-question" onclick="removePair(${index})" style="position: relative; top: 0; right: 0;">&times;</button>
                </div>
            `;
        }
        
        function addPair() {
            const container = document.getElementById('pairsContainer');
            const index = container.children.length;
            container.insertAdjacentHTML('beforeend', renderPairBuilder(null, index));
        }
        
        function removePair(index) {
            const container = document.getElementById('pairsContainer');
            if (container.children.length > 1) {
                container.children[index].remove();
            }
        }
        
        function collectPairs() {
            const container = document.getElementById('pairsContainer');
            const pairs = [];
            
            for (let i = 0; i < container.children.length; i++) {
                const word1 = document.getElementById(`word1-${i}`)?.value || '';
                const word2 = document.getElementById(`word2-${i}`)?.value || '';
                
                if (word1 && word2) {
                    pairs.push({ word1, word2 });
                }
            }
            
            return pairs;
        }
        
        function saveMatchWordsQuiz() {
            quizData.matchWords.pairs = collectPairs();
            saveData();
            currentView = 'main';
            renderQuizModal('matchWords');
            createConfetti();
        }
        
        function switchMatchTab(tab) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'play') {
                tabs[0].classList.add('active');
                renderMatchWordsPlay();
            } else {
                tabs[1].classList.add('active');
                currentView = 'create';
                renderMatchWordsCreate(document.getElementById('matchTabContent'));
            }
        }
        
        let matchedPairsTeacher = [];
        let selectedWord = null;
        
        function renderMatchWordsPlay() {
            const content = document.getElementById('matchTabContent');
            const pairs = quizData.matchWords.pairs;
            matchedPairsTeacher = [];
            selectedWord = null;
            
            const leftWords = pairs.map((p, i) => ({ word: p.word1, id: i })).sort(() => Math.random() - 0.5);
            const rightWords = pairs.map((p, i) => ({ word: p.word2, id: i })).sort(() => Math.random() - 0.5);
            
            content.innerHTML = `
                <div class="score-display">
                    <div class="score-circle" id="matchScoreCircle" style="--score-percent: 0%">
                        <span class="score-text" id="matchScoreText">0/${pairs.length}</span>
                    </div>
                    <p class="score-label">Pairs Matched</p>
                </div>
                <p style="text-align: center; color: var(--accent); margin-bottom: 1rem;">Click one word, then click its match!</p>
                <div class="match-container">
                    <div class="match-column">
                        <h4>Column A</h4>
                        ${leftWords.map(w => `
                            <button class="option-btn" style="width: 100%; margin-bottom: 0.5rem;"
                                id="left-${w.id}" data-id="${w.id}" data-side="left"
                                onclick="selectMatchWord(this, ${w.id}, 'left')">${w.word}</button>
                        `).join('')}
                    </div>
                    <div class="match-column">
                        <h4>Column B</h4>
                        ${rightWords.map(w => `
                            <button class="option-btn" style="width: 100%; margin-bottom: 0.5rem;"
                                id="right-${w.id}" data-id="${w.id}" data-side="right"
                                onclick="selectMatchWord(this, ${w.id}, 'right')">${w.word}</button>
                        `).join('')}
                    </div>
                </div>
                <div id="matchFeedback" style="margin-top: 1rem;"></div>
                <button class="btn btn-primary" onclick="resetMatchWordsQuiz()" style="width: 100%; margin-top: 1rem;">
                    Reset Quiz
                </button>
            `;
        }
        
        function selectMatchWord(element, id, side) {
            if (element.disabled) return;
            
            if (!selectedWord) {
                selectedWord = { element, id, side };
                element.classList.add('selected');
                return;
            }
            
            if (selectedWord.side === side) {
                selectedWord.element.classList.remove('selected');
                selectedWord = { element, id, side };
                element.classList.add('selected');
                return;
            }
            
            const isMatch = selectedWord.id === id;
            
            if (isMatch) {
                selectedWord.element.classList.add('selected');
                selectedWord.element.disabled = true;
                element.classList.add('selected');
                element.disabled = true;
                
                selectedWord.element.style.background = 'var(--success)';
                selectedWord.element.style.borderColor = 'var(--success)';
                element.style.background = 'var(--success)';
                element.style.borderColor = 'var(--success)';
                
                matchedPairsTeacher.push(id);
                createConfetti();
                
                const total = quizData.matchWords.pairs.length;
                const percent = (matchedPairsTeacher.length / total) * 100;
                document.getElementById('matchScoreText').textContent = `${matchedPairsTeacher.length}/${total}`;
                document.getElementById('matchScoreCircle').style.setProperty('--score-percent', `${percent}%`);
                
                document.getElementById('matchFeedback').innerHTML = '<div class="feedback correct">Great match!</div>';
            } else {
                document.getElementById('matchFeedback').innerHTML = '<div class="feedback incorrect">Try again!</div>';
                element.style.animation = 'shake 0.5s ease';
                selectedWord.element.style.animation = 'shake 0.5s ease';
                setTimeout(() => {
                    element.style.animation = '';
                    selectedWord.element.style.animation = '';
                }, 500);
            }
            
            selectedWord.element.classList.remove('selected');
            selectedWord = null;
        }
        
        function resetMatchWordsQuiz() {
            renderMatchWordsPlay();
        }
        
        // ==================== TRUE/FALSE ====================
        function renderTrueFalseModal(body) {
            if (quizData.trueFalse.questions.length === 0 && currentView === 'main') {
                body.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#x2713;&#x2717;</div>
                        <h3>No Quiz Created Yet</h3>
                        <p>Create true/false statements for your students!</p>
                        <button class="btn btn-primary" onclick="showTrueFalseCreate()">
                            Create Quiz
                        </button>
                    </div>
                `;
            } else if (currentView === 'main') {
                body.innerHTML = `
                    <div class="tabs">
                        <button class="tab active" onclick="switchTFTab('play')">Play Quiz</button>
                        <button class="tab" onclick="switchTFTab('edit')">Edit Quiz</button>
                    </div>
                    <div id="tfTabContent"></div>
                `;
                renderTrueFalsePlay();
            } else if (currentView === 'create') {
                renderTrueFalseCreate(body);
            }
        }
        
        function showTrueFalseCreate() {
            currentView = 'create';
            renderTrueFalseCreate(document.getElementById('modalBody'));
        }
        
        function renderTrueFalseCreate(body) {
            const questions = quizData.trueFalse.questions;
            body.innerHTML = `
                <div id="tfQuestionsContainer">
                    ${questions.map((q, i) => renderTFQuestion(q, i)).join('')}
                </div>
                <button class="btn btn-secondary" onclick="addTFQuestion()" style="width: 100%; margin-top: 1rem;">
                    + Add Question
                </button>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="currentView='main'; renderQuizModal('trueFalse')">
                        Back
                    </button>
                    <button class="btn btn-success" onclick="saveTrueFalseQuiz()" style="flex: 1;">
                        Save Quiz
                    </button>
                </div>
            `;
            
            if (questions.length === 0) {
                addTFQuestion();
            }
        }
        
        function renderTFQuestion(question = null, index = 0) {
            const q = question || { statement: '', isTrue: true };
            return `
                <div class="question-builder" id="tf-${index}">
                    <span class="question-number">Q${index + 1}</span>
                    <button class="remove-question" onclick="removeTFQuestion(${index})">&times;</button>
                    <div class="form-group">
                        <label>Statement</label>
                        <textarea id="tfStatement-${index}" placeholder="Enter a statement...">${q.statement}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Correct Answer</label>
                        <div style="display: flex; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="tfAnswer-${index}" value="true" ${q.isTrue ? 'checked' : ''}>
                                <span style="color: var(--success);">True</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="tfAnswer-${index}" value="false" ${!q.isTrue ? 'checked' : ''}>
                                <span style="color: var(--error);">False</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function addTFQuestion() {
            const container = document.getElementById('tfQuestionsContainer');
            const index = container.children.length;
            container.insertAdjacentHTML('beforeend', renderTFQuestion(null, index));
        }
        
        function removeTFQuestion(index) {
            const container = document.getElementById('tfQuestionsContainer');
            if (container.children.length > 1) {
                container.children[index].remove();
            }
        }
        
        function collectTFQuestions() {
            const container = document.getElementById('tfQuestionsContainer');
            const questions = [];
            
            for (let i = 0; i < container.children.length; i++) {
                const statement = document.getElementById(`tfStatement-${i}`)?.value || '';
                const answerRadio = document.querySelector(`input[name="tfAnswer-${i}"]:checked`);
                const isTrue = answerRadio ? answerRadio.value === 'true' : true;
                
                if (statement) {
                    questions.push({ statement, isTrue });
                }
            }
            
            return questions;
        }
        
        function saveTrueFalseQuiz() {
            quizData.trueFalse.questions = collectTFQuestions();
            saveData();
            currentView = 'main';
            renderQuizModal('trueFalse');
            createConfetti();
        }
        
        function switchTFTab(tab) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'play') {
                tabs[0].classList.add('active');
                renderTrueFalsePlay();
            } else {
                tabs[1].classList.add('active');
                currentView = 'create';
                renderTrueFalseCreate(document.getElementById('tfTabContent'));
            }
        }
        
        let tfAnswers = {};
        
        function renderTrueFalsePlay() {
            const content = document.getElementById('tfTabContent');
            const questions = quizData.trueFalse.questions;
            tfAnswers = {};
            
            content.innerHTML = `
                <div class="score-display">
                    <div class="score-circle" id="tfScoreCircle" style="--score-percent: 0%">
                        <span class="score-text" id="tfScoreText">0/${questions.length}</span>
                    </div>
                    <p class="score-label">Questions Answered</p>
                </div>
                <div id="tfPlayContainer">
                    ${questions.map((q, i) => `
                        <div class="quiz-question-card" id="tfCard-${i}">
                            <p class="question-text">${q.statement}</p>
                            <div class="tf-buttons">
                                <button class="tf-btn true" id="tfTrue-${i}" onclick="answerTF(${i}, true)">
                                    TRUE
                                </button>
                                <button class="tf-btn false" id="tfFalse-${i}" onclick="answerTF(${i}, false)">
                                    FALSE
                                </button>
                            </div>
                            <div id="tfFeedback-${i}"></div>
                        </div>
                    `).join('')}
                </div>
                <button class="btn btn-primary" onclick="resetTFQuiz()" style="width: 100%; margin-top: 1.5rem;">
                    Reset Quiz
                </button>
            `;
        }
        
        function answerTF(index, answer) {
            const question = quizData.trueFalse.questions[index];
            const isCorrect = question.isTrue === answer;
            
            const trueBtn = document.getElementById(`tfTrue-${index}`);
            const falseBtn = document.getElementById(`tfFalse-${index}`);
            const card = document.getElementById(`tfCard-${index}`);
            const feedback = document.getElementById(`tfFeedback-${index}`);
            
            tfAnswers[index] = isCorrect;
            
            trueBtn.disabled = true;
            falseBtn.disabled = true;
            
            if (answer) {
                trueBtn.classList.add('selected');
            } else {
                falseBtn.classList.add('selected');
            }
            
            if (isCorrect) {
                card.classList.add('correct');
                feedback.innerHTML = '<div class="feedback correct">Correct!</div>';
                createConfetti();
            } else {
                card.classList.add('incorrect');
                const correctAnswer = question.isTrue ? 'TRUE' : 'FALSE';
                feedback.innerHTML = `<div class="feedback incorrect">The correct answer is: ${correctAnswer}</div>`;
            }
            
            const total = quizData.trueFalse.questions.length;
            const correct = Object.values(tfAnswers).filter(v => v).length;
            const percent = (correct / total) * 100;
            
            document.getElementById('tfScoreText').textContent = `${correct}/${total}`;
            document.getElementById('tfScoreCircle').style.setProperty('--score-percent', `${percent}%`);
        }
        
        function resetTFQuiz() {
            renderTrueFalsePlay();
        }
        
        // ==================== EFFECTS ====================
        function createConfetti() {
            const container = document.getElementById('confetti');
            const colors = ['#8b5cf6', '#f472b6', '#22d3ee', '#10b981', '#fbbf24'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                container.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }
        
        function createParticles() {
            const container = document.getElementById('particles');
            const colors = ['#8b5cf6', '#f472b6', '#22d3ee', '#fbbf24'];
            
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 15) + 's';
                container.appendChild(particle);
            }
        }
        
        // Add shake animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(style);
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            loadTheme();
            createParticles();
            
            if (!checkStudentMode()) {
                renderTeacherHome();
            }
        });
        
        // Close modal on overlay click
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeModal();
            }
        });
        
        // Escape key closes modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>


