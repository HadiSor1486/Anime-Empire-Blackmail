<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arabic by Rolla</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Fredoka+One&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --secondary: #f472b6;
            --accent: #22d3ee;
            --accent2: #fbbf24;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        /* Light Theme */
        .light-theme {
            --primary: #ec4899;
            --primary-dark: #db2777;
            --secondary: #f97316;
            --accent: #06b6d4;
            --accent2: #eab308;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #fdf2f8;
            --bg-card: #ffffff;
            --bg-card-hover: #fce7f3;
            --text: #1f2937;
            --text-muted: #6b7280;
            --gradient-1: linear-gradient(135deg, #f472b6 0%, #ec4899 100%);
            --gradient-2: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
            --gradient-3: linear-gradient(135deg, #67e8f9 0%, #06b6d4 100%);
            --gradient-4: linear-gradient(135deg, #86efac 0%, #22c55e 100%);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }
        
        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        .bg-animation::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background: radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(244, 114, 182, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(34, 211, 238, 0.1) 0%, transparent 40%),
                        radial-gradient(circle at 60% 60%, rgba(251, 191, 36, 0.08) 0%, transparent 35%);
            animation: bgMove 20s ease-in-out infinite;
        }
        
        .light-theme .bg-animation::before {
            background: radial-gradient(circle at 20% 80%, rgba(236, 72, 153, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(249, 115, 22, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(6, 182, 212, 0.1) 0%, transparent 40%),
                        radial-gradient(circle at 60% 60%, rgba(234, 179, 8, 0.08) 0%, transparent 35%);
        }
        
        @keyframes bgMove {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(2%, 2%) rotate(1deg); }
            50% { transform: translate(0, 4%) rotate(0deg); }
            75% { transform: translate(-2%, 2%) rotate(-1deg); }
        }
        
        /* Floating Particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            opacity: 0.3;
            animation: float 15s infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(30, 41, 59, 0.8) 100%);
            backdrop-filter: blur(20px);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .light-theme .header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(253, 242, 248, 0.9) 100%);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .logo h1 {
            font-family: 'Fredoka One', cursive;
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        /* Theme Toggle Button */
        .theme-toggle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            border-color: var(--primary);
        }
        
        .theme-toggle .icon-sun,
        .theme-toggle .icon-moon {
            position: absolute;
            transition: all 0.3s ease;
        }
        
        .theme-toggle .icon-sun {
            opacity: 0;
            transform: scale(0) rotate(-180deg);
        }
        
        .theme-toggle .icon-moon {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }
        
        .light-theme .theme-toggle .icon-sun {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }
        
        .light-theme .theme-toggle .icon-moon {
            opacity: 0;
            transform: scale(0) rotate(180deg);
        }
        
        .light-theme .theme-toggle {
            background: var(--bg-card);
            border-color: rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.2);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(239, 68, 68, 0.5);
        }
        
        .btn-secondary {
            background: var(--bg-card-hover);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .light-theme .btn-secondary {
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5);
        }
        
        .btn-accent {
            background: linear-gradient(135deg, var(--accent2) 0%, #f59e0b 100%);
            color: #1e293b;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
        }
        
        .btn-accent:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(251, 191, 36, 0.5);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            font-size: 1rem;
            padding: 1rem 2rem;
        }
        
        .btn-gradient:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
        }
        
        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Quiz Type Cards */
        .quiz-types-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .quiz-card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .quiz-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .quiz-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: var(--primary);
            box-shadow: 0 20px 40px rgba(139, 92, 246, 0.2);
        }
        
        .quiz-card:hover::before {
            opacity: 1;
        }
        
        .quiz-card-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .quiz-card-icon.fill-blank {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        }
        
        .quiz-card-icon.related-words {
            background: linear-gradient(135deg, #f472b6 0%, #ec4899 100%);
        }
        
        .quiz-card-icon.match-words {
            background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%);
        }
        
        .quiz-card-icon.true-false {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }
        
        .quiz-card h3 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .quiz-card p {
            color: var(--text-muted);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .quiz-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-ready {
            background: var(--success);
            color: white;
        }
        
        .badge-empty {
            background: var(--bg-card-hover);
            color: var(--text-muted);
        }
        
        /* Create Exam Card */
        .create-exam-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(240, 147, 251, 0.2) 100%);
            border: 2px dashed var(--primary);
            border-radius: 24px;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            grid-column: 1 / -1;
            margin-bottom: 1rem;
        }
        
        .create-exam-card:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(240, 147, 251, 0.3) 100%);
            transform: scale(1.02);
            border-style: solid;
        }
        
        .create-exam-card h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 2rem;
        }
        
        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal {
            background: var(--bg-card);
            border-radius: 24px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .modal.wide {
            max-width: 1100px;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }
        
        .light-theme .modal-header {
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--bg-card-hover);
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: var(--error);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
        }
        
        .empty-state-icon {
            width: 120px;
            height: 120px;
            background: var(--bg-card-hover);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 1.5rem;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .empty-state p {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--bg-dark);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .light-theme .form-group input,
        .light-theme .form-group textarea {
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
        
        /* Question Builder */
        .question-builder {
            background: var(--bg-dark);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.05);
            position: relative;
        }
        
        .question-builder:hover {
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .question-number {
            position: absolute;
            top: -10px;
            left: 1rem;
            background: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
        }
        
        .remove-question {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0.5;
            transition: all 0.3s ease;
        }
        
        .remove-question:hover {
            opacity: 1;
            background: rgba(239, 68, 68, 0.2);
        }
        
        .options-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .option-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .option-input-group input[type="text"] {
            flex: 1;
        }
        
        .option-input-group input[type="radio"],
        .option-input-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--success);
        }
        
        /* Quiz Play View */
        .quiz-play {
            padding: 2rem;
        }
        
        .quiz-question-card {
            background: var(--bg-dark);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .light-theme .quiz-question-card {
            background: var(--bg-card);
            border-color: rgba(0, 0, 0, 0.05);
        }
        
        .quiz-question-card.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .quiz-question-card.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .quiz-question-card.answered {
            border-color: var(--accent);
            background: rgba(34, 211, 238, 0.1);
        }
        
        .question-text {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            line-height: 1.8;
        }
        
        .blank-space {
            display: inline-block;
            min-width: 120px;
            padding: 0.25rem 0.5rem;
            background: var(--primary);
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        
        .blank-space:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }
        
        .blank-space.filled {
            background: var(--accent);
            color: #1e293b;
        }
        
        .blank-space.filled:hover::after {
            content: ' (click to clear)';
            font-size: 0.7rem;
            opacity: 0.8;
        }
        
        .blank-space.correct-answer {
            background: var(--success);
        }
        
        .blank-space.wrong-answer {
            background: var(--error);
        }
        
        .options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .option-btn {
            padding: 0.75rem 1.25rem;
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text);
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .light-theme .option-btn {
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        .option-btn:hover:not(:disabled) {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.2);
        }
        
        .option-btn.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .option-btn.used {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .option-btn.correct {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .option-btn.wrong {
            background: var(--error);
            border-color: var(--error);
            color: white;
        }
        
        .option-btn:disabled {
            cursor: not-allowed;
        }
        
        /* Match Words Styles */
        .match-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .match-column {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .match-column h4 {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            text-align: center;
        }
        
        .match-item {
            padding: 1rem 1.25rem;
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
            position: relative;
        }
        
        .light-theme .match-item {
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        .match-item:hover:not(.matched):not(.disabled) {
            border-color: var(--primary);
            transform: scale(1.02);
        }
        
        .match-item.selected {
            border-color: var(--accent);
            background: rgba(34, 211, 238, 0.2);
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.3);
        }
        
        .match-item.matched {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.2);
            cursor: pointer;
        }
        
        .match-item.matched:hover::after {
            content: ' (click to unmatch)';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
        }
        
        .match-item.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.3);
        }
        
        .match-item.wrong {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.3);
        }
        
        .match-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .match-number {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
        }
        
        /* True False Styles */
        .tf-options {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .tf-btn {
            flex: 1;
            padding: 1.25rem;
            border-radius: 16px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: var(--bg-card);
            color: var(--text);
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .light-theme .tf-btn {
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        .tf-btn:hover:not(:disabled) {
            transform: translateY(-3px);
        }
        
        .tf-btn.true-btn:hover:not(:disabled) {
            border-color: var(--success);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .tf-btn.false-btn:hover:not(:disabled) {
            border-color: var(--error);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }
        
        .tf-btn.selected.true-btn {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .tf-btn.selected.false-btn {
            background: var(--error);
            border-color: var(--error);
            color: white;
        }
        
        .tf-btn.correct {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .tf-btn.wrong {
            background: var(--error);
            border-color: var(--error);
            color: white;
        }
        
        .tf-btn:disabled {
            cursor: not-allowed;
        }
        
        /* Related Words / Picture Matching */
        .picture-container {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .picture-container img {
            max-width: 300px;
            max-height: 250px;
            border-radius: 16px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            object-fit: contain;
            background: var(--bg-card);
        }
        
        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 16px;
            margin-top: 1rem;
            min-height: 60px;
        }
        
        .word-chip {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .word-chip:hover:not(.used) {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        
        .word-chip.used {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .drop-zone {
            min-height: 50px;
            border: 2px dashed var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 1rem;
            padding: 0.5rem;
            gap: 0.5rem;
            flex-wrap: wrap;
            transition: all 0.3s ease;
        }
        
        .drop-zone.has-items {
            border-style: solid;
            background: rgba(139, 92, 246, 0.1);
        }
        
        .placed-word {
            padding: 0.5rem 1rem;
            background: var(--accent);
            border-radius: 20px;
            color: #1e293b;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .placed-word:hover::after {
            content: ' x';
            font-weight: bold;
        }
        
        .placed-word.correct {
            background: var(--success);
            color: white;
        }
        
        .placed-word.wrong {
            background: var(--error);
            color: white;
        }
        
        /* Quiz List */
        .quiz-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .quiz-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            background: var(--bg-dark);
            border-radius: 16px;
            border: 2px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .light-theme .quiz-list-item {
            background: var(--bg-card);
            border-color: rgba(0, 0, 0, 0.05);
        }
        
        .quiz-list-item:hover {
            border-color: var(--primary);
        }
        
        .quiz-list-item-info h4 {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }
        
        .quiz-list-item-info p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .quiz-list-item-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .quiz-list-item-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
        
        /* Exam Selection */
        .exam-selector {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .exam-type-checkbox {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: var(--bg-dark);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .light-theme .exam-type-checkbox {
            background: var(--bg-card);
        }
        
        .exam-type-checkbox:hover {
            border-color: var(--primary);
        }
        
        .exam-type-checkbox.selected {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .exam-type-checkbox input {
            width: 24px;
            height: 24px;
            accent-color: var(--success);
        }
        
        .exam-type-checkbox .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .exam-type-checkbox .info {
            flex: 1;
        }
        
        .exam-type-checkbox .info h4 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .exam-type-checkbox .info p {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        /* Progress Bar */
        .progress-container {
            margin-bottom: 2rem;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .progress-bar {
            height: 12px;
            background: var(--bg-card);
            border-radius: 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 20px;
            transition: width 0.5s ease;
        }
        
        /* Results */
        .results-container {
            text-align: center;
            padding: 2rem;
        }
        
        .results-score {
            font-size: 5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }
        
        .results-message {
            font-size: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .results-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .result-stat {
            background: var(--bg-dark);
            padding: 1.5rem;
            border-radius: 16px;
        }
        
        .light-theme .result-stat {
            background: var(--bg-card);
        }
        
        .result-stat .number {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .result-stat .label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .result-stat.correct .number {
            color: var(--success);
        }
        
        .result-stat.wrong .number {
            color: var(--error);
        }
        
        /* Link Display */
        .link-display {
            background: var(--bg-dark);
            padding: 1rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .light-theme .link-display {
            background: var(--bg-card);
        }
        
        .link-display input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--accent);
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .link-display input:focus {
            outline: none;
        }
        
        /* Student Info Form */
        .student-form {
            max-width: 500px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .student-form h2 {
            text-align: center;
            margin-bottom: 0.5rem;
            font-size: 2rem;
        }
        
        .student-form .subtitle {
            text-align: center;
            color: var(--text-muted);
            margin-bottom: 2rem;
        }
        
        .warning-box {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--error);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            color: var(--error);
            text-align: center;
            font-weight: 500;
        }
        
        .info-box {
            background: rgba(34, 211, 238, 0.1);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            color: var(--accent);
            text-align: center;
        }
        
        /* Error States */
        .error-container {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .error-icon {
            width: 120px;
            height: 120px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 1.5rem;
        }
        
        .error-container h2 {
            color: var(--error);
            margin-bottom: 0.5rem;
        }
        
        .error-container p {
            color: var(--text-muted);
        }
        
        /* Already Submitted */
        .already-submitted {
            text-align: center;
            padding: 3rem 2rem;
        }
        
        .already-submitted-icon {
            width: 120px;
            height: 120px;
            background: rgba(251, 191, 36, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 1.5rem;
        }
        
        .already-submitted h2 {
            color: var(--warning);
            margin-bottom: 1rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .header-actions {
                width: 100%;
                justify-content: center;
            }
            
            .main-container {
                padding: 1rem;
            }
            
            .quiz-types-grid {
                grid-template-columns: 1fr;
            }
            
            .match-container {
                grid-template-columns: 1fr;
            }
            
            .modal {
                margin: 1rem;
                max-height: 95vh;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .tf-options {
                flex-direction: column;
            }
            
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }
            
            .quiz-list-item {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .quiz-list-item-actions {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--bg-card-hover);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        .slide-up {
            animation: slideUp 0.5s ease;
        }
        
        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            animation: confetti-fall 3s linear forwards;
        }
        
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* Notification Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 2000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        
        .toast.success {
            border-left: 4px solid var(--success);
        }
        
        .toast.error {
            border-left: 4px solid var(--error);
        }
        
        .toast.warning {
            border-left: 4px solid var(--warning);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Hidden */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Background Animation -->
    <div class="bg-animation"></div>
    
    <!-- Particles -->
    <div class="particles" id="particles"></div>
    
    <!-- Main App Container -->
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">R</div>
                <h1>Arabic by Rolla</h1>
            </div>
            <div class="header-actions" id="headerActions">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
                    <span class="icon-sun">&#9728;</span>
                    <span class="icon-moon">&#9790;</span>
                </button>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main-container" id="mainContent">
            <!-- Content will be dynamically loaded here -->
        </main>
    </div>
    
    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Modal Title</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Modal content -->
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const TELEGRAM_BOT_TOKEN = '6759901283:AAGGfZvU2EX59mK6uefmHV69GJ-NKPbCdQ4';
        const TELEGRAM_CHAT_ID = ''; // Will be set when user enters it
        
        // ==================== STATE ====================
        let state = {
            currentView: 'dashboard',
            quizData: {
                fillBlank: [],
                relatedWords: [],
                matchWords: [],
                trueFalse: []
            },
            currentExam: null,
            examAnswers: {},
            studentName: '',
            chatId: localStorage.getItem('telegramChatId') || '',
            isLightTheme: localStorage.getItem('isLightTheme') === 'true'
        };
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            createParticles();
            
            // Apply saved theme
            if (state.isLightTheme) {
                document.body.classList.add('light-theme');
            }
            
            // Check URL for exam data
            const urlParams = new URLSearchParams(window.location.search);
            const examData = urlParams.get('exam');
            
            if (examData) {
                // Student view - taking an exam
                try {
                    const decoded = JSON.parse(atob(decodeURIComponent(examData)));
                    state.currentExam = decoded;
                    showStudentNameForm();
                } catch (e) {
                    showExamNotFound();
                }
            } else {
                // Teacher view - dashboard
                loadLocalData();
                renderDashboard();
            }
        });
        
        // ==================== THEME TOGGLE ====================
        function toggleTheme() {
            state.isLightTheme = !state.isLightTheme;
            document.body.classList.toggle('light-theme');
            localStorage.setItem('isLightTheme', state.isLightTheme);
        }
        
        // ==================== PARTICLES ====================
        function createParticles() {
            const container = document.getElementById('particles');
            const colors = ['#8b5cf6', '#f472b6', '#22d3ee', '#fbbf24', '#10b981'];
            
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.width = (5 + Math.random() * 10) + 'px';
                particle.style.height = particle.style.width;
                container.appendChild(particle);
            }
        }
        
        // ==================== LOCAL STORAGE ====================
        function loadLocalData() {
            const saved = localStorage.getItem('quizData');
            if (saved) {
                state.quizData = JSON.parse(saved);
            }
            state.chatId = localStorage.getItem('telegramChatId') || '';
        }
        
        function saveLocalData() {
            localStorage.setItem('quizData', JSON.stringify(state.quizData));
        }
        
        function saveChatId(chatId) {
            state.chatId = chatId;
            localStorage.setItem('telegramChatId', chatId);
        }
        
        // ==================== SUBMISSION TRACKING ====================
        function getSubmissionKey(examId) {
            return `submission_${examId}`;
        }
        
        function hasSubmitted(examId, studentName) {
            const submissions = JSON.parse(localStorage.getItem(getSubmissionKey(examId)) || '{}');
            return submissions[studentName.toLowerCase().trim()];
        }
        
        function markAsSubmitted(examId, studentName, score, total) {
            const submissions = JSON.parse(localStorage.getItem(getSubmissionKey(examId)) || '{}');
            submissions[studentName.toLowerCase().trim()] = {
                score: score,
                total: total,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem(getSubmissionKey(examId), JSON.stringify(submissions));
        }
        
        // ==================== ERROR VIEWS ====================
        function showExamNotFound() {
            document.getElementById('mainContent').innerHTML = `
                <div class="error-container fade-in">
                    <div class="error-icon">!</div>
                    <h2>Exam Not Found</h2>
                    <p>This exam link may have expired, been deleted, or is no longer available.</p>
                    <p style="margin-top: 1rem;">Please contact your teacher for a new link.</p>
                </div>
            `;
            document.getElementById('headerActions').innerHTML = `
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
                    <span class="icon-sun">&#9728;</span>
                    <span class="icon-moon">&#9790;</span>
                </button>
            `;
        }
        
        function showAlreadySubmitted(submission) {
            const percentage = Math.round((submission.score / submission.total) * 100);
            document.getElementById('mainContent').innerHTML = `
                <div class="already-submitted fade-in">
                    <div class="already-submitted-icon">&#10003;</div>
                    <h2>Exam Already Submitted</h2>
                    <p>You have already completed this exam.</p>
                    <div class="results-score" style="font-size: 3rem; margin: 1rem 0;">${percentage}%</div>
                    <p>Your Score: ${submission.score} / ${submission.total}</p>
                    <p style="color: var(--text-muted); margin-top: 1rem; font-size: 0.9rem;">
                        Submitted on: ${new Date(submission.timestamp).toLocaleString()}
                    </p>
                </div>
            `;
        }
        
        // ==================== STUDENT NAME FORM ====================
        function showStudentNameForm() {
            document.getElementById('headerActions').innerHTML = `
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
                    <span class="icon-sun">&#9728;</span>
                    <span class="icon-moon">&#9790;</span>
                </button>
            `;
            
            document.getElementById('mainContent').innerHTML = `
                <div class="student-form fade-in">
                    <h2>${state.currentExam.title || 'Exam'}</h2>
                    <p class="subtitle">Please enter your name to begin</p>
                    
                    <div class="warning-box">
                        <strong>Important:</strong> You can only submit this exam ONCE.<br>
                        Make sure to review all answers before submitting.
                    </div>
                    
                    <div class="info-box">
                        <strong>Tip:</strong> You can change your answers anytime before submitting by clicking on them.
                    </div>
                    
                    <div class="form-group">
                        <label for="studentName">Your Full Name</label>
                        <input type="text" id="studentName" placeholder="Enter your full name" autocomplete="name">
                    </div>
                    
                    <button class="btn btn-gradient" style="width: 100%; justify-content: center;" onclick="startExam()">
                        Start Exam
                    </button>
                </div>
            `;
            
            document.getElementById('studentName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') startExam();
            });
        }
        
        function startExam() {
            const nameInput = document.getElementById('studentName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showToast('Please enter your name', 'error');
                nameInput.focus();
                return;
            }
            
            // Check if already submitted
            const examId = state.currentExam.id;
            const previousSubmission = hasSubmitted(examId, name);
            
            if (previousSubmission) {
                showAlreadySubmitted(previousSubmission);
                return;
            }
            
            state.studentName = name;
            state.examAnswers = {};
            renderExam();
        }
        
        // ==================== DASHBOARD ====================
        function renderDashboard() {
            document.getElementById('headerActions').innerHTML = `
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
                    <span class="icon-sun">&#9728;</span>
                    <span class="icon-moon">&#9790;</span>
                </button>
                <button class="btn btn-secondary" onclick="showSettingsModal()">
                    Settings
                </button>
            `;
            
            const fillBlankCount = state.quizData.fillBlank.length;
            const relatedWordsCount = state.quizData.relatedWords.length;
            const matchWordsCount = state.quizData.matchWords.length;
            const trueFalseCount = state.quizData.trueFalse.length;
            
            document.getElementById('mainContent').innerHTML = `
                <div class="quiz-types-grid fade-in">
                    <div class="create-exam-card" onclick="showCreateExamModal()">
                        <h3>+ Create New Exam Link</h3>
                        <p>Combine questions into an exam and generate a shareable link</p>
                    </div>
                    
                    <div class="quiz-card" onclick="openQuizManager('fillBlank')">
                        <span class="quiz-badge ${fillBlankCount > 0 ? 'badge-ready' : 'badge-empty'}">
                            ${fillBlankCount} questions
                        </span>
                        <div class="quiz-card-icon fill-blank">&#9997;</div>
                        <h3>Fill in the Blank</h3>
                        <p>Create sentences with missing words for students to complete</p>
                    </div>
                    
                    <div class="quiz-card" onclick="openQuizManager('relatedWords')">
                        <span class="quiz-badge ${relatedWordsCount > 0 ? 'badge-ready' : 'badge-empty'}">
                            ${relatedWordsCount} questions
                        </span>
                        <div class="quiz-card-icon related-words">&#128444;</div>
                        <h3>Picture Match</h3>
                        <p>Match images with their corresponding words</p>
                    </div>
                    
                    <div class="quiz-card" onclick="openQuizManager('matchWords')">
                        <span class="quiz-badge ${matchWordsCount > 0 ? 'badge-ready' : 'badge-empty'}">
                            ${matchWordsCount} questions
                        </span>
                        <div class="quiz-card-icon match-words">&#128279;</div>
                        <h3>Match Words</h3>
                        <p>Connect related words or translations together</p>
                    </div>
                    
                    <div class="quiz-card" onclick="openQuizManager('trueFalse')">
                        <span class="quiz-badge ${trueFalseCount > 0 ? 'badge-ready' : 'badge-empty'}">
                            ${trueFalseCount} questions
                        </span>
                        <div class="quiz-card-icon true-false">&#10003; / &#10007;</div>
                        <h3>True or False</h3>
                        <p>Create statements for students to evaluate as true or false</p>
                    </div>
                </div>
            `;
        }
        
        // ==================== MODALS ====================
        function openModal(title, content, wide = false) {
            document.getElementById('modalTitle').innerHTML = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').className = wide ? 'modal wide' : 'modal';
            document.getElementById('modalOverlay').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }
        
        // ==================== SETTINGS ====================
        function showSettingsModal() {
            openModal('Settings', `
                <div class="form-group">
                    <label for="chatIdInput">Telegram Chat ID</label>
                    <input type="text" id="chatIdInput" value="${state.chatId}" placeholder="Enter your Telegram Chat ID">
                    <p class="form-hint">
                        To get your Chat ID: Message @userinfobot on Telegram
                    </p>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            `);
        }
        
        function saveSettings() {
            const chatId = document.getElementById('chatIdInput').value.trim();
            saveChatId(chatId);
            showToast('Settings saved!', 'success');
            closeModal();
        }
        
        // ==================== QUIZ MANAGER ====================
        function openQuizManager(type) {
            const titles = {
                fillBlank: 'Fill in the Blank',
                relatedWords: 'Picture Match',
                matchWords: 'Match Words',
                trueFalse: 'True or False'
            };
            
            const questions = state.quizData[type];
            
            let content = '';
            
            if (questions.length === 0) {
                content = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128218;</div>
                        <h3>No Questions Yet</h3>
                        <p>Add your first question to get started!</p>
                        <button class="btn btn-gradient" onclick="showAddQuestionForm('${type}')">
                            Add Question
                        </button>
                    </div>
                `;
            } else {
                content = `
                    <div class="quiz-list">
                        ${questions.map((q, i) => renderQuestionListItem(type, q, i)).join('')}
                    </div>
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button class="btn btn-gradient" onclick="showAddQuestionForm('${type}')">
                            + Add More Questions
                        </button>
                    </div>
                `;
            }
            
            openModal(titles[type], content, true);
        }
        
        function renderQuestionListItem(type, question, index) {
            let preview = '';
            
            switch(type) {
                case 'fillBlank':
                    preview = question.sentence.substring(0, 50) + (question.sentence.length > 50 ? '...' : '');
                    break;
                case 'relatedWords':
                    preview = `Image with ${question.correctWords.length} correct words`;
                    break;
                case 'matchWords':
                    preview = `${question.pairs.length} word pairs to match`;
                    break;
                case 'trueFalse':
                    preview = question.statement.substring(0, 50) + (question.statement.length > 50 ? '...' : '');
                    break;
            }
            
            return `
                <div class="quiz-list-item">
                    <div class="quiz-list-item-info">
                        <h4>Question ${index + 1}</h4>
                        <p>${preview}</p>
                    </div>
                    <div class="quiz-list-item-actions">
                        <button class="btn btn-secondary" onclick="editQuestion('${type}', ${index})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteQuestion('${type}', ${index})">Delete</button>
                    </div>
                </div>
            `;
        }
        
        function deleteQuestion(type, index) {
            if (confirm('Are you sure you want to delete this question?')) {
                state.quizData[type].splice(index, 1);
                saveLocalData();
                openQuizManager(type);
                showToast('Question deleted', 'success');
            }
        }
        
        // ==================== ADD/EDIT QUESTIONS ====================
        function showAddQuestionForm(type) {
            const forms = {
                fillBlank: getFillBlankForm(),
                relatedWords: getRelatedWordsForm(),
                matchWords: getMatchWordsForm(),
                trueFalse: getTrueFalseForm()
            };
            
            openModal('Add Question', forms[type], true);
        }
        
        function getFillBlankForm(existing = null) {
            const sentence = existing ? existing.sentence : '';
            const options = existing ? existing.options.join(', ') : '';
            const answer = existing ? existing.answer : '';
            
            return `
                <div class="form-group">
                    <label>Sentence (use ___ for blank)</label>
                    <textarea id="fillBlankSentence" placeholder="The cat ___ on the mat.">${sentence}</textarea>
                    <p class="form-hint">Use three underscores ___ where the blank should appear</p>
                </div>
                <div class="form-group">
                    <label>Answer Options (comma separated)</label>
                    <input type="text" id="fillBlankOptions" placeholder="sat, ran, jumped, slept" value="${options}">
                </div>
                <div class="form-group">
                    <label>Correct Answer</label>
                    <input type="text" id="fillBlankAnswer" placeholder="sat" value="${answer}">
                </div>
                <button class="btn btn-gradient" onclick="saveFillBlankQuestion(${existing ? 'true' : 'false'})">
                    ${existing ? 'Update' : 'Add'} Question
                </button>
            `;
        }
        
        function saveFillBlankQuestion(isEdit = false) {
            const sentence = document.getElementById('fillBlankSentence').value.trim();
            const options = document.getElementById('fillBlankOptions').value.split(',').map(o => o.trim()).filter(o => o);
            const answer = document.getElementById('fillBlankAnswer').value.trim();
            
            if (!sentence || !sentence.includes('___')) {
                showToast('Please include ___ in your sentence for the blank', 'error');
                return;
            }
            if (options.length < 2) {
                showToast('Please provide at least 2 options', 'error');
                return;
            }
            if (!answer) {
                showToast('Please provide the correct answer', 'error');
                return;
            }
            if (!options.includes(answer)) {
                options.push(answer);
            }
            
            const question = { sentence, options, answer };
            
            if (isEdit && state.editingIndex !== undefined) {
                state.quizData.fillBlank[state.editingIndex] = question;
            } else {
                state.quizData.fillBlank.push(question);
            }
            
            saveLocalData();
            showToast('Question saved!', 'success');
            openQuizManager('fillBlank');
        }
        
        function getRelatedWordsForm(existing = null) {
            const imageUrl = existing ? existing.imageUrl : '';
            const correctWords = existing ? existing.correctWords.join(', ') : '';
            const wrongWords = existing ? existing.wrongWords.join(', ') : '';
            
            return `
                <div class="form-group">
                    <label>Image URL</label>
                    <input type="url" id="relatedWordsImage" placeholder="https://example.com/image.jpg" value="${imageUrl}">
                    <p class="form-hint">Use a direct link to an image</p>
                </div>
                <div class="form-group">
                    <label>Correct Words (comma separated)</label>
                    <input type="text" id="relatedWordsCorrect" placeholder="cat, kitty, feline" value="${correctWords}">
                </div>
                <div class="form-group">
                    <label>Wrong Words (comma separated)</label>
                    <input type="text" id="relatedWordsWrong" placeholder="dog, bird, fish" value="${wrongWords}">
                </div>
                <button class="btn btn-gradient" onclick="saveRelatedWordsQuestion(${existing ? 'true' : 'false'})">
                    ${existing ? 'Update' : 'Add'} Question
                </button>
            `;
        }
        
        function saveRelatedWordsQuestion(isEdit = false) {
            const imageUrl = document.getElementById('relatedWordsImage').value.trim();
            const correctWords = document.getElementById('relatedWordsCorrect').value.split(',').map(w => w.trim()).filter(w => w);
            const wrongWords = document.getElementById('relatedWordsWrong').value.split(',').map(w => w.trim()).filter(w => w);
            
            if (!imageUrl) {
                showToast('Please provide an image URL', 'error');
                return;
            }
            if (correctWords.length === 0) {
                showToast('Please provide at least one correct word', 'error');
                return;
            }
            if (wrongWords.length === 0) {
                showToast('Please provide at least one wrong word', 'error');
                return;
            }
            
            const question = { imageUrl, correctWords, wrongWords };
            
            if (isEdit && state.editingIndex !== undefined) {
                state.quizData.relatedWords[state.editingIndex] = question;
            } else {
                state.quizData.relatedWords.push(question);
            }
            
            saveLocalData();
            showToast('Question saved!', 'success');
            openQuizManager('relatedWords');
        }
        
        function getMatchWordsForm(existing = null) {
            const pairs = existing ? existing.pairs : [{ left: '', right: '' }, { left: '', right: '' }];
            
            return `
                <div id="matchPairsContainer">
                    ${pairs.map((p, i) => `
                        <div class="question-builder" style="margin-top: ${i > 0 ? '1rem' : '0'}">
                            <span class="question-number">Pair ${i + 1}</span>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <input type="text" class="match-left" placeholder="Word/Phrase" value="${p.left}">
                                <input type="text" class="match-right" placeholder="Match/Translation" value="${p.right}">
                            </div>
                        </div>
                    `).join('')}
                </div>
                <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="addMatchPair()">
                    + Add Another Pair
                </button>
                <br><br>
                <button class="btn btn-gradient" onclick="saveMatchWordsQuestion(${existing ? 'true' : 'false'})">
                    ${existing ? 'Update' : 'Add'} Question
                </button>
            `;
        }
        
        function addMatchPair() {
            const container = document.getElementById('matchPairsContainer');
            const count = container.children.length;
            const div = document.createElement('div');
            div.className = 'question-builder';
            div.style.marginTop = '1rem';
            div.innerHTML = `
                <span class="question-number">Pair ${count + 1}</span>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <input type="text" class="match-left" placeholder="Word/Phrase">
                    <input type="text" class="match-right" placeholder="Match/Translation">
                </div>
            `;
            container.appendChild(div);
        }
        
        function saveMatchWordsQuestion(isEdit = false) {
            const lefts = document.querySelectorAll('.match-left');
            const rights = document.querySelectorAll('.match-right');
            const pairs = [];
            
            for (let i = 0; i < lefts.length; i++) {
                const left = lefts[i].value.trim();
                const right = rights[i].value.trim();
                if (left && right) {
                    pairs.push({ left, right });
                }
            }
            
            if (pairs.length < 2) {
                showToast('Please provide at least 2 word pairs', 'error');
                return;
            }
            
            const question = { pairs };
            
            if (isEdit && state.editingIndex !== undefined) {
                state.quizData.matchWords[state.editingIndex] = question;
            } else {
                state.quizData.matchWords.push(question);
            }
            
            saveLocalData();
            showToast('Question saved!', 'success');
            openQuizManager('matchWords');
        }
        
        function getTrueFalseForm(existing = null) {
            const statement = existing ? existing.statement : '';
            const isTrue = existing ? existing.isTrue : true;
            
            return `
                <div class="form-group">
                    <label>Statement</label>
                    <textarea id="tfStatement" placeholder="The sky is blue.">${statement}</textarea>
                </div>
                <div class="form-group">
                    <label>Correct Answer</label>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="tfAnswer" value="true" ${isTrue ? 'checked' : ''}>
                            True
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="tfAnswer" value="false" ${!isTrue ? 'checked' : ''}>
                            False
                        </label>
                    </div>
                </div>
                <button class="btn btn-gradient" onclick="saveTrueFalseQuestion(${existing ? 'true' : 'false'})">
                    ${existing ? 'Update' : 'Add'} Question
                </button>
            `;
        }
        
        function saveTrueFalseQuestion(isEdit = false) {
            const statement = document.getElementById('tfStatement').value.trim();
            const isTrue = document.querySelector('input[name="tfAnswer"]:checked').value === 'true';
            
            if (!statement) {
                showToast('Please provide a statement', 'error');
                return;
            }
            
            const question = { statement, isTrue };
            
            if (isEdit && state.editingIndex !== undefined) {
                state.quizData.trueFalse[state.editingIndex] = question;
            } else {
                state.quizData.trueFalse.push(question);
            }
            
            saveLocalData();
            showToast('Question saved!', 'success');
            openQuizManager('trueFalse');
        }
        
        function editQuestion(type, index) {
            state.editingIndex = index;
            const question = state.quizData[type][index];
            
            const forms = {
                fillBlank: getFillBlankForm(question),
                relatedWords: getRelatedWordsForm(question),
                matchWords: getMatchWordsForm(question),
                trueFalse: getTrueFalseForm(question)
            };
            
            openModal('Edit Question', forms[type], true);
        }
        
        // ==================== CREATE EXAM ====================
        function showCreateExamModal() {
            const hasQuestions = 
                state.quizData.fillBlank.length > 0 ||
                state.quizData.relatedWords.length > 0 ||
                state.quizData.matchWords.length > 0 ||
                state.quizData.trueFalse.length > 0;
            
            if (!hasQuestions) {
                openModal('Create Exam', `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#128218;</div>
                        <h3>No Questions Available</h3>
                        <p>Please add some questions first before creating an exam.</p>
                    </div>
                `);
                return;
            }
            
            openModal('Create New Exam', `
                <div class="form-group">
                    <label for="examTitle">Exam Title</label>
                    <input type="text" id="examTitle" placeholder="e.g., Arabic Vocabulary Quiz Week 3">
                </div>
                
                <h3 style="margin-bottom: 1rem;">Select Question Types to Include:</h3>
                
                <div class="exam-selector">
                    ${state.quizData.fillBlank.length > 0 ? `
                        <label class="exam-type-checkbox" onclick="this.classList.toggle('selected')">
                            <input type="checkbox" name="examTypes" value="fillBlank" checked>
                            <div class="icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);">
                                &#9997;
                            </div>
                            <div class="info">
                                <h4>Fill in the Blank</h4>
                                <p>${state.quizData.fillBlank.length} questions available</p>
                            </div>
                        </label>
                    ` : ''}
                    
                    ${state.quizData.relatedWords.length > 0 ? `
                        <label class="exam-type-checkbox" onclick="this.classList.toggle('selected')">
                            <input type="checkbox" name="examTypes" value="relatedWords" checked>
                            <div class="icon" style="background: linear-gradient(135deg, #f472b6 0%, #ec4899 100%);">
                                &#128444;
                            </div>
                            <div class="info">
                                <h4>Picture Match</h4>
                                <p>${state.quizData.relatedWords.length} questions available</p>
                            </div>
                        </label>
                    ` : ''}
                    
                    ${state.quizData.matchWords.length > 0 ? `
                        <label class="exam-type-checkbox" onclick="this.classList.toggle('selected')">
                            <input type="checkbox" name="examTypes" value="matchWords" checked>
                            <div class="icon" style="background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%);">
                                &#128279;
                            </div>
                            <div class="info">
                                <h4>Match Words</h4>
                                <p>${state.quizData.matchWords.length} questions available</p>
                            </div>
                        </label>
                    ` : ''}
                    
                    ${state.quizData.trueFalse.length > 0 ? `
                        <label class="exam-type-checkbox" onclick="this.classList.toggle('selected')">
                            <input type="checkbox" name="examTypes" value="trueFalse" checked>
                            <div class="icon" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%);">
                                &#10003;
                            </div>
                            <div class="info">
                                <h4>True or False</h4>
                                <p>${state.quizData.trueFalse.length} questions available</p>
                            </div>
                        </label>
                    ` : ''}
                </div>
                
                <button class="btn btn-gradient" style="width: 100%; justify-content: center; margin-top: 1rem;" onclick="generateExamLink()">
                    Generate Exam Link
                </button>
            `, true);
        }
        
        function generateExamLink() {
            const title = document.getElementById('examTitle').value.trim() || 'Untitled Exam';
            const selectedTypes = Array.from(document.querySelectorAll('input[name="examTypes"]:checked')).map(c => c.value);
            
            if (selectedTypes.length === 0) {
                showToast('Please select at least one question type', 'error');
                return;
            }
            
            // Build exam data
            const examData = {
                id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                title: title,
                createdAt: new Date().toISOString(),
                chatId: state.chatId,
                questions: []
            };
            
            // Add questions from selected types
            selectedTypes.forEach(type => {
                state.quizData[type].forEach((q, i) => {
                    examData.questions.push({
                        type: type,
                        index: i,
                        data: q
                    });
                });
            });
            
            // Encode and create link
            const encoded = encodeURIComponent(btoa(JSON.stringify(examData)));
            const baseUrl = window.location.origin + window.location.pathname;
            const examLink = `${baseUrl}?exam=${encoded}`;
            
            openModal('Exam Link Generated!', `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">&#127881;</div>
                    <h3>Your exam is ready!</h3>
                    <p style="color: var(--text-muted);">Share this link with your students</p>
                </div>
                
                <div class="link-display">
                    <input type="text" id="examLinkInput" value="${examLink}" readonly>
                    <button class="btn btn-primary" onclick="copyExamLink()">Copy</button>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border: 1px solid var(--success);">
                    <p style="color: var(--success); font-weight: 600;">
                        <strong>Note:</strong> Each student can only submit once! Results will be sent to your Telegram if you've set up your Chat ID in Settings.
                    </p>
                </div>
            `);
        }
        
        function copyExamLink() {
            const input = document.getElementById('examLinkInput');
            input.select();
            document.execCommand('copy');
            showToast('Link copied to clipboard!', 'success');
        }
        
        // ==================== RENDER EXAM (STUDENT VIEW) ====================
        function renderExam() {
            const exam = state.currentExam;
            let questionsHtml = '';
            let totalQuestions = exam.questions.length;
            
            exam.questions.forEach((q, index) => {
                questionsHtml += renderExamQuestion(q, index);
            });
            
            document.getElementById('mainContent').innerHTML = `
                <div class="quiz-play fade-in">
                    <div class="progress-container">
                        <div class="progress-header">
                            <span>Progress</span>
                            <span id="progressText">0 / ${totalQuestions} answered</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="info-box" style="margin-bottom: 1.5rem;">
                        <strong>Remember:</strong> Click on your answers to change them before submitting!
                    </div>
                    
                    <div id="questionsContainer">
                        ${questionsHtml}
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn btn-gradient" id="submitExamBtn" onclick="confirmSubmitExam()">
                            Submit Exam
                        </button>
                    </div>
                </div>
            `;
            
            // Initialize match questions
            exam.questions.forEach((q, index) => {
                if (q.type === 'matchWords') {
                    initMatchQuestion(index, q.data);
                }
            });
            
            updateProgress();
        }
        
        function renderExamQuestion(question, index) {
            switch(question.type) {
                case 'fillBlank':
                    return renderFillBlankQuestion(question.data, index);
                case 'relatedWords':
                    return renderRelatedWordsQuestion(question.data, index);
                case 'matchWords':
                    return renderMatchWordsQuestion(question.data, index);
                case 'trueFalse':
                    return renderTrueFalseQuestion(question.data, index);
                default:
                    return '';
            }
        }
        
        function renderFillBlankQuestion(data, index) {
            const sentenceHtml = data.sentence.replace('___', 
                `<span class="blank-space" id="blank_${index}" onclick="clearFillBlank(${index})">___</span>`
            );
            
            const shuffledOptions = [...data.options].sort(() => Math.random() - 0.5);
            
            return `
                <div class="quiz-question-card" id="question_${index}">
                    <div class="question-text">${sentenceHtml}</div>
                    <div class="options-grid" id="options_${index}">
                        ${shuffledOptions.map(opt => `
                            <button class="option-btn" onclick="selectFillBlankOption(${index}, '${opt.replace(/'/g, "\\'")}', this)">
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function selectFillBlankOption(index, option, btn) {
            // Clear previous selection
            const optionsContainer = document.getElementById(`options_${index}`);
            optionsContainer.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('selected', 'used');
                b.disabled = false;
            });
            
            // Mark this option as selected
            btn.classList.add('selected', 'used');
            
            // Fill the blank
            const blank = document.getElementById(`blank_${index}`);
            blank.textContent = option;
            blank.classList.add('filled');
            
            // Store answer
            state.examAnswers[index] = option;
            
            // Update card state
            document.getElementById(`question_${index}`).classList.add('answered');
            
            updateProgress();
        }
        
        function clearFillBlank(index) {
            const blank = document.getElementById(`blank_${index}`);
            if (!blank.classList.contains('filled')) return;
            
            blank.textContent = '___';
            blank.classList.remove('filled');
            
            // Clear option selection
            const optionsContainer = document.getElementById(`options_${index}`);
            optionsContainer.querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('selected', 'used');
                b.disabled = false;
            });
            
            // Remove answer
            delete state.examAnswers[index];
            
            // Update card state
            document.getElementById(`question_${index}`).classList.remove('answered');
            
            updateProgress();
        }
        
        function renderRelatedWordsQuestion(data, index) {
            const allWords = [...data.correctWords, ...data.wrongWords].sort(() => Math.random() - 0.5);
            
            return `
                <div class="quiz-question-card" id="question_${index}">
                    <div class="picture-container">
                        <img src="${data.imageUrl}" alt="Question image" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22200%22><rect fill=%22%23334155%22 width=%22300%22 height=%22200%22/><text fill=%22%2394a3b8%22 x=%22150%22 y=%22100%22 text-anchor=%22middle%22>Image not found</text></svg>'">
                    </div>
                    <p style="text-align: center; color: var(--text-muted); margin-bottom: 1rem;">
                        Select all words that match the image (click to select/deselect):
                    </p>
                    <div class="word-bank" id="wordbank_${index}">
                        ${allWords.map(word => `
                            <span class="word-chip" onclick="toggleRelatedWord(${index}, '${word.replace(/'/g, "\\'")}', this)">
                                ${word}
                            </span>
                        `).join('')}
                    </div>
                    <div class="drop-zone" id="dropzone_${index}">
                        <span style="color: var(--text-muted);">Selected words will appear here</span>
                    </div>
                </div>
            `;
        }
        
        function toggleRelatedWord(index, word, chip) {
            if (!state.examAnswers[index]) {
                state.examAnswers[index] = [];
            }
            
            const dropzone = document.getElementById(`dropzone_${index}`);
            const answers = state.examAnswers[index];
            const wordIndex = answers.indexOf(word);
            
            if (wordIndex > -1) {
                // Remove word
                answers.splice(wordIndex, 1);
                chip.classList.remove('used');
                
                // Remove from dropzone
                const placedWord = dropzone.querySelector(`[data-word="${word}"]`);
                if (placedWord) placedWord.remove();
            } else {
                // Add word
                answers.push(word);
                chip.classList.add('used');
                
                // Add to dropzone
                const span = document.createElement('span');
                span.className = 'placed-word';
                span.setAttribute('data-word', word);
                span.textContent = word;
                span.onclick = () => toggleRelatedWord(index, word, chip);
                dropzone.appendChild(span);
            }
            
            // Update dropzone state
            if (answers.length > 0) {
                dropzone.classList.add('has-items');
                const placeholder = dropzone.querySelector('span:not(.placed-word)');
                if (placeholder) placeholder.style.display = 'none';
            } else {
                dropzone.classList.remove('has-items');
                const placeholder = dropzone.querySelector('span:not(.placed-word)');
                if (placeholder) placeholder.style.display = '';
            }
            
            // Update card state
            if (answers.length > 0) {
                document.getElementById(`question_${index}`).classList.add('answered');
            } else {
                document.getElementById(`question_${index}`).classList.remove('answered');
            }
            
            updateProgress();
        }
        
        function renderMatchWordsQuestion(data, index) {
            const leftItems = data.pairs.map(p => p.left);
            const rightItems = [...data.pairs.map(p => p.right)].sort(() => Math.random() - 0.5);
            
            return `
                <div class="quiz-question-card" id="question_${index}">
                    <p style="text-align: center; color: var(--text-muted); margin-bottom: 1rem;">
                        Match the words by clicking one from each column. Click matched pairs to unmatch them.
                    </p>
                    <div class="match-container">
                        <div class="match-column">
                            <h4>Column A</h4>
                            ${leftItems.map((item, i) => `
                                <div class="match-item" id="left_${index}_${i}" data-value="${item}" data-side="left" data-index="${i}" onclick="selectMatchItem(${index}, 'left', ${i})">
                                    ${item}
                                </div>
                            `).join('')}
                        </div>
                        <div class="match-column">
                            <h4>Column B</h4>
                            ${rightItems.map((item, i) => `
                                <div class="match-item" id="right_${index}_${i}" data-value="${item}" data-side="right" data-index="${i}" onclick="selectMatchItem(${index}, 'right', ${i})">
                                    ${item}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        let matchSelections = {};
        
        function initMatchQuestion(index, data) {
            matchSelections[index] = {
                left: null,
                right: null,
                matches: [],
                matchCount: 0
            };
            state.examAnswers[index] = [];
        }
        
        function selectMatchItem(qIndex, side, itemIndex) {
            const selection = matchSelections[qIndex];
            const element = document.getElementById(`${side}_${qIndex}_${itemIndex}`);
            
            // If item is already matched, unmatch it
            if (element.classList.contains('matched')) {
                unmatchItem(qIndex, side, itemIndex);
                return;
            }
            
            // If item is disabled, ignore
            if (element.classList.contains('disabled')) return;
            
            // Clear previous selection on same side
            if (selection[side] !== null) {
                document.getElementById(`${side}_${qIndex}_${selection[side]}`).classList.remove('selected');
            }
            
            // Select this item
            selection[side] = itemIndex;
            element.classList.add('selected');
            
            // Check if we have both sides selected
            if (selection.left !== null && selection.right !== null) {
                makeMatch(qIndex);
            }
        }
        
        function makeMatch(qIndex) {
            const selection = matchSelections[qIndex];
            const leftEl = document.getElementById(`left_${qIndex}_${selection.left}`);
            const rightEl = document.getElementById(`right_${qIndex}_${selection.right}`);
            
            const leftValue = leftEl.getAttribute('data-value');
            const rightValue = rightEl.getAttribute('data-value');
            
            // Remove selection styling
            leftEl.classList.remove('selected');
            rightEl.classList.remove('selected');
            
            // Add matched styling
            leftEl.classList.add('matched');
            rightEl.classList.add('matched');
            
            // Add match number
            selection.matchCount++;
            const matchNum = selection.matchCount;
            
            leftEl.innerHTML = `${leftValue}<span class="match-number">${matchNum}</span>`;
            rightEl.innerHTML = `${rightValue}<span class="match-number">${matchNum}</span>`;
            
            // Store the match
            selection.matches.push({
                leftIndex: selection.left,
                rightIndex: selection.right,
                left: leftValue,
                right: rightValue,
                matchNum: matchNum
            });
            
            // Update answer
            state.examAnswers[qIndex] = selection.matches.map(m => ({ left: m.left, right: m.right }));
            
            // Clear selections
            selection.left = null;
            selection.right = null;
            
            // Update card state
            if (selection.matches.length > 0) {
                document.getElementById(`question_${qIndex}`).classList.add('answered');
            }
            
            updateProgress();
        }
        
        function unmatchItem(qIndex, side, itemIndex) {
            const selection = matchSelections[qIndex];
            const element = document.getElementById(`${side}_${qIndex}_${itemIndex}`);
            const value = element.getAttribute('data-value');
            
            // Find the match containing this item
            const matchIndex = selection.matches.findIndex(m => 
                (side === 'left' && m.leftIndex === itemIndex) || 
                (side === 'right' && m.rightIndex === itemIndex)
            );
            
            if (matchIndex === -1) return;
            
            const match = selection.matches[matchIndex];
            
            // Get both elements
            const leftEl = document.getElementById(`left_${qIndex}_${match.leftIndex}`);
            const rightEl = document.getElementById(`right_${qIndex}_${match.rightIndex}`);
            
            // Remove matched styling
            leftEl.classList.remove('matched');
            rightEl.classList.remove('matched');
            
            // Restore original text
            leftEl.innerHTML = match.left;
            rightEl.innerHTML = match.right;
            
            // Remove from matches array
            selection.matches.splice(matchIndex, 1);
            
            // Update answer
            state.examAnswers[qIndex] = selection.matches.map(m => ({ left: m.left, right: m.right }));
            
            // Update card state
            if (selection.matches.length === 0) {
                document.getElementById(`question_${qIndex}`).classList.remove('answered');
            }
            
            updateProgress();
        }
        
        function renderTrueFalseQuestion(data, index) {
            return `
                <div class="quiz-question-card" id="question_${index}">
                    <div class="question-text">${data.statement}</div>
                    <div class="tf-options">
                        <button class="tf-btn true-btn" onclick="selectTrueFalse(${index}, true, this)">
                            &#10003; True
                        </button>
                        <button class="tf-btn false-btn" onclick="selectTrueFalse(${index}, false, this)">
                            &#10007; False
                        </button>
                    </div>
                </div>
            `;
        }
        
        function selectTrueFalse(index, value, btn) {
            const card = document.getElementById(`question_${index}`);
            const buttons = card.querySelectorAll('.tf-btn');
            
            // Toggle behavior - if clicking the same button, deselect it
            if (btn.classList.contains('selected')) {
                btn.classList.remove('selected');
                delete state.examAnswers[index];
                card.classList.remove('answered');
            } else {
                // Clear previous selection
                buttons.forEach(b => b.classList.remove('selected'));
                
                // Select this option
                btn.classList.add('selected');
                
                // Store answer
                state.examAnswers[index] = value;
                
                // Update card state
                card.classList.add('answered');
            }
            
            updateProgress();
        }
        
        function updateProgress() {
            const exam = state.currentExam;
            const total = exam.questions.length;
            const answered = Object.keys(state.examAnswers).filter(k => {
                const ans = state.examAnswers[k];
                if (Array.isArray(ans)) return ans.length > 0;
                return ans !== undefined && ans !== null;
            }).length;
            
            const percentage = Math.round((answered / total) * 100);
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${answered} / ${total} answered`;
        }
        
        // ==================== SUBMIT EXAM ====================
        function confirmSubmitExam() {
            const exam = state.currentExam;
            const total = exam.questions.length;
            const answered = Object.keys(state.examAnswers).filter(k => {
                const ans = state.examAnswers[k];
                if (Array.isArray(ans)) return ans.length > 0;
                return ans !== undefined && ans !== null;
            }).length;
            
            if (answered < total) {
                if (!confirm(`You have only answered ${answered} out of ${total} questions. Unanswered questions will be marked as wrong.\n\nAre you sure you want to submit?`)) {
                    return;
                }
            }
            
            if (!confirm('WARNING: You can only submit this exam ONCE!\n\nAfter submitting, you cannot retake this exam or change your answers.\n\nAre you sure you want to submit now?')) {
                return;
            }
            
            submitExam();
        }
        
        function submitExam() {
            const exam = state.currentExam;
            const results = calculateResults();
            
            // Mark as submitted
            markAsSubmitted(exam.id, state.studentName, results.correct, results.total);
            
            // Show results
            showResults(results);
            
            // Send to Telegram
            sendResultsToTelegram(results);
        }
        
        function calculateResults() {
            const exam = state.currentExam;
            let correct = 0;
            let total = exam.questions.length;
            const details = [];
            
            exam.questions.forEach((q, index) => {
                const answer = state.examAnswers[index];
                let isCorrect = false;
                let detail = { type: q.type, question: '', studentAnswer: '', correctAnswer: '', isCorrect: false };
                
                switch(q.type) {
                    case 'fillBlank':
                        detail.question = q.data.sentence;
                        detail.correctAnswer = q.data.answer;
                        detail.studentAnswer = answer || '(no answer)';
                        isCorrect = answer === q.data.answer;
                        break;
                        
                    case 'relatedWords':
                        detail.question = 'Picture match';
                        detail.correctAnswer = q.data.correctWords.join(', ');
                        detail.studentAnswer = (answer || []).join(', ') || '(no answer)';
                        if (answer && answer.length > 0) {
                            const correctSelected = answer.filter(w => q.data.correctWords.includes(w));
                            const wrongSelected = answer.filter(w => q.data.wrongWords.includes(w));
                            isCorrect = correctSelected.length === q.data.correctWords.length && wrongSelected.length === 0;
                        }
                        break;
                        
                    case 'matchWords':
                        detail.question = 'Match words';
                        detail.correctAnswer = q.data.pairs.map(p => `${p.left} = ${p.right}`).join(', ');
                        if (answer && answer.length > 0) {
                            detail.studentAnswer = answer.map(a => `${a.left} = ${a.right}`).join(', ');
                            let matchedCorrectly = 0;
                            answer.forEach(ans => {
                                const correctPair = q.data.pairs.find(p => p.left === ans.left);
                                if (correctPair && correctPair.right === ans.right) {
                                    matchedCorrectly++;
                                }
                            });
                            isCorrect = matchedCorrectly === q.data.pairs.length && answer.length === q.data.pairs.length;
                        } else {
                            detail.studentAnswer = '(no answer)';
                        }
                        break;
                        
                    case 'trueFalse':
                        detail.question = q.data.statement;
                        detail.correctAnswer = q.data.isTrue ? 'True' : 'False';
                        detail.studentAnswer = answer === true ? 'True' : answer === false ? 'False' : '(no answer)';
                        isCorrect = answer === q.data.isTrue;
                        break;
                }
                
                detail.isCorrect = isCorrect;
                if (isCorrect) correct++;
                details.push(detail);
            });
            
            return { correct, total, details, percentage: Math.round((correct / total) * 100) };
        }
        
        function showResults(results) {
            const percentage = results.percentage;
            let message = '';
            let emoji = '';
            
            if (percentage >= 90) {
                message = 'Excellent Work!';
                emoji = '&#127942;';
                createConfetti();
            } else if (percentage >= 70) {
                message = 'Good Job!';
                emoji = '&#127881;';
            } else if (percentage >= 50) {
                message = 'Keep Practicing!';
                emoji = '&#128170;';
            } else {
                message = 'Don\'t Give Up!';
                emoji = '&#128522;';
            }
            
            let detailsHtml = results.details.map((d, i) => `
                <div class="quiz-question-card ${d.isCorrect ? 'correct' : 'incorrect'}">
                    <p><strong>Question ${i + 1}:</strong> ${d.question.substring(0, 100)}${d.question.length > 100 ? '...' : ''}</p>
                    <p>Your answer: <strong>${d.studentAnswer}</strong></p>
                    ${!d.isCorrect ? `<p style="color: var(--success);">Correct answer: <strong>${d.correctAnswer}</strong></p>` : ''}
                </div>
            `).join('');
            
            document.getElementById('mainContent').innerHTML = `
                <div class="results-container fade-in">
                    <div style="font-size: 5rem;">${emoji}</div>
                    <div class="results-score">${percentage}%</div>
                    <p class="results-message">${message}</p>
                    
                    <div class="results-breakdown">
                        <div class="result-stat correct">
                            <div class="number">${results.correct}</div>
                            <div class="label">Correct</div>
                        </div>
                        <div class="result-stat wrong">
                            <div class="number">${results.total - results.correct}</div>
                            <div class="label">Wrong</div>
                        </div>
                        <div class="result-stat">
                            <div class="number">${results.total}</div>
                            <div class="label">Total</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 1rem;">Review Your Answers:</h3>
                    ${detailsHtml}
                </div>
            `;
        }
        
        // ==================== TELEGRAM ====================
        async function sendResultsToTelegram(results) {
            const chatId = state.currentExam.chatId;
            
            if (!chatId) {
                console.log('No Telegram chat ID configured');
                return;
            }
            
            const percentage = results.percentage;
            let gradeEmoji = '';
            if (percentage >= 90) gradeEmoji = '';
            else if (percentage >= 70) gradeEmoji = '';
            else if (percentage >= 50) gradeEmoji = '';
            else gradeEmoji = '';
            
            let message = ` *EXAM SUBMISSION*\n`;
            message += `\n`;
            message += ` *Student:* ${state.studentName}\n`;
            message += ` *Exam:* ${state.currentExam.title}\n`;
            message += `\n\n`;
            message += `${gradeEmoji} *GRADE: ${percentage}%*\n`;
            message += ` *Score: ${results.correct} / ${results.total}*\n\n`;
            message += `\n`;
            message += ` *DETAILED ANSWERS:*\n`;
            message += `\n\n`;
            
            results.details.forEach((d, i) => {
                const mark = d.isCorrect ? '' : '';
                message += `*Q${i + 1}:* ${mark}\n`;
                message += `Answer: ${d.studentAnswer}\n`;
                if (!d.isCorrect) {
                    message += `Correct: ${d.correctAnswer}\n`;
                }
                message += `\n`;
            });
            
            message += `\n`;
            message += ` Submitted: ${new Date().toLocaleString()}`;
            
            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
                
                if (!response.ok) {
                    console.error('Failed to send Telegram message');
                }
            } catch (error) {
                console.error('Telegram send error:', error);
            }
        }
        
        // ==================== CONFETTI ====================
        function createConfetti() {
            const colors = ['#8b5cf6', '#f472b6', '#22d3ee', '#fbbf24', '#10b981', '#ef4444'];
            
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.width = (5 + Math.random() * 10) + 'px';
                    confetti.style.height = confetti.style.width;
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }
        
        // ==================== TOAST NOTIFICATIONS ====================
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span style="font-size: 1.2rem;">${type === 'success' ? '&#10003;' : type === 'error' ? '&#10007;' : '&#9888;'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
